<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Phone.System ‚Äî Dashboard</title>
  <style>
    :root{
      --bg:#f8f9fa;
      --bg2:#ffffff;
      --card:#ffffff;
      --card2:#f1f3f5;
      --border:rgba(0,0,0,.12);
      --text:rgba(0,0,0,.87);
      --muted:rgba(0,0,0,.60);
      --muted2:rgba(0,0,0,.45);
      --primary:#10b981;
      --accent:#10b981;
      --accent2:#059669;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --shadow:0 2px 8px rgba(0,0,0,.08);
      --shadow-sm:0 1px 4px rgba(0,0,0,.06);
      --radius:12px;
      --radius2:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;
      background: var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }

    #appRoot{display:flex;flex-direction:column;flex:1;min-height:0;}

    /* Make the platform dashboard ~10% smaller overall. */
    @supports (zoom: 1) {
      #appRoot{zoom:90%;}
    }
    @supports not (zoom: 1) {
      #appRoot{transform:scale(0.9);transform-origin:top left;width:calc(100% / 0.9);}
    }

    a{color:var(--accent);text-decoration:none}
    a:hover{color:var(--text);text-decoration:underline;text-underline-offset:3px}

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 16px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-bottom:1px solid rgba(59,130,246,.3);
      box-shadow: 0 2px 8px rgba(37,99,235,.2);
      color: #ffffff;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
      color: #ffffff;
      text-decoration:none;
      white-space:nowrap;
    }
    .brand__mark{
      width:34px;
      height:34px;
      border-radius:10px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 2px 8px rgba(16,185,129,.20);
      display:inline-block;
      flex:none;
    }
    .brand__text{display:flex;flex-direction:column;line-height:1.08}
    .brand__text small{font-weight:700;color:rgba(255,255,255,.75);font-size:11px;letter-spacing:.1px}

    .header-right{display:flex;align-items:center;gap:12px;font-size:14px;flex-wrap:wrap;color:#ffffff}
    .header-balance{font-size:14px;color:rgba(255,255,255,.9)}
    #noticeable-widget{display:flex;align-items:center}

    .wrap{display:flex;flex:1;min-height:0}

    aside{
      width:216px;
      border-right:1px solid rgba(0,0,0,.12);
      background: #f8f9fa;
    }
    aside a{
      display:flex;
      align-items:center;
      gap:9px;
      padding:12.6px 14.4px;
      color:var(--muted);
      text-decoration:none;
      border-bottom:1px solid rgba(0,0,0,.08);
      transition: background .15s ease, color .15s ease, transform .15s ease;
    }
    aside a:hover{background: rgba(0,0,0,.04);color:var(--text);text-decoration:none}
    aside a.active{
      background: rgba(16,185,129,.12);
      border-left:3px solid #10b981;
      color:#10b981;
      font-weight:600;
    }
    .nav-icon{
      width:16.2px;
      height:16.2px;
      flex:0 0 auto;
      opacity:.65;
    }
    aside a.active .nav-icon{opacity:1}

    .sidebar-user{
      padding:10.8px 14.4px;
      color:var(--muted2);
      font-size:10.8px;
      border-top:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.02);
    }
    .sidebar-user strong{color:var(--text)}

    main{flex:1;overflow:auto;padding:16px;min-width:0}
    main > section{
      background: #ffffff;
      border:1px solid rgba(0,0,0,.12);
      border-radius: var(--radius2);
      box-shadow: var(--shadow-sm);
      padding:14px 14px;
      margin-bottom:16px;
      overflow-x:auto;
    }

    h2{margin:6px 0 12px 0;font-size:20px;letter-spacing:-.01em}
    h3{color:var(--text)}

    table{width:100%;border-collapse:collapse;background:#ffffff;border:1px solid rgba(0,0,0,.12)}
    th,td{border-bottom:1px solid rgba(0,0,0,.08);padding:9px 8px;text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-size:12px;letter-spacing:.5px;text-transform:uppercase;background:#f8f9fa}
    tbody tr:hover td{background: rgba(0,0,0,.02)}

    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    label{color:var(--text)}

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="date"],
    input[type="tel"],
    input[type="url"],
    input[type="search"],
    input[type="file"],
    select,
    textarea{
      border:1px solid rgba(0,0,0,.20);
      background: #ffffff;
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      outline:none;
    }
    input[type="file"]{padding:8px 10px}

    input[type="text"]::placeholder,
    input[type="email"]::placeholder,
    input[type="password"]::placeholder,
    input[type="number"]::placeholder,
    input[type="tel"]::placeholder,
    input[type="url"]::placeholder,
    input[type="search"]::placeholder,
    textarea::placeholder{color:var(--muted2)}

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    input[type="tel"]:focus,
    input[type="url"]:focus,
    input[type="search"]:focus,
    input[type="file"]:focus,
    select:focus,
    textarea:focus{border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,.15)}

    input[type="checkbox"],
    input[type="radio"]{accent-color: #10b981}

    select option{color:var(--text)}

    .cid-input{max-width:140px}

    button{
      background: #ffffff;
      color:var(--text);
      border:1px solid rgba(0,0,0,.20);
      border-radius:12px;
      padding:9px 12px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{background: #f8f9fa;border-color:rgba(0,0,0,.30)}
    button:active{transform: translateY(1px)}
    button.btn-clicked{animation:btnClick 0.3s ease}
    button[disabled]{opacity:.5;cursor:not-allowed}

    /* Branded button variants */
    button.btn--primary{
      background: #10b981;
      color:#ffffff;
      border-color: #10b981;
      font-weight:900;
    }
    button.btn--primary:hover{border-color: #059669; background: #059669}

    button.btn--muted{
      background: #f1f3f5;
      color: var(--text);
      border-color: rgba(0,0,0,.15);
    }

    button.btn--success{
      background: rgba(16,185,129,.16);
      border-color: rgba(16,185,129,.40);
      color: #059669;
      font-weight:800;
    }

    button.btn--warning{
      background: rgba(245,158,11,.18);
      border-color: rgba(245,158,11,.40);
      color: #b45309;
      font-weight:800;
    }

    button.btn--danger{
      background: rgba(239,68,68,.18);
      border-color: rgba(239,68,68,.42);
      color: #dc2626;
      font-weight:800;
    }

    .icon-btn{background:transparent;color:var(--muted);border-radius:999px;padding:2px 8px;font-size:11px;border:1px solid transparent;cursor:pointer}
    .icon-btn:hover{background:rgba(0,0,0,.06);color:var(--text);border-color:rgba(0,0,0,.12)}

    .muted{color:var(--muted);font-size:12px}

    code{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#f1f3f5;border:1px solid rgba(0,0,0,.12);border-radius:8px;padding:2px 6px;color:var(--text)}
    pre{background:#f1f3f5;color:var(--text);padding:10px;border-radius:12px;overflow:auto;border:1px solid rgba(0,0,0,.12)}

    .balance-value{font-size:18px;font-weight:800;color:rgba(16,185,129,.95)}

    .toast{position:fixed;top:20px;right:20px;background:rgba(16,185,129,.92);color:#071024;padding:12px 20px;border-radius:12px;border:1px solid rgba(16,185,129,.35);box-shadow:0 18px 60px rgba(0,0,0,.55);z-index:2147483647;animation:slideIn 0.3s ease-out}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes btnClick{0%{transform:scale(1)}50%{transform:scale(0.98)}100%{transform:scale(1)}}

    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:8px 0 16px 0}
    .kpi-card{background:#ffffff;border-radius:16px;padding:10px 12px;border:1px solid rgba(0,0,0,.12);box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .kpi-change-negative{color:#ef4444;font-size:12px;font-weight:700}
    .kpi-change-positive{color:#10b981;font-size:12px;font-weight:700}
    .kpi-label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .kpi-value{font-size:20px;font-weight:900;color:var(--text)}
    .kpi-sub{font-size:11px;color:var(--muted2);min-height:14px}
    /* Dialer */
    #dialer-campaigns-table{table-layout:fixed}
    #dialer-campaigns-table th:nth-child(1){width:22%}
    #dialer-campaigns-table th:nth-child(2){width:16%}
    #dialer-campaigns-table th:nth-child(3){width:14%}
    #dialer-campaigns-table th:nth-child(4){width:16%}
    #dialer-campaigns-table th:nth-child(5){width:12%}
    #dialer-campaigns-table th:nth-child(6){width:10%}
    #dialer-campaigns-table th:nth-child(7){width:12%}
    .dialer-status-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      text-transform:capitalize;
      border:1px solid rgba(0,0,0,.12);
      background:rgba(0,0,0,.04);
      color:var(--text);
    }
    .dialer-status-running{border-color:rgba(16,185,129,.45);background:rgba(16,185,129,.12);color:#059669}
    .dialer-status-paused{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12);color:#b45309}
    .dialer-status-draft{border-color:rgba(0,0,0,.15);color:var(--muted)}
    .dialer-status-completed{border-color:rgba(59,130,246,.35);background:rgba(59,130,246,.10);color:#1d4ed8}
    .dialer-chip-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .dialer-chip{
      background:rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.12);
      border-radius:10px;
      padding:3px 7px;
      font-size:11px;
      color:var(--muted);
      display:inline-flex;
      gap:4px;
      align-items:center;
      transition:all .15s ease;
    }
    .dialer-chip[data-leads-status]{
      cursor:pointer;
    }
    .dialer-chip[data-leads-status]:hover{
      background:rgba(16,185,129,.12);
      border-color:rgba(16,185,129,.45);
      color:var(--text);
    }
    .dialer-chip-hint{
      font-size:10px;
      color:var(--muted2);
      margin-top:4px;
    }
    .dialer-chip strong{font-weight:900;color:var(--text)}
    .dialer-actions{display:flex;flex-wrap:wrap;gap:6px}
    .dialer-actions button{font-size:11px;padding:6px 10px;border-radius:10px}
    #dialerStatus{font-size:12px;margin-left:auto}
    #callsChartContainer{margin-top:8px;margin-bottom:16px;background:#ffffff;border-radius:16px;border:1px solid rgba(0,0,0,.12);padding:12px}
    #callsChart{width:100%;max-height:220px}

    /* Pie charts grid */
    .pie-charts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
      margin-bottom:16px;
    }
    .pie-chart-card{
      background:#ffffff;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      padding:14px;
      text-align:center;
    }
    .pie-chart-title{
      font-size:13px;
      font-weight:700;
      color:var(--text);
      margin-bottom:10px;
    }
    .pie-chart-card canvas{
      max-height:180px;
    }

    /* AI Agent modal (compact) */
    #aiAgentModal .ai-agent-modal-card{font-size:12px}
    #aiAgentModal .ai-agent-modal-card label{font-size:12px !important}
    #aiAgentModal .ai-agent-modal-card .muted{font-size:11px}
    #aiAgentModal .ai-agent-modal-card input,
    #aiAgentModal .ai-agent-modal-card select,
    #aiAgentModal .ai-agent-modal-card textarea{padding:7px 9px;border-radius:10px;font-size:12px}
    #aiAgentModal .ai-agent-modal-card button{padding:7px 10px;border-radius:10px;font-size:12px}

    /* AI subtabs */
    .ai-subtabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px 0}
    .ai-subtab{
      background: #ffffff !important;
      color: var(--muted) !important;
      border:1px solid rgba(0,0,0,.20) !important;
      border-radius:999px !important;
      padding:6px 10px !important;
      font-size:12px !important;
    }
    .ai-subtab:hover{background: #f8f9fa !important;color:var(--text) !important}
    .ai-subtab.active{
      background: #10b981 !important;
      color:#ffffff !important;
      border-color: #10b981 !important;
    }

    /* AI Tools grid - app connections style */
    .ai-tools-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:16px;
    }
    .ai-tool-card{
      background:#ffffff;
      border:1px solid rgba(0,0,0,.12);
      border-radius:16px;
      padding:18px;
      cursor:pointer;
      transition:all .2s ease;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .ai-tool-card:hover{
      background:#f8f9fa;
      border-color:rgba(0,0,0,.20);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.12);
    }
    .ai-tool-card-icon{
      font-size:32px;
      line-height:1;
    }
    .ai-tool-card-content{
      flex:1;
    }
    .ai-tool-card-title{
      font-size:15px;
      font-weight:800;
      color:var(--text);
      margin-bottom:6px;
    }
    .ai-tool-card-desc{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .ai-tool-card-status{
      margin-top:auto;
    }
    .ai-tool-status-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
    }
    .ai-tool-status-configured{
      background:rgba(16,185,129,.12);
      border:1px solid rgba(16,185,129,.40);
      color:#059669;
    }
    .ai-tool-status-unconfigured{
      background:rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.12);
      color:var(--muted);
    }

    /* AI Tool Config Modal */
    .ai-tool-modal{
      display:none;
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.50);
      z-index:9998;
      align-items:center;
      justify-content:center;
    }
    .ai-tool-modal-card{
      background:#ffffff;
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      padding:20px;
      width:440px;
      max-width:94%;
      max-height:92vh;
      overflow:auto;
      box-shadow:0 8px 32px rgba(0,0,0,.15);
      color:var(--text);
    }
    .ai-tool-modal-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .ai-tool-modal-icon{
      font-size:28px;
    }
    .ai-tool-modal-title{
      font-size:18px;
      font-weight:800;
      flex:1;
    }
    .ai-tool-modal-close{
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:20px;
      cursor:pointer;
      padding:4px 8px;
      border-radius:8px;
      transition:all .15s ease;
    }
    .ai-tool-modal-close:hover{
      background:rgba(0,0,0,.06);
      color:var(--text);
    }
    .ai-tool-modal-body{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .ai-tool-modal-body label{
      display:block;
      font-size:12px;
      font-weight:600;
      color:var(--text);
      margin-bottom:4px;
    }
    .ai-tool-modal-body input,
    .ai-tool-modal-body select,
    .ai-tool-modal-body textarea{
      width:100%;
      box-sizing:border-box;
    }
    .ai-tool-modal-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .ai-tool-modal-footer{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid rgba(0,0,0,.12);
    }

    /* AI Tools pane: avoid toolbar content overflowing into adjacent cards */
    #ai-pane-tools .toolbar{flex-wrap:wrap}
    #ai-pane-tools .toolbar > *{min-width:0;max-width:100%}

    /* Allow inputs inside CSS grid/flex to shrink instead of overflowing (prevents overlap) */
    .ai-tool-modal input[type="text"],
    .ai-tool-modal input[type="number"],
    .ai-tool-modal input[type="password"],
    .ai-tool-modal input[type="email"],
    .ai-tool-modal input[type="url"],
    .ai-tool-modal input[type="file"],
    .ai-tool-modal select,
    .ai-tool-modal textarea{
      min-width:0;
      max-width:100%;
      box-sizing:border-box;
    }
    .ai-tool-modal input[type="file"]{width:100%}

    /* Document templates table: prevent content from overflowing the card */
    #ai-doc-templates-table{table-layout:fixed}
    #ai-doc-templates-table th,
    #ai-doc-templates-table td{overflow-wrap:anywhere}
    #ai-doc-templates-table th:last-child,
    #ai-doc-templates-table td:last-child{white-space:nowrap;padding-right:12px;width:96px}

    /* AI Agents: keep action buttons inside the table/card */
    #ai-agents-table{table-layout:fixed}
    #ai-agents-table th:last-child,
    #ai-agents-table td:last-child{width:140px;padding-right:12px}
    #ai-agents-table th:nth-child(4),
    #ai-agents-table td:nth-child(4){
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    #ai-agents-table td:last-child button{display:block;width:100%;max-width:100%;margin:0 0 8px 0}
    #ai-agents-table td:last-child button:last-child{margin-bottom:0}

    /* AI Numbers: don't let the assignment dropdown force horizontal overflow */
    #ai-numbers-table{table-layout:fixed}
    #ai-numbers-table td:nth-child(2) select{width:100% !important;min-width:0;max-width:100%}

    /* Buy AI Number modal */
    #ai-buy-results-table{table-layout:fixed}
    #ai-buy-results-table th:last-child,
    #ai-buy-results-table td:last-child{width:110px;white-space:nowrap}
    #ai-buy-results-table th:nth-child(2),
    #ai-buy-results-table td:nth-child(2){width:38%;overflow-wrap:anywhere}

    /* Make the white inline cards
    #view-ai div[style*="background:#ffffff"],
    #view-ai div[style*="background:#fff"]{
      background: #ffffff !important;
      border:1px solid rgba(0,0,0,.12) !important;
      box-shadow: 0 1px 3px rgba(0,0,0,.08) !important;
      overflow:hidden;
    }
    #view-ai div[style*="border:1px solid #e5e7eb"]{border-color:rgba(0,0,0,.12) !important}
    #aiConvMessages,
    #aiOutboundConvMessages{
      background: #f8f9fa !important;
      border-color: rgba(0,0,0,.12) !important;
      color: var(--text) !important;
    }

    /* AI Conversation message cards */
    .ai-chat-card{
      margin:0 0 10px 0;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }
    .ai-chat-card--user{
      background: rgba(16,185,129,.08);
      border-color: rgba(16,185,129,.25);
    }
    .ai-chat-meta{
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    .ai-chat-body{
      white-space:pre-wrap;
      font-size:13px;
      color: var(--text);
      line-height:1.6;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    /* Modals */
    #addFundModal,
    #trunkModal,
    #dialerCreateModal,
    #dialerUploadModal,
    #aiEmailPreviewModal,
    #aiAgentModal,
    #aiTemplateModal,
    .ai-tool-modal{
      /* Keep the dimmed overlay so the page behind is still visible. */
      background: rgba(0,0,0,.50) !important;
    }

    #addFundModal > div,
    #trunkModal > div,
    #dialerCreateModal > div,
    #dialerUploadModal > div,
    #aiEmailPreviewModal > div,
    #aiAgentModal .ai-agent-modal-card,
    #aiTemplateModal .ai-agent-modal-card,
    .ai-tool-modal-card{
      /* Solid modal cards (no transparency / no see-through). */
      background: #ffffff !important;
      border:1px solid rgba(0,0,0,.12) !important;
      box-shadow: 0 8px 32px rgba(0,0,0,.15) !important;
      color: var(--text) !important;
    }
    #addFundModal [style*="color:#4b5563"],
    #addFundModal [style*="color:#6b7280"],
    #trunkModal [style*="color:#4b5563"],
    #trunkModal [style*="color:#6b7280"],
    #dialerCreateModal [style*="color:#4b5563"],
    #dialerCreateModal [style*="color:#6b7280"],
    #dialerUploadModal [style*="color:#4b5563"],
    #dialerUploadModal [style*="color:#6b7280"],
    #aiEmailPreviewModal [style*="color:#4b5563"],
    #aiEmailPreviewModal [style*="color:#6b7280"],
    #aiAgentModal [style*="color:#4b5563"],
    #aiAgentModal [style*="color:#6b7280"],
    #aiTemplateModal [style*="color:#4b5563"],
    #aiTemplateModal [style*="color:#6b7280"],
    .ai-tool-modal [style*="color:#4b5563"],
    .ai-tool-modal [style*="color:#6b7280"]{
      color: var(--muted) !important;
    }

    /* Mobile optimizations */
    @media (max-width: 1024px) {
      /* Disable zoom scaling on tablets/mobile */
      #appRoot{zoom:100% !important;transform:none !important;width:100% !important;}
    }

    @media (max-width: 768px) {
      /* Layout adjustments */
      .wrap{flex-direction:column;min-height:0;}
      aside{
        width:100%;
        display:flex;
        overflow-x:auto;
        border-right:none;
        border-bottom:1px solid rgba(0,0,0,.10);
        -webkit-overflow-scrolling:touch;
        scrollbar-width:none;
      }
      aside::-webkit-scrollbar{display:none;}
      aside a{
        flex:0 0 auto;
        padding:12px 16px;
        font-size:12px;
        white-space:nowrap;
        border-bottom:none;
        border-right:1px solid rgba(0,0,0,.08);
        min-width:fit-content;
      }
      .sidebar-user{display:none;}
      
      /* Header mobile adjustments */
      header{
        padding:10px 12px;
        flex-wrap:wrap;
        gap:8px;
      }
      .brand__text{font-size:14px;}
      .brand__text small{font-size:10px;}
      .brand__mark{width:30px;height:30px;}
      .header-right{
        width:100%;
        justify-content:space-between;
        font-size:12px;
        margin-top:4px;
      }
      .header-balance{font-size:12px;}
      #addFundBtn{padding:6px 12px;font-size:11px;white-space:nowrap;}
      
      /* Main content */
      main{padding:12px;height:auto;}
      main > section{padding:12px;margin-bottom:12px;}
      
      /* Typography */
      h2{font-size:18px;margin:4px 0 10px 0;}
      h3{font-size:16px;}
      
      /* Toolbars and forms */
      .toolbar{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      .toolbar > *{width:100%;margin-bottom:0;}
      .toolbar input,
      .toolbar select,
      .toolbar button{width:100%;max-width:none;}
      
      /* Tables */
      table{font-size:11px;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;}
      th,td{padding:8px 6px;font-size:11px;}
      th{font-size:10px;}
      
      /* Profile table - card-like layout */
      #profile-table{display:block;border:none;}
      #profile-table tbody{display:block;}
      #profile-table tr{
        display:block;
        margin-bottom:12px;
        border:1px solid rgba(0,0,0,.12);
        border-radius:8px;
        padding:8px;
        background:#ffffff;
      }
      #profile-table th,#profile-table td{
        display:block;
        width:100%;
        border:none;
        padding:4px 0;
      }
      #profile-table th{text-align:left;font-weight:600;margin-bottom:4px;}
      
      /* KPI Grid */
      .kpi-grid{
        grid-template-columns:1fr;
        gap:10px;
      }
      .kpi-card{padding:12px;}
      .kpi-label{font-size:11px;}
      .kpi-value{font-size:24px;}
      .kpi-sub{font-size:10px;}
      
      /* Charts */
      #callsChartContainer{height:250px;margin-top:16px;}
      .pie-charts-grid{
        grid-template-columns:1fr;
        gap:12px;
      }
      .pie-chart-card{padding:12px;}
      
      /* Modals */
      #addFundModal > div,
      #trunkModal > div,
      #dialerCreateModal > div,
      #dialerUploadModal > div,
      #aiEmailPreviewModal > div,
      #aiAgentModal .ai-agent-modal-card,
      #aiTemplateModal .ai-agent-modal-card,
      .ai-tool-modal-card{
        width:95% !important;
        max-width:95% !important;
        max-height:90vh !important;
        overflow-y:auto !important;
        margin:5vh auto !important;
      }
      
      /* AI Chat messages */
      .ai-chat-card{
        padding:10px;
        margin-bottom:10px;
      }
      .ai-chat-meta{font-size:11px;}
      .ai-chat-body{font-size:12px;}
      
      /* Number inputs - better mobile touch */
      input[type="tel"],
      input[type="number"]{
        font-size:16px; /* Prevents iOS zoom on focus */
      }
      
      /* Buttons - larger touch targets */
      button,
      .btn,
      .btn--primary,
      .btn--danger,
      .btn--secondary{
        min-height:44px;
        padding:10px 16px;
        font-size:14px;
        border-radius:10px;
      }
      
      /* Status badges */
      .status-tag,
      .bill-tag,
      .bill-status{font-size:9px;padding:2px 6px;}
    }

    @media (max-width: 480px) {
      /* Extra small mobile devices */
      header{padding:8px 10px;}
      .brand__text{font-size:13px;}
      .brand__mark{width:28px;height:28px;}
      #addFundBtn{font-size:10px;padding:6px 10px;}
      
      main{padding:8px;}
      main > section{padding:10px;margin-bottom:10px;}
      
      h2{font-size:16px;}
      h3{font-size:14px;}
      
      button,
      .btn,
      .btn--primary,
      .btn--danger,
      .btn--secondary{
        padding:8px 12px;
        font-size:13px;
      }
      
      table{font-size:10px;}
      th,td{padding:6px 4px;font-size:10px;}
      
      .kpi-value{font-size:20px;}
      .kpi-label{font-size:10px;}
      
      #callsChartContainer{height:220px;}
    }
    
    /* Landscape mobile orientation */
    @media (max-width: 768px) and (orientation: landscape) {
      #callsChartContainer{height:200px;}
      .kpi-grid{grid-template-columns:repeat(3, 1fr);gap:8px;}
    }
    
    /* Touch-specific optimizations */
    @media (hover: none) and (pointer: coarse) {
      /* Better touch targets */
      a,button,input,select,textarea{min-height:44px;}
      aside a{min-height:48px;}
      
      /* Remove hover effects on touch devices */
      aside a:hover{background:transparent;}
      tbody tr:hover td{background:transparent;}
      
      /* Add active states instead */
      aside a:active{background:rgba(0,0,0,.08);}
      button:active{transform:scale(0.98);opacity:0.9;}
    }
  </style>
  <style>
    /* Small method badges for billing history */
    .bill-tag {
      display:inline-block;
      margin-right:6px;
      padding:1px 6px;
      border-radius:999px;
      font-size:10px;
      font-weight:600;
      vertical-align:middle;
    }
    .bill-tag-card {
      background: rgba(16,185,129,.10);
      color: #059669;
      border: 1px solid rgba(16,185,129,.30);
    }
    .bill-tag-crypto {
      background: rgba(34,211,238,.10);
      color: #0891b2;
      border: 1px solid rgba(34,211,238,.30);
    }
    .bill-tag-billcom {
      background: rgba(167,139,250,.10);
      color: #7c3aed;
      border: 1px solid rgba(167,139,250,.30);
    }
    /* Status badges for billing rows */
    .bill-status {
      display:inline-block;
      padding:1px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:600;
      vertical-align:middle;
    }
    .bill-status-completed {
      background: rgba(16,185,129,.10);
      color: #059669;
      border: 1px solid rgba(16,185,129,.30);
    }
    .bill-status-pending {
      background: rgba(245,158,11,.10);
      color: #d97706;
      border: 1px solid rgba(245,158,11,.30);
    }
    .bill-status-failed {
      background: rgba(239,68,68,.10);
      color: #dc2626;
      border: 1px solid rgba(239,68,68,.30);
    }
  </style>

  <!-- Noticeable widget -->
  <script>
    !function(){'use strict';const e=['debug','destroy','do','help','identify','is','off','on','ready','render','reset','safe','set'];if(window.noticeable)console.warn('Noticeable SDK code snippet loaded more than once');else{const n=window.noticeable=window.noticeable||[];function t(e){return function(){const t=Array.prototype.slice.call(arguments);return t.unshift(e),n.push(t),n}}function o(){for(let o=0;o<e.length;o++){const c=e[o];n[c]=t(c)}}function c(){const e=document.createElement('script');e.async=!0;e.src='https://sdk.noticeable.io/l.js';const n=document.head;n.insertBefore(e,n.firstChild)}o();c()}}();
  </script>
  <script>
    noticeable.render('widget', 'UjIu5kI00favBWSvBEGd');
  </script>
</head>
<body>
  <div id="appRoot">
  <header>
    <a class="brand" href="/" aria-label="Phone.System home">
      <span class="brand__mark" aria-hidden="true"></span>
      <span class="brand__text">Phone.System <small>AI Voice + Video</small></span>
    </a>
    <div class="header-right">
      <div id="noticeable-widget"></div>
      <span id="currentBalance" class="header-balance"></span>
      <button id="addFundBtn" type="button" class="btn--primary" onclick="if(window.__addFundsFallback&&window.__addFundsFallback.openModal){window.__addFundsFallback.openModal();}">‚ûï Add Funds</button>
      <form style="display:inline" method="post" action="/logout"><button type="submit">Logout</button></form>
    </div>
  </header>
  <div class="wrap">
    <aside>
      <a href="#overview" id="tab-overview" class="active"><img class="nav-icon" src="/Icon/Overview.ico" alt="" aria-hidden="true"><span>Overview</span></a>
      <a href="#ai" id="tab-ai"><img class="nav-icon" src="/Icon/AI%20Agent.ico" alt="" aria-hidden="true"><span>AI Agent</span></a>
      <a href="#dialer" id="tab-dialer"><img class="nav-icon" src="/Icon/Call%20History.ico" alt="" aria-hidden="true"><span>Outbound Dialer</span></a>
      <a href="#cdr" id="tab-cdr"><img class="nav-icon" src="/Icon/Call%20History.ico" alt="" aria-hidden="true"><span>Call History</span></a>
      <a href="#billing" id="tab-billing"><img class="nav-icon" src="/Icon/Billing%20History.ico" alt="" aria-hidden="true"><span>Billing History</span></a>
      <a href="#profile" id="tab-profile"><img class="nav-icon" src="/Icon/Profile.ico" alt="" aria-hidden="true"><span>Profile</span></a>
      <div class="sidebar-user">Signed in as <strong><%= username %></strong></div>
    </aside>
    <main>
      <section id="view-overview">
        <h2>Overview</h2>
        <div id="overviewStats">
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">Inbound Calls</div>
              <div class="kpi-sub" id="kpiInboundToday"></div>
              <div class="kpi-value" id="kpiInbound">‚Äì</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Outbound Calls</div>
              <div class="kpi-sub" id="kpiOutboundToday"></div>
              <div class="kpi-value" id="kpiOutbound">‚Äì</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">AI Agents</div>
              <div class="kpi-sub" id="kpiAiAgentsSub"></div>
              <div class="kpi-value" id="kpiAiAgents">‚Äì</div>
            </div>
          </div>

          <div id="callsChartContainer">
            <div class="muted" id="statsRangeText" style="margin-bottom:4px;"></div>
            <canvas id="callsChart"></canvas>
          </div>

          <div class="muted" style="margin:16px 0 8px 0;font-weight:700">Inbound vs Outbound Calls</div>
          <div class="pie-charts-grid">
            <div class="pie-chart-card">
              <div class="pie-chart-title">Call Distribution</div>
              <canvas id="callDistributionChart"></canvas>
            </div>
          </div>

          <div class="muted" style="margin:16px 0 8px 0;font-weight:700">AI Communication Status</div>
          <div class="pie-charts-grid">
            <div class="pie-chart-card">
              <div class="pie-chart-title">Emails</div>
              <canvas id="emailStatusChart"></canvas>
              <div id="emailStatusEmpty" class="muted" style="text-align:center;padding:20px;display:none">No emails sent yet</div>
            </div>
            <div class="pie-chart-card">
              <div class="pie-chart-title">SMS</div>
              <canvas id="smsStatusChart"></canvas>
              <div id="smsStatusEmpty" class="muted" style="text-align:center;padding:20px;display:none">No SMS sent yet</div>
            </div>
            <div class="pie-chart-card">
              <div class="pie-chart-title">Meeting Links</div>
              <canvas id="meetingStatusChart"></canvas>
              <div id="meetingStatusEmpty" class="muted" style="text-align:center;padding:20px;display:none">No meeting links sent yet</div>
            </div>
            <div class="pie-chart-card">
              <div class="pie-chart-title">Physical Mail</div>
              <canvas id="mailStatusChart"></canvas>
              <div id="mailStatusEmpty" class="muted" style="text-align:center;padding:20px;display:none">No mail sent yet</div>
            </div>
            <div class="pie-chart-card">
              <div class="pie-chart-title">Payments</div>
              <canvas id="paymentStatusChart"></canvas>
              <div id="paymentStatusEmpty" class="muted" style="text-align:center;padding:20px;display:none">No payment links sent yet</div>
            </div>
          </div>
        </div>
      </section>
      <section id="view-profile" style="display:none">
        <h2>Profile</h2>
        <div class="toolbar" id="profile-toolbar" style="display:none">
          <button id="saveProfileAddressBtn" class="btn--primary" disabled>Save Address</button>
          <div class="muted" style="margin-left:auto">Country must be a 2-letter code (e.g. US)</div>
          <button id="deleteAccountBtn" disabled title="Deleting the primary signup user is disabled">Delete Account</button>
        </div>
        <table id="profile-table" style="display:none"><tbody></tbody></table>
        <div id="profile-empty" class="muted">Loading‚Ä¶</div>
      </section>
      <section id="view-cdr" style="display:none">
        <h2>Call History</h2>
        <div class="toolbar">
          <label>From <input type="date" id="from"></label>
          <label>To <input type="date" id="to"></label>
          <select id="cdrFilter" style="margin-left:10px">
            <option value="all">All Calls</option>
            <option value="inbound">Inbound Only</option>
            <option value="outbound">Outbound Only</option>
          </select>
          <button id="loadCdr">Load</button>
        </div>
        <table id="cdr-table" style="display:none">
          <thead><tr><th>Direction</th><th>Date/Time</th><th>From</th><th>To</th><th>Duration</th><th>Cost</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" id="cdr-pager" style="display:none">
          <button id="cdrPrev">Prev</button>
          <span id="cdrPageInfo" class="muted"></span>
          <button id="cdrNext">Next</button>
        </div>
        <div id="cdr-empty" class="muted">Loading‚Ä¶</div>
      </section>
      <section id="view-dialer" style="display:none">
        <h2>Outbound Dialer</h2>
        <div class="muted" style="margin-bottom:10px">
          Launch AI-powered outbound campaigns: pick an AI agent, upload leads from CSV,
          then start, pause, or complete the run while tracking answer/voicemail/transfer metrics.
        </div>
        <div class="toolbar" id="dialer-toolbar">
          <button id="dialerCreateBtn" class="btn--primary">‚ûï Create Campaign</button>
          <button id="dialerRefreshBtn">Refresh</button>
          <div id="dialerStatus" class="muted"></div>
        </div>
        <table id="dialer-campaigns-table" style="display:none">
          <thead>
            <tr>
              <th>Campaign</th>
              <th>AI Agent</th>
              <th>Leads</th>
              <th>Concurrency</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" id="dialer-pager" style="display:none">
          <button id="dialerPrev">Prev</button>
          <span id="dialerPageInfo" class="muted"></span>
          <button id="dialerNext">Next</button>
        </div>
        <div id="dialer-empty" class="muted">Loading‚Ä¶</div>
      </section>

      <section id="view-ai" style="display:none">
        <h2>AI Agent</h2>
        <div class="muted" style="margin-bottom:10px">Create AI agents for inbound calls and video meetings ‚Äî assign numbers, send meeting links, review conversations, and configure tools like email and call transfer.</div>

        <div class="ai-subtabs">
          <button id="ai-subtab-agents" type="button" class="ai-subtab active">Agents</button>
          <button id="ai-subtab-conversations" type="button" class="ai-subtab">Inbound Conversations</button>
          <button id="ai-subtab-outbound-conversations" type="button" class="ai-subtab">Outbound Conversations</button>
          <button id="ai-subtab-emails" type="button" class="ai-subtab">Emails</button>
          <button id="ai-subtab-sms" type="button" class="ai-subtab">SMS</button>
          <button id="ai-subtab-meetings" type="button" class="ai-subtab">Meeting</button>
          <button id="ai-subtab-mail" type="button" class="ai-subtab">Mail</button>
          <button id="ai-subtab-payments" type="button" class="ai-subtab">Payments</button>
          <button id="ai-subtab-tools" type="button" class="ai-subtab">Tools</button>
        </div>

        <div id="ai-pane-agents">
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Agents <span id="aiAgentsCount" class="muted"></span></h3>
                <div style="margin-left:auto"></div>
                <button id="createAiAgentBtn" class="btn--primary">‚ûï Create Agent</button>
              </div>
              <table id="ai-agents-table" style="display:none">
                <thead><tr><th>Name</th><th>Voice</th><th>Greeting</th><th>Number</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="ai-agents-empty" class="muted">Loading‚Ä¶</div>
            </div>

            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Phone Numbers <span id="aiNumbersCount" class="muted"></span></h3>
                <div style="margin-left:auto"></div>
                <button id="buyAiNumberBtn" class="btn--primary">‚ûï Buy Number</button>
              </div>
              <div id="aiNumbersBalanceLockNote" class="muted" style="display:none;margin:-4px 0 10px 0">Balance must be positive to buy/assign AI numbers. Add funds to continue.</div>
              <table id="ai-numbers-table" style="display:none">
                <thead><tr><th>Number</th><th>Assigned Agent</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="ai-numbers-empty" class="muted">Loading‚Ä¶</div>
            </div>
          </div>
        </div>

        <div id="ai-pane-tools" style="display:none">
          <div class="muted" style="margin-bottom:14px">Configure integrations and tools for your AI agents.</div>
          <div class="ai-tools-grid">
            <!-- Email (SMTP) -->
            <div class="ai-tool-card" data-tool="smtp">
              <div class="ai-tool-card-icon">‚úâÔ∏è</div>
              <div class="ai-tool-card-content">
                <div class="ai-tool-card-title">Email (SMTP)</div>
                <div class="ai-tool-card-desc">Send emails and documents to callers via your SMTP server.</div>
              </div>
              <div class="ai-tool-card-status" id="smtpCardStatus"><span class="ai-tool-status-badge ai-tool-status-unconfigured">Not configured</span></div>
            </div>

            <!-- Call Transfer -->
            <div class="ai-tool-card" data-tool="transfer">
              <div class="ai-tool-card-icon">üìû</div>
              <div class="ai-tool-card-content">
                <div class="ai-tool-card-title">Call Transfer</div>
                <div class="ai-tool-card-desc">Set the default destination for transferring calls from AI agents.</div>
              </div>
              <div class="ai-tool-card-status" id="transferCardStatus"><span class="ai-tool-status-badge ai-tool-status-unconfigured">Not configured</span></div>
            </div>

            <!-- SMS -->
            <div class="ai-tool-card" data-tool="sms">
              <div class="ai-tool-card-icon">üí¨</div>
              <div class="ai-tool-card-content">
                <div class="ai-tool-card-title">SMS</div>
                <div class="ai-tool-card-desc">Configure outbound SMS sender numbers for your AI agents.</div>
              </div>
              <div class="ai-tool-card-status" id="smsCardStatus"><span class="ai-tool-status-badge ai-tool-status-unconfigured">Not configured</span></div>
            </div>

            <!-- Mail (Return Address) -->
            <div class="ai-tool-card" data-tool="mail">
              <div class="ai-tool-card-icon">üì¨</div>
              <div class="ai-tool-card-content">
                <div class="ai-tool-card-title">Mail</div>
                <div class="ai-tool-card-desc">Set the return address for physical mail sent via USPS.</div>
              </div>
              <div class="ai-tool-card-status" id="mailCardStatus"><span class="ai-tool-status-badge ai-tool-status-unconfigured">Not configured</span></div>
            </div>

            <!-- Document Templates -->
            <div class="ai-tool-card" data-tool="doctemplates">
              <div class="ai-tool-card-icon">üìÑ</div>
              <div class="ai-tool-card-content">
                <div class="ai-tool-card-title">Document Templates</div>
                <div class="ai-tool-card-desc">Upload .docx templates with placeholders for personalized documents.</div>
              </div>
              <div class="ai-tool-card-status" id="docTemplatesCardStatus"><span class="ai-tool-status-badge ai-tool-status-unconfigured">Not configured</span></div>
            </div>

            <!-- Square Payments -->
            <div class="ai-tool-card" data-tool="square">
              <div class="ai-tool-card-icon">üü¶</div>
              <div class="ai-tool-card-content">
                <div class="ai-tool-card-title">Square Payments</div>
                <div class="ai-tool-card-desc">Let your AI agent send payment links to callers via Square.</div>
              </div>
              <div class="ai-tool-card-status" id="squareCardStatus"><span class="ai-tool-status-badge ai-tool-status-unconfigured">Not configured</span></div>
            </div>

            <!-- Stripe Payments -->
            <div class="ai-tool-card" data-tool="stripe">
              <div class="ai-tool-card-icon">üí≥</div>
              <div class="ai-tool-card-content">
                <div class="ai-tool-card-title">Stripe Payments</div>
                <div class="ai-tool-card-desc">Let your AI agent send payment links to callers via Stripe.</div>
              </div>
              <div class="ai-tool-card-status" id="stripeCardStatus"><span class="ai-tool-status-badge ai-tool-status-unconfigured">Not configured</span></div>
            </div>
          </div>
        </div>

        <div id="ai-pane-meetings" style="display:none">
          <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <h3 style="margin:0">Meetings</h3>
              <div style="margin-left:auto"></div>
              <select id="aiMeetingsAgentFilter" style="width:170px">
                <option value="">All agents</option>
              </select>
              <button id="aiMeetingsRefreshBtn" type="button" class="btn--muted">Refresh</button>
            </div>

            <div class="toolbar" style="flex-wrap:wrap">
              <select id="aiMeetingsSendAgentId" style="width:170px">
                <option value="">Select agent‚Ä¶</option>
              </select>
              <input id="aiMeetingsSendEmail" type="email" placeholder="Caller email" style="width:240px">
              <input id="aiMeetingsSendSubject" type="text" placeholder="Subject (optional)" style="flex:1;min-width:220px">
              <button id="aiMeetingsSendBtn" type="button" class="btn--primary">Send Link</button>
              <span id="aiMeetingsSendStatus" class="muted" style="margin-left:auto"></span>
            </div>

            <table id="ai-meetings-table" style="display:none">
              <thead><tr><th>Sent</th><th>To</th><th>Agent</th><th>Link</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-meetings-empty" class="muted">Loading‚Ä¶</div>
            <div class="toolbar" id="ai-meetings-pager" style="display:none">
              <button id="aiMeetingsPrev">Prev</button>
              <span id="aiMeetingsPageInfo" class="muted"></span>
              <button id="aiMeetingsNext">Next</button>
            </div>
          </div>
        </div>

        <div id="ai-pane-emails" style="display:none">
          <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <h3 style="margin:0">Emails</h3>
              <div style="margin-left:auto"></div>
              <select id="aiEmailsAgentFilter" style="width:170px">
                <option value="">All agents</option>
              </select>
              <select id="aiEmailsStatusFilter" style="width:150px">
                <option value="">All statuses</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
              </select>
              <button id="aiEmailsRefreshBtn" type="button" class="btn--muted">Refresh</button>
            </div>

            <table id="ai-emails-table" style="display:none">
              <thead><tr><th>Sent</th><th>To</th><th>Agent</th><th>Subject</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-emails-empty" class="muted">Loading‚Ä¶</div>
            <div class="toolbar" id="ai-emails-pager" style="display:none">
              <button id="aiEmailsPrev">Prev</button>
              <span id="aiEmailsPageInfo" class="muted"></span>
              <button id="aiEmailsNext">Next</button>
            </div>
          </div>
        </div>

        <div id="ai-pane-sms" style="display:none">
          <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <h3 style="margin:0">SMS</h3>
              <div style="margin-left:auto"></div>
              <select id="aiSmsAgentFilter" style="width:170px">
                <option value="">All agents</option>
              </select>
              <select id="aiSmsStatusFilter" style="width:150px">
                <option value="">All statuses</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
              </select>
              <button id="aiSmsRefreshBtn" type="button" class="btn--muted">Refresh</button>
            </div>

            <table id="ai-sms-table" style="display:none">
              <thead><tr><th>Sent</th><th>To</th><th>From</th><th>Agent</th><th>Message</th><th>Status</th><th>Delivery</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-sms-empty" class="muted">Loading‚Ä¶</div>
            <div class="toolbar" id="ai-sms-pager" style="display:none">
              <button id="aiSmsPrev">Prev</button>
              <span id="aiSmsPageInfo" class="muted"></span>
              <button id="aiSmsNext">Next</button>
            </div>
          </div>
        </div>

        <div id="ai-pane-mail" style="display:none">
          <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <h3 style="margin:0">Mail</h3>
              <div style="margin-left:auto"></div>
              <select id="aiMailAgentFilter" style="width:170px">
                <option value="">All agents</option>
              </select>
              <button id="aiMailRefreshBtn" type="button" class="btn--muted">Refresh</button>
            </div>
            <table id="ai-mail-table" style="display:none">
              <thead><tr><th>Sent</th><th>To</th><th>Address</th><th>Agent</th><th>Tracking</th><th>Status</th><th>Cost</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-mail-empty" class="muted">Loading‚Ä¶</div>
            <div class="toolbar" id="ai-mail-pager" style="display:none">
              <button id="aiMailPrev">Prev</button>
              <span id="aiMailPageInfo" class="muted"></span>
              <button id="aiMailNext">Next</button>
            </div>
          </div>
        </div>

        <div id="ai-pane-payments" style="display:none">
          <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <h3 style="margin:0">Payments</h3>
              <div style="margin-left:auto"></div>
              <select id="aiPaymentsStatusFilter" style="width:150px">
                <option value="">All statuses</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
                <option value="expired">Expired</option>
              </select>
              <select id="aiPaymentsProviderFilter" style="width:120px">
                <option value="">All providers</option>
                <option value="square">Square</option>
                <option value="stripe">Stripe</option>
              </select>
              <button id="aiPaymentsRefreshBtn" type="button" class="btn--muted">Refresh</button>
            </div>
            <table id="ai-payments-table" style="display:none">
              <thead><tr><th>Date</th><th>Amount</th><th>Description</th><th>Customer</th><th>Provider</th><th>Status</th><th>Paid</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-payments-empty" class="muted">Loading‚Ä¶</div>
            <div class="toolbar" id="ai-payments-pager" style="display:none">
              <button id="aiPaymentsPrev">Prev</button>
              <span id="aiPaymentsPageInfo" class="muted"></span>
              <button id="aiPaymentsNext">Next</button>
            </div>
          </div>
        </div>

        <div id="ai-pane-conversations" style="display:none">
          <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Inbound Sessions</h3>
                <div style="margin-left:auto"></div>
                <select id="aiConvAgentFilter" style="width:170px">
                  <option value="">All agents</option>
                </select>
                <button id="aiConvRefreshBtn" type="button" class="btn--muted">Refresh</button>
              </div>
              <table id="ai-conv-sessions-table" style="display:none">
                <thead><tr><th>Start</th><th>From</th><th>Agent</th><th>Msgs</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="ai-conv-sessions-empty" class="muted">Loading‚Ä¶</div>
              <div class="toolbar" id="ai-conv-sessions-pager" style="display:none">
                <button id="aiConvPrev">Prev</button>
                <span id="aiConvPageInfo" class="muted"></span>
                <button id="aiConvNext">Next</button>
              </div>
            </div>

            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Conversation</h3>
                <span id="aiConvSessionMeta" class="muted" style="margin-left:auto"></span>
              </div>
              <div id="aiConvMessages" style="max-height:520px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f9fafb"></div>
              <div id="aiConvMessagesEmpty" class="muted" style="margin-top:8px">Select a session to view the transcript.</div>
            </div>
          </div>
        </div>

        <div id="ai-pane-outbound-conversations" style="display:none">
          <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Outbound Sessions</h3>
                <div style="margin-left:auto"></div>
                <select id="aiOutboundConvAgentFilter" style="width:170px">
                  <option value="">All agents</option>
                </select>
                <button id="aiOutboundConvRefreshBtn" type="button" class="btn--muted">Refresh</button>
              </div>
              <table id="ai-outbound-conv-sessions-table" style="display:none">
                <thead><tr><th>Start</th><th>To</th><th>Agent</th><th>Msgs</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="ai-outbound-conv-sessions-empty" class="muted">Loading‚Ä¶</div>
              <div class="toolbar" id="ai-outbound-conv-sessions-pager" style="display:none">
                <button id="aiOutboundConvPrev">Prev</button>
                <span id="aiOutboundConvPageInfo" class="muted"></span>
                <button id="aiOutboundConvNext">Next</button>
              </div>
            </div>

            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Conversation</h3>
                <span id="aiOutboundConvSessionMeta" class="muted" style="margin-left:auto"></span>
              </div>
              <div id="aiOutboundConvMessages" style="max-height:520px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f9fafb"></div>
              <div id="aiOutboundConvMessagesEmpty" class="muted" style="margin-top:8px">Select a session to view the transcript.</div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-billing" style="display:none">
        <h2>Billing History</h2>
        <table id="billing-table" style="display:none">
          <thead><tr><th>Date</th><th>Amount</th><th>Description</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" id="billing-pager" style="display:none">
          <button id="billingPrev">Prev</button>
          <span id="billingPageInfo" class="muted"></span>
          <button id="billingNext">Next</button>
        </div>
        <div id="billing-empty" class="muted">Loading‚Ä¶</div>
      </section>
    </main>
    <!-- Add Fund Modal -->
    <div id="addFundModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:flex-start;justify-content:center;overflow:auto;padding:24px 12px;box-sizing:border-box">
      <div style="background:#fff;padding:24px;border-radius:12px;width:360px;max-width:100%;box-sizing:border-box">
        <h3 style="margin:0 0 16px 0">üí≥ Add Funds</h3>
        <div style="margin-bottom:12px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Amount ($)</label>
          <input id="fundAmount" type="number" min="<%= checkoutMinAmount || 100 %>" max="<%= checkoutMaxAmount || 500 %>" step="0.01" placeholder="Enter amount" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:12px;font-size:13px;color:#4b5563">
          Payment method:
          <% const _addFundsMethods = Array.isArray(addFundsMethods) ? addFundsMethods : []; %>
          <% if (_addFundsMethods.length > 0) { %>
            <% _addFundsMethods.forEach((m, idx) => { %>
              <label style="margin-left:8px;cursor:pointer">
                <input type="radio" name="fundMethod" value="<%= m.value %>" <%= String(defaultFundMethod || '') === String(m.value || '') || (!defaultFundMethod && idx === 0) ? 'checked' : '' %>> <%= m.label %>
              </label>
            <% }); %>
            <div style="margin-top:6px;font-size:12px;color:#6b7280">
              <% _addFundsMethods.forEach((m) => { %>
                <div><strong><%= m.label %></strong>: <%= m.helpText %></div>
              <% }); %>
            </div>
          <% } else { %>
            <label style="margin-left:8px;cursor:pointer">
              <input type="radio" name="fundMethod" value="card" checked> Card
            </label>
            <label style="margin-left:8px;cursor:pointer">
              <input type="radio" name="fundMethod" value="crypto"> Crypto
            </label>
            <label style="margin-left:8px;cursor:pointer">
              <input type="radio" name="fundMethod" value="ach"> ACH
            </label>
            <div style="margin-top:6px;font-size:12px;color:#6b7280">
              <div><strong>Card</strong>: instant credit after successful payment.</div>
              <div><strong>Crypto</strong>: credit is applied after network confirmations (may take several minutes).</div>
              <div><strong>ACH</strong>: credit is applied after invoice payment is confirmed (may take a few minutes).</div>
            </div>
            <div style="margin-top:6px;font-size:12px;color:#dc2626">
              Payment configuration could not be detected automatically, so fallback methods are shown.
            </div>
          <% } %>
        </div>
        <div id="fundStatus" style="display:none;margin-bottom:10px;font-size:12px;color:#dc2626"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelFundBtn" type="button" class="btn--muted" onclick="if(window.__addFundsFallback&&window.__addFundsFallback.closeModal){window.__addFundsFallback.closeModal();}">Cancel</button>
          <button id="confirmFundBtn" type="button" class="btn--primary" onclick="if(!window.__addFundsReady&&window.__addFundsFallback&&window.__addFundsFallback.submit){window.__addFundsFallback.submit();return false;}">Continue</button>
        </div>
      </div>
    </div>
    <script>
      (function addFundsFallbackBootstrap(){
        function byId(id){ return document.getElementById(id); }
        function openModal(){
          const m = byId('addFundModal');
          if (m) m.style.display = 'flex';
          const amount = byId('fundAmount');
          if (amount) {
            amount.value = '';
            try { amount.focus(); } catch {}
          }
          const status = byId('fundStatus');
          if (status) { status.style.display = 'none'; status.textContent = ''; }
        }
        function closeModal(){
          const m = byId('addFundModal');
          if (m) m.style.display = 'none';
        }
        function selectedMethod(){
          const checked = document.querySelector('input[name="fundMethod"]:checked');
          return checked ? String(checked.value || '') : 'card';
        }
        function methodLabel(method){
          const m = String(method || '').trim().toLowerCase();
          if (m === 'crypto') return 'Crypto';
          if (m === 'ach') return 'ACH';
          return 'Card';
        }
        async function submit(){
          const amountEl = byId('fundAmount');
          const statusEl = byId('fundStatus');
          const confirmBtn = byId('confirmFundBtn');
          if (statusEl) { statusEl.style.display = 'none'; statusEl.textContent = ''; }

          const amount = parseFloat(amountEl && amountEl.value ? amountEl.value : '');
          const min = Number(amountEl && amountEl.getAttribute('min') ? amountEl.getAttribute('min') : 0);
          const max = Number(amountEl && amountEl.getAttribute('max') ? amountEl.getAttribute('max') : 0);
          if (!amount || !Number.isFinite(amount)) {
            alert('Please enter a valid amount.');
            return;
          }
          if ((Number.isFinite(min) && min > 0 && amount < min) || (Number.isFinite(max) && max > 0 && amount > max)) {
            alert(`Amount must be between $${Number(min || 0).toFixed(2)} and $${Number(max || 0).toFixed(2)}.`);
            return;
          }

          const method = selectedMethod();
          const endpoint = method === 'crypto'
            ? '/api/me/nowpayments/checkout'
            : method === 'ach'
              ? '/api/me/ach/checkout'
              : '/api/me/card/checkout';
          const label = methodLabel(method);

          if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.textContent = `Redirecting to ${label}...`;
          }
          try {
            const r = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ amount })
            });
            const j = await r.json().catch(() => null);
            if (!r.ok || !j || j.success === false) {
              const msg = (j && j.message) ? j.message : `${label} payment could not be started. Please try again.`;
              if (statusEl) { statusEl.textContent = msg; statusEl.style.display = 'block'; }
              alert(msg);
              return;
            }
            if (j.payment_url) {
              window.location.href = j.payment_url;
              return;
            }
            const okMsg = j.message || 'Payment started. Your balance will update after confirmation.';
            if (statusEl) { statusEl.textContent = okMsg; statusEl.style.display = 'block'; }
            closeModal();
          } catch (e) {
            const msg = 'Failed to start payment. Please try again.';
            if (statusEl) { statusEl.textContent = msg; statusEl.style.display = 'block'; }
            alert(msg);
          } finally {
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Continue';
            }
          }
        }

        function bindIfNeeded(){
          if (window.__addFundsReady) return;
          const openBtn = byId('addFundBtn');
          const cancelBtn = byId('cancelFundBtn');
          const confirmBtn = byId('confirmFundBtn');
          const modal = byId('addFundModal');

          if (openBtn && !openBtn.dataset.addFundsFallbackBound) {
            openBtn.dataset.addFundsFallbackBound = '1';
            openBtn.addEventListener('click', openModal);
          }
          if (cancelBtn && !cancelBtn.dataset.addFundsFallbackBound) {
            cancelBtn.dataset.addFundsFallbackBound = '1';
            cancelBtn.addEventListener('click', closeModal);
          }
          if (confirmBtn && !confirmBtn.dataset.addFundsFallbackBound) {
            confirmBtn.dataset.addFundsFallbackBound = '1';
            confirmBtn.addEventListener('click', submit);
          }
          if (modal && !modal.dataset.addFundsFallbackBound) {
            modal.dataset.addFundsFallbackBound = '1';
            modal.addEventListener('click', (e) => {
              if (e.target === modal) closeModal();
            });
          }
        }

        window.__addFundsFallback = { openModal, closeModal, submit };
        setTimeout(bindIfNeeded, 400);
      })();
    </script>

    <!-- Buy AI Number Modal -->
    <div id="buyAiNumberModal" class="ai-tool-modal">
      <div class="ai-tool-modal-card" style="width:640px">
        <div class="ai-tool-modal-header">
          <span class="ai-tool-modal-icon">üìû</span>
          <span class="ai-tool-modal-title">Buy a phone number</span>
          <button type="button" class="ai-tool-modal-close" id="closeBuyAiNumberModalBtn">&times;</button>
        </div>
        <div class="muted" style="margin-bottom:14px">Search for available phone numbers by state or city.</div>

        <div class="ai-tool-modal-body">
          <div class="ai-tool-modal-row">
            <div>
              <label>State</label>
              <select id="aiBuyRegion">
                <option value="">Select a state...</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </div>
            <div>
              <label>City <span class="muted">(optional)</span></label>
              <input id="aiBuyCity" type="text" placeholder="e.g. Seattle">
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button id="aiBuySearchBtn" class="btn--primary" type="button">Search</button>
          </div>
          <div class="muted" id="aiBuyFeeNote" style="font-size:12px;margin-top:10px">Each number is billed at <strong>$<span id="aiBuyFeeValue">0.00</span>/mo</strong>.</div>

          <div style="border-top:1px solid rgba(0,0,0,.10);padding-top:14px;margin-top:14px">
            <div id="aiBuySearchStatus" class="muted" style="margin-bottom:10px">Select a state and click Search.</div>
            <table id="ai-buy-results-table" style="display:none">
              <thead><tr><th>Number</th><th>Location</th><th>Action</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-buy-results-empty" class="muted" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Agent Modal -->
    <div id="dialerCreateModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div style="background:#ffffff;border:1px solid rgba(0,0,0,.10);box-shadow:var(--shadow-sm);padding:16px;border-radius:14px;width:420px;max-width:92%;max-height:92vh;overflow:auto;color:var(--text)">
        <h3 style="margin:0 0 10px 0">üìû Create Dialer Campaign</h3>
        <div style="display:flex;flex-direction:column;gap:10px;font-size:13px">
          <label style="display:flex;flex-direction:column;gap:4px">
            <span>Campaign Name *</span>
            <input id="dialerCampaignNameInput" type="text" placeholder="e.g. January Renewals" required>
          </label>
          <label style="display:flex;flex-direction:column;gap:4px">
            <span>AI Agent *</span>
            <select id="dialerAgentSelect"><option value="">Loading agents‚Ä¶</option></select>
            <div class="muted" style="font-size:11px;margin-top:2px">Required for Pipecat service endpoint. If campaign audio is provided, the agent's AI won't be used.</div>
          </label>
          <label style="display:flex;flex-direction:column;gap:4px">
            <span>Campaign Audio (Optional)</span>
            <input id="dialerCampaignAudioInput" type="file" accept=".wav,audio/wav" style="font-size:12px">
            <div class="muted" style="font-size:11px;margin-top:2px">Upload a WAV file (max 10MB) to play instead of using the AI agent.</div>
          </label>
          <label style="display:flex;flex-direction:column;gap:4px">
            <span>Concurrent Calls</span>
            <input id="dialerConcurrencyInput" type="range" min="1" max="50" value="1">
            <div class="muted" style="font-size:12px;color:#64748b">Simultaneous calls: <strong id="dialerConcurrencyValue">1</strong></div>
          </label>
          <div class="muted" style="font-size:12px;color:#64748b">
            After creating the campaign you can upload leads (CSV with columns like <code>phone</code>, <code>name</code>, <code>metadata</code>) and start dialing.
          </div>
          <div id="dialerCreateError" class="muted" style="display:none;color:#b91c1c;font-size:12px"></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
          <button id="dialerCancelCreateBtn" class="btn--muted" type="button">Cancel</button>
          <button id="dialerSaveCampaignBtn" class="btn--primary" type="button">Save Campaign</button>
        </div>
      </div>
    </div>

    <div id="dialerUploadModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div style="background:#ffffff;border:1px solid rgba(0,0,0,.10);box-shadow:var(--shadow-sm);padding:16px;border-radius:14px;width:420px;max-width:92%;max-height:92vh;overflow:auto;color:var(--text)">
        <h3 style="margin:0 0 6px 0">üìã Upload Leads</h3>
        <div class="muted" style="margin-bottom:10px;color:#64748b;font-size:12px">Campaign: <strong id="dialerUploadCampaignName">‚Äî</strong></div>
        <label style="display:flex;flex-direction:column;gap:6px;font-size:13px">
          <span>CSV File *</span>
          <input id="dialerUploadFile" type="file" accept=".csv,text/csv">
        </label>
        <div class="muted" style="font-size:12px;color:#64748b;margin-top:8px">
          Include a header row. Only digits are required in <code>phone</code>; we auto-format to E.164.
          Optional columns: <code>name</code>, <code>metadata</code> (JSON or text). Limit 5,000 leads per upload.
        </div>
        <div id="dialerUploadStatus" class="muted" style="margin-top:10px;font-size:12px;color:#64748b"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
          <button id="dialerUploadCloseBtn" class="btn--muted" type="button">Close</button>
          <button id="dialerUploadSubmitBtn" class="btn--primary" type="button">Upload Leads</button>
        </div>
      </div>
    </div>

    <!-- Dialer Leads by Status Modal -->
    <div id="dialerLeadsModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div style="background:#ffffff;border:1px solid rgba(0,0,0,.10);box-shadow:0 8px 32px rgba(0,0,0,0.4);padding:16px;border-radius:14px;width:680px;max-width:94%;max-height:92vh;overflow:auto;color:var(--text)">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <h3 style="margin:0" id="dialerLeadsModalTitle">üìû Leads</h3>
          <span class="muted" style="font-size:12px" id="dialerLeadsModalSubtitle"></span>
          <div style="margin-left:auto"></div>
          <button id="dialerLeadsCloseBtn" class="btn--muted" type="button">Close</button>
        </div>
        <div id="dialerLeadsStatus" class="muted" style="font-size:12px;margin-bottom:10px;color:#64748b"></div>
        <div id="dialerLeadsTableWrap" style="max-height:400px;overflow:auto">
          <table id="dialerLeadsTable" class="table table-sm" style="width:100%;font-size:12px">
            <thead>
              <tr>
                <th>Phone</th>
                <th>Name</th>
                <th>Result</th>
                <th>Duration</th>
                <th>Attempts</th>
                <th>Last Call</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="dialerLeadsEmpty" class="muted" style="display:none;text-align:center;padding:20px 0;color:#64748b">No leads found for this status.</div>
        <div id="dialerLeadsPager" style="display:none;margin-top:12px;justify-content:space-between;align-items:center">
          <button id="dialerLeadsPrev" class="btn--muted">‚Üê Prev</button>
          <span id="dialerLeadsPageInfo" class="muted" style="font-size:12px"></span>
          <button id="dialerLeadsNext" class="btn--muted">Next ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- AI Agent Template Selection Modal -->
    <div id="aiTemplateModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9997;align-items:center;justify-content:center">
      <div class="ai-agent-modal-card" style="background:#fff;padding:18px;border-radius:14px;width:520px;max-width:94%;max-height:92vh;overflow:auto">
        <h3 style="margin:0 0 6px 0">ü§ñ Create Assistant</h3>
        <div class="muted" style="margin-bottom:14px;font-size:12px">Choose a template to get started, or create your own from scratch.</div>
        
        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:4px;font-size:12px;font-weight:700">Assistant Name <span class="muted">(can be adjusted later)</span></label>
          <input id="aiTemplateAgentName" type="text" placeholder="New Assistant" style="width:100%;box-sizing:border-box;padding:8px 10px;border-radius:10px">
        </div>

        <!-- Blank Template -->
        <div class="ai-template-card" data-template="blank" style="background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;margin-bottom:10px;cursor:pointer;transition:all .15s ease">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="font-size:18px">‚ûï</div>
            <div>
              <div style="font-weight:700;font-size:13px">Blank Template</div>
              <div class="muted" style="font-size:11px">Start from scratch with minimal configuration.</div>
            </div>
          </div>
        </div>

        <div class="muted" style="font-size:11px;text-transform:uppercase;letter-spacing:.5px;margin:14px 0 8px 0;color:#94a3b8">Quickstart</div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
          <div class="ai-template-card" data-template="customer-support" style="background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;cursor:pointer;transition:all .15s ease">
            <div style="font-size:16px;margin-bottom:6px">üíú</div>
            <div style="font-weight:700;font-size:12px;margin-bottom:4px">Customer Support Specialist</div>
            <div class="muted" style="font-size:10px;line-height:1.4">A comprehensive template for resolving product issues, answering questions, and ensuring satisfying customer experiences with technical knowledge and empathy.</div>
          </div>

          <div class="ai-template-card" data-template="lead-qualification" style="background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;cursor:pointer;transition:all .15s ease">
            <div style="font-size:16px;margin-bottom:6px">üë§</div>
            <div style="font-weight:700;font-size:12px;margin-bottom:4px">Lead Qualification Specialist</div>
            <div class="muted" style="font-size:10px;line-height:1.4">A consultative template designed to identify qualified prospects, understand business challenges, and connect them with appropriate sales representatives.</div>
          </div>

          <div class="ai-template-card" data-template="appointment-scheduler" style="background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;cursor:pointer;transition:all .15s ease">
            <div style="font-size:16px;margin-bottom:6px">üìÖ</div>
            <div style="font-weight:700;font-size:12px;margin-bottom:4px">Appointment Scheduler</div>
            <div class="muted" style="font-size:10px;line-height:1.4">A specialized template for efficiently booking, confirming, rescheduling, or canceling appointments while providing clear service information.</div>
          </div>

          <div class="ai-template-card" data-template="info-collector" style="background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;cursor:pointer;transition:all .15s ease">
            <div style="font-size:16px;margin-bottom:6px">üìã</div>
            <div style="font-weight:700;font-size:12px;margin-bottom:4px">Info Collector</div>
            <div class="muted" style="font-size:10px;line-height:1.4">A methodical template for gathering accurate and complete information from customers while ensuring data quality and regulatory compliance.</div>
          </div>

          <div class="ai-template-card" data-template="care-coordinator" style="background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;cursor:pointer;transition:all .15s ease">
            <div style="font-size:16px;margin-bottom:6px">üíö</div>
            <div style="font-weight:700;font-size:12px;margin-bottom:4px">Care Coordinator</div>
            <div class="muted" style="font-size:10px;line-height:1.4">A compassionate template for scheduling medical appointments, answering health questions, and coordinating patient services with HIPAA compliance.</div>
          </div>

          <div class="ai-template-card" data-template="feedback-gatherer" style="background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:12px;cursor:pointer;transition:all .15s ease">
            <div style="font-size:16px;margin-bottom:6px">‚≠ê</div>
            <div style="font-weight:700;font-size:12px;margin-bottom:4px">Feedback Gatherer</div>
            <div class="muted" style="font-size:10px;line-height:1.4">An engaging template for conducting surveys, collecting customer feedback, and gathering market research with high completion rates.</div>
          </div>
        </div>

        <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:14px">
          <button id="cancelAiTemplateBtn" class="btn--muted">Close</button>
        </div>
      </div>
    </div>

    <div id="aiAgentModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div class="ai-agent-modal-card" style="background:#fff;padding:14px;border-radius:10px;width:320px;max-width:92%;max-height:92vh;overflow:auto">
        <h3 style="margin:0 0 10px 0" id="aiAgentModalTitle">ü§ñ Create AI Agent</h3>
        <div style="margin-bottom:8px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Agent Name *</label>
          <input id="aiAgentName" type="text" placeholder="e.g. Support Agent" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:8px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Greeting</label>
          <textarea id="aiAgentGreeting" rows="2" placeholder="What should the agent say when answering?" style="width:100%;box-sizing:border-box"></textarea>
        </div>
        <div style="margin-bottom:8px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Cartesia Voice</label>
          <div style="display:flex;gap:6px;align-items:center">
            <select id="aiAgentCartesiaVoiceSelect" style="flex:1;min-width:0">
              <option value="">Default voice</option>
              <option value="__custom__">Custom voice id‚Ä¶</option>
            </select>
            <button id="aiLoadVoicesBtn" type="button" class="btn--muted">Load Voices</button>
          </div>
          <div id="aiAgentCartesiaVoiceCustomWrap" style="display:none;margin-top:6px">
            <input id="aiAgentCartesiaVoiceCustom" type="text" placeholder="Paste Cartesia voice_id" style="width:100%;box-sizing:border-box">
          </div>
          <div class="muted" style="margin-top:4px">Leave as Default to use the voice configured in your agent image.</div>
        </div>
        <div style="margin-bottom:8px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Background Audio (WAV)</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="aiAgentBackgroundAudioFile" type="file" accept=".wav,audio/wav,audio/x-wav" style="flex:1;min-width:200px">
            <button id="aiRemoveBackgroundAudioBtn" type="button" class="btn--muted" style="display:none">Remove upload</button>
            <span class="muted" style="font-size:12px">Volume</span>
            <input id="aiAgentBackgroundAudioGain" type="number" min="0" max="0.2" step="0.01" placeholder="0.06" style="width:86px;box-sizing:border-box">
          </div>
          <div id="aiAgentBackgroundAudioFileName" class="muted" style="margin-top:4px">No file uploaded.</div>
          <div style="margin-top:6px">
            <input id="aiAgentBackgroundAudioUrl" type="url" placeholder="https://.../office.wav" style="width:100%;box-sizing:border-box">
          </div>
          <div class="muted" style="margin-top:4px">Uploaded WAV overrides the URL (URL acts as a fallback).</div>
        </div>
        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Custom Prompt</label>
          <textarea id="aiAgentPrompt" rows="4" placeholder="Instructions for the agent..." style="width:100%;box-sizing:border-box"></textarea>
        </div>
        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Transfer Destination (optional)</label>
          <input id="aiAgentTransferNumber" type="text" placeholder="Leave blank to use default (Tools ‚Üí Call Transfer)" style="width:100%;box-sizing:border-box">
          <div class="muted" style="margin-top:4px">Overrides the default transfer destination for this agent only.</div>
        </div>
        <div style="margin-bottom:10px;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.12);background:rgba(0,0,0,.03)">
          <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;font-size:13px;font-weight:700">
            <input id="aiAgentInboundTransferEnabled" type="checkbox"> <span>üì≤ Direct Transfer on Inbound Calls</span>
          </label>
          <div class="muted" style="margin-bottom:6px;font-size:12px">When enabled, inbound calls to this agent's number will be immediately transferred without the AI answering.</div>
          <input id="aiAgentInboundTransferNumber" type="text" placeholder="E.164 format like +18005551234" style="width:100%;box-sizing:border-box" disabled>
          <div class="muted" style="margin-top:4px;font-size:11px">The number to transfer inbound calls to (required when enabled).</div>
        </div>
        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Default Document Template</label>
          <select id="aiAgentDefaultTemplateSelect" style="width:100%;box-sizing:border-box">
            <option value="">None</option>
          </select>
          <div class="muted" style="margin-top:4px">Used when the agent emails a document to a caller.</div>
        </div>
        <input type="hidden" id="aiAgentId">
        <div style="display:flex;gap:6px;justify-content:flex-end">
          <button id="cancelAiAgentBtn" class="btn--muted">Cancel</button>
          <button id="confirmAiAgentBtn" class="btn--primary">Save Agent</button>
        </div>
      </div>
    </div>

    <!-- AI Email Preview Modal -->
    <div id="aiEmailPreviewModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div style="background:#fff;padding:16px;border-radius:12px;width:860px;max-width:95%;max-height:92vh;overflow:auto">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <h3 style="margin:0">‚úâÔ∏è Email Preview</h3>
          <div style="margin-left:auto"></div>
          <button id="closeAiEmailPreviewBtn" type="button" class="btn--muted">Close</button>
        </div>
        <div id="aiEmailPreviewMeta" class="muted" style="margin-bottom:10px">Loading‚Ä¶</div>

        <div id="aiEmailPreviewAttachments" style="display:none;margin-bottom:12px">
          <div class="muted" style="margin-bottom:6px">Attachments</div>
          <ul id="aiEmailPreviewAttachmentsList" style="margin:0;padding-left:18px"></ul>
        </div>

        <div id="aiEmailPreviewRenderedWrap" style="display:none;margin-bottom:12px">
          <div class="muted" style="margin-bottom:6px">Rendered preview</div>
          <iframe id="aiEmailPreviewIframe" sandbox="" referrerpolicy="no-referrer" style="width:100%;height:420px;border:1px solid #e5e7eb;border-radius:12px;background:#ffffff"></iframe>
        </div>

        <div id="aiEmailPreviewTextWrap" style="display:none">
          <div class="muted" style="margin-bottom:6px">Text</div>
          <pre id="aiEmailPreviewText" style="margin:0;background:#0b1220;color:#e2e8f0;padding:10px;border-radius:12px;white-space:pre-wrap;max-height:360px;overflow:auto"></pre>
        </div>

        <div id="aiEmailPreviewEmpty" class="muted" style="display:none">No preview content captured for this email.</div>
      </div>
    </div>

    <!-- AI Tool: SMTP Modal -->
    <div id="aiToolSmtpModal" class="ai-tool-modal">
      <div class="ai-tool-modal-card">
        <div class="ai-tool-modal-header">
          <span class="ai-tool-modal-icon">‚úâÔ∏è</span>
          <span class="ai-tool-modal-title">Email (SMTP)</span>
          <button type="button" class="ai-tool-modal-close" onclick="closeToolModal('smtp')">&times;</button>
        </div>
        <div class="muted" style="margin-bottom:14px">Configure your SMTP server to send emails and documents to callers.</div>
        <div class="ai-tool-modal-body">
          <div class="ai-tool-modal-row">
            <div>
              <label>SMTP Host</label>
              <input id="smtpHost" type="text" placeholder="e.g. smtp.gmail.com">
            </div>
            <div>
              <label>Port</label>
              <input id="smtpPort" type="number" placeholder="e.g. 587">
            </div>
          </div>
          <div>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input id="smtpSecure" type="checkbox"> <span>Use SSL (secure)</span>
            </label>
          </div>
          <div class="ai-tool-modal-row">
            <div>
              <label>Username</label>
              <input id="smtpUsername" type="text" placeholder="Username">
            </div>
            <div>
              <label>Password</label>
              <input id="smtpPassword" type="password" placeholder="Leave blank to keep current">
            </div>
          </div>
          <div class="ai-tool-modal-row">
            <div>
              <label>From Email</label>
              <input id="smtpFromEmail" type="email" placeholder="you@domain.com">
            </div>
            <div>
              <label>From Name</label>
              <input id="smtpFromName" type="text" placeholder="Optional">
            </div>
          </div>
          <div class="ai-tool-modal-row">
            <div>
              <label>Reply-To</label>
              <input id="smtpReplyTo" type="email" placeholder="Optional">
            </div>
            <div>
              <label>Test Recipient</label>
              <input id="smtpTestToEmail" type="email" placeholder="Optional">
            </div>
          </div>
        </div>
        <div class="ai-tool-modal-footer">
          <span id="smtpStatus" class="muted" style="margin-right:auto"></span>
          <button id="testSmtpBtn" class="btn--muted">Send Test</button>
          <button id="saveSmtpBtn" class="btn--primary">Save</button>
        </div>
      </div>
    </div>

    <!-- AI Tool: Call Transfer Modal -->
    <div id="aiToolTransferModal" class="ai-tool-modal">
      <div class="ai-tool-modal-card">
        <div class="ai-tool-modal-header">
          <span class="ai-tool-modal-icon">üìû</span>
          <span class="ai-tool-modal-title">Call Transfer</span>
          <button type="button" class="ai-tool-modal-close" onclick="closeToolModal('transfer')">&times;</button>
        </div>
        <div class="muted" style="margin-bottom:14px">Set the default transfer destination for AI agents. You can override this per agent in the agent editor.</div>
        <div class="ai-tool-modal-body">
          <div>
            <label>Transfer Destination</label>
            <input id="aiTransferNumber" type="text" placeholder="E.164 format like +18005551234 or sip:agent@domain">
          </div>
        </div>
        <div class="ai-tool-modal-footer">
          <span id="aiTransferStatus" class="muted" style="margin-right:auto"></span>
          <button id="saveAiTransferBtn" class="btn--primary">Save</button>
        </div>
      </div>
    </div>

    <!-- AI Tool: SMS Modal -->
    <div id="aiToolSmsModal" class="ai-tool-modal">
      <div class="ai-tool-modal-card">
        <div class="ai-tool-modal-header">
          <span class="ai-tool-modal-icon">üí¨</span>
          <span class="ai-tool-modal-title">SMS</span>
          <button type="button" class="ai-tool-modal-close" onclick="closeToolModal('sms')">&times;</button>
        </div>
        <div class="muted" style="margin-bottom:14px">Configure which phone numbers your AI agents can use to send SMS messages.</div>
        <div class="ai-tool-modal-body">
          <div>
            <label>Allowed Outbound SMS DIDs</label>
            <select id="aiSmsAllowedDidIds" multiple size="5" style="width:100%;box-sizing:border-box"></select>
            <div class="muted" style="margin-top:4px;font-size:11px">Hold Ctrl (Windows) / ‚åò (Mac) to select multiple.</div>
          </div>
          <div>
            <label>Default Outbound DID</label>
            <select id="aiSmsDefaultDidId" style="width:100%;box-sizing:border-box">
              <option value="">Auto (first allowed)</option>
            </select>
          </div>
        </div>
        <div class="ai-tool-modal-footer">
          <span id="aiSmsSettingsStatus" class="muted" style="margin-right:auto"></span>
          <button id="saveAiSmsSettingsBtn" class="btn--primary">Save</button>
        </div>
      </div>
    </div>

    <!-- AI Tool: Mail Modal -->
    <div id="aiToolMailModal" class="ai-tool-modal">
      <div class="ai-tool-modal-card">
        <div class="ai-tool-modal-header">
          <span class="ai-tool-modal-icon">üì¨</span>
          <span class="ai-tool-modal-title">Mail (Return Address)</span>
          <button type="button" class="ai-tool-modal-close" onclick="closeToolModal('mail')">&times;</button>
        </div>
        <div class="muted" style="margin-bottom:14px">Set the return address for physical mail sent via USPS.</div>
        <div class="ai-tool-modal-body">
          <div class="ai-tool-modal-row">
            <div>
              <label>Name</label>
              <input id="mailFromName" type="text" placeholder="Optional">
            </div>
            <div>
              <label>Organization</label>
              <input id="mailFromOrg" type="text" placeholder="Optional">
            </div>
          </div>
          <div>
            <label>Address Line 1 *</label>
            <input id="mailFromAddress1" type="text" placeholder="Street address">
          </div>
          <div>
            <label>Address Line 2</label>
            <input id="mailFromAddress2" type="text" placeholder="Optional">
          </div>
          <div class="ai-tool-modal-row">
            <div>
              <label>City *</label>
              <input id="mailFromCity" type="text" placeholder="City">
            </div>
            <div>
              <label>State *</label>
              <input id="mailFromState" type="text" placeholder="State">
            </div>
          </div>
          <div class="ai-tool-modal-row">
            <div>
              <label>ZIP *</label>
              <input id="mailFromPostal" type="text" placeholder="ZIP code">
            </div>
            <div>
              <label>Country</label>
              <select id="mailFromCountry">
                <option value="US">US</option>
              </select>
            </div>
          </div>
        </div>
        <div class="ai-tool-modal-footer">
          <span id="mailSettingsStatus" class="muted" style="margin-right:auto"></span>
          <button id="saveMailSettingsBtn" class="btn--primary">Save</button>
        </div>
      </div>
    </div>

    <!-- AI Tool: Document Templates Modal -->
    <div id="aiToolDocTemplatesModal" class="ai-tool-modal">
      <div class="ai-tool-modal-card" style="width:520px">
        <div class="ai-tool-modal-header">
          <span class="ai-tool-modal-icon">üìÑ</span>
          <span class="ai-tool-modal-title">Document Templates</span>
          <button type="button" class="ai-tool-modal-close" onclick="closeToolModal('doctemplates')">&times;</button>
        </div>
        <div class="muted" style="margin-bottom:14px">Upload .docx files with placeholders like <code>[[Name]]</code> and <code>[[Address]]</code>.</div>
        <div class="ai-tool-modal-body">
          <div class="ai-tool-modal-row">
            <div>
              <label>Template Name</label>
              <input id="docTemplateName" type="text" placeholder="e.g. Welcome Letter">
            </div>
            <div>
              <label>File (.docx)</label>
              <input id="docTemplateFile" type="file" accept=".docx">
            </div>
          </div>
          <div style="text-align:right">
            <button id="uploadDocTemplateBtn" class="btn--primary">Upload Template</button>
          </div>
          <div style="border-top:1px solid rgba(0,0,0,.10);padding-top:14px;margin-top:6px">
            <label style="margin-bottom:8px;display:block">Uploaded Templates</label>
            <table id="ai-doc-templates-table" style="display:none">
              <thead><tr><th>Name</th><th>File</th><th>Updated</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-doc-templates-empty" class="muted">No templates uploaded yet.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Tool: Square Payments Modal -->
    <div id="aiToolSquareModal" class="ai-tool-modal">
      <div class="ai-tool-modal-card" style="width:520px">
        <div class="ai-tool-modal-header">
          <span class="ai-tool-modal-icon">üü¶</span>
          <span class="ai-tool-modal-title">Square Payments</span>
          <button type="button" class="ai-tool-modal-close" onclick="closeToolModal('square')">&times;</button>
        </div>
        <div class="muted" style="margin-bottom:14px">Connect your Square account so your AI agent can send payment links to callers.</div>
        <div class="ai-tool-modal-body">
          <div class="ai-tool-modal-row">
            <div style="flex:1">
              <label>Access Token *</label>
              <input id="squareAccessToken" type="password" placeholder="sq0atp-...">
            </div>
          </div>
          <div class="ai-tool-modal-row">
            <div>
              <label>Location ID <span class="muted">(optional)</span></label>
              <input id="squareLocationId" type="text" placeholder="Leave blank to use default">
            </div>
            <div>
              <label>Environment</label>
              <select id="squareEnvironment">
                <option value="production">Production</option>
                <option value="sandbox">Sandbox (Testing)</option>
              </select>
            </div>
          </div>
          <div style="border-top:1px solid rgba(0,0,0,.10);padding-top:14px;margin-top:14px">
            <label style="margin-bottom:6px;display:block">Webhook URL <span class="muted">(for payment status updates)</span></label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="squareWebhookUrl" type="text" readonly style="flex:1;background:rgba(0,0,0,.2);cursor:text">
              <button type="button" class="btn--secondary" onclick="copySquareWebhookUrl()" style="white-space:nowrap">Copy</button>
            </div>
            <div class="muted" style="font-size:11px;margin-top:6px">Add this URL in Square Dashboard ‚Üí Webhooks. Subscribe to: <code>payment.completed</code>, <code>payment.failed</code>, <code>order.updated</code></div>
          </div>
        </div>
        <div class="ai-tool-modal-footer">
          <span id="squareSettingsStatus" class="muted" style="margin-right:auto"></span>
          <button id="saveSquareSettingsBtn" class="btn--primary">Save</button>
        </div>
      </div>
    </div>

    <!-- AI Tool: Stripe Payments Modal -->
    <div id="aiToolStripeModal" class="ai-tool-modal">
      <div class="ai-tool-modal-card" style="width:520px">
        <div class="ai-tool-modal-header">
          <span class="ai-tool-modal-icon">üí≥</span>
          <span class="ai-tool-modal-title">Stripe Payments</span>
          <button type="button" class="ai-tool-modal-close" onclick="closeToolModal('stripe')">&times;</button>
        </div>
        <div class="muted" style="margin-bottom:14px">Connect your Stripe account so your AI agent can send payment links to callers.</div>
        <div class="ai-tool-modal-body">
          <div class="ai-tool-modal-row">
            <div style="flex:1">
              <label>Secret Key *</label>
              <input id="stripeSecretKey" type="password" placeholder="sk_live_... or sk_test_...">
            </div>
          </div>
          <div class="muted" style="font-size:12px;margin-top:8px">Use a test key (sk_test_...) for testing, or a live key (sk_live_...) for production payments.</div>
          <div style="border-top:1px solid rgba(0,0,0,.10);padding-top:14px;margin-top:14px">
            <label style="margin-bottom:6px;display:block">Webhook URL <span class="muted">(for payment status updates)</span></label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="stripeWebhookUrl" type="text" readonly style="flex:1;background:rgba(0,0,0,.2);cursor:text">
              <button type="button" class="btn--secondary" onclick="copyStripeWebhookUrl()" style="white-space:nowrap">Copy</button>
            </div>
            <div class="muted" style="font-size:11px;margin-top:6px">Add this URL in Stripe Dashboard ‚Üí Webhooks. Subscribe to: <code>checkout.session.completed</code>, <code>checkout.session.expired</code></div>
          </div>
        </div>
        <div class="ai-tool-modal-footer">
          <span id="stripeSettingsStatus" class="muted" style="margin-right:auto"></span>
          <button id="saveStripeSettingsBtn" class="btn--primary">Save</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const CHECKOUT_MIN_AMOUNT = <%= typeof checkoutMinAmount !== 'undefined' ? checkoutMinAmount : 100 %>;
    const CHECKOUT_MAX_AMOUNT = <%= typeof checkoutMaxAmount !== 'undefined' ? checkoutMaxAmount : 500 %>;
    const ADD_FUNDS_METHODS = <%- JSON.stringify(Array.isArray(addFundsMethods) ? addFundsMethods : []) %>;
    const DEFAULT_FUND_METHOD = <%- JSON.stringify(typeof defaultFundMethod !== 'undefined' ? defaultFundMethod : null) %>;
    const HAS_ADD_FUNDS_METHODS = <%= hasAddFundsMethods ? 'true' : 'false' %>;
    const ADD_FUNDS_METHOD_LABELS = (ADD_FUNDS_METHODS || []).reduce((acc, m) => {
      if (m && m.value) acc[String(m.value)] = String(m.label || m.value);
      return acc;
    }, {});
    const LOCAL_DID_MARKUP = <%= typeof localDidMarkup !== 'undefined' ? localDidMarkup : 10.20 %>;
    const TOLLFREE_DID_MARKUP = <%= typeof tollfreeDidMarkup !== 'undefined' ? tollfreeDidMarkup : 25.20 %>;
    const AI_LOCAL_DID_FEE = <%= typeof aiLocalDidFee !== 'undefined' ? aiLocalDidFee : 10.20 %>;
    const AI_TOLLFREE_DID_FEE = <%= typeof aiTollfreeDidFee !== 'undefined' ? aiTollfreeDidFee : 25.20 %>;
    const $ = (s)=>document.querySelector(s);
    let meProfile = null;
    var billingPage = 0;
    var billingPageSize = 20;
    let billingData = [];
    const tabs = {overview:$('#tab-overview'), profile:$('#tab-profile'), dialer:$('#tab-dialer'), billing:$('#tab-billing'), ai:$('#tab-ai'), cdr:$('#tab-cdr')};
    const views = {overview:$('#view-overview'), profile:$('#view-profile'), dialer:$('#view-dialer'), billing:$('#view-billing'), ai:$('#view-ai'), cdr:$('#view-cdr')};
    function activate(name){
      Object.keys(tabs).forEach(k=>{ tabs[k].classList.toggle('active',k===name); views[k].style.display = (k===name?'block':'none'); });
    }

    // AI submenu tabs
    const aiSubtabs = {
      agents: document.getElementById('ai-subtab-agents'),
      conversations: document.getElementById('ai-subtab-conversations'),
      'outbound-conversations': document.getElementById('ai-subtab-outbound-conversations'),
      emails: document.getElementById('ai-subtab-emails'),
      sms: document.getElementById('ai-subtab-sms'),
      meetings: document.getElementById('ai-subtab-meetings'),
      mail: document.getElementById('ai-subtab-mail'),
      payments: document.getElementById('ai-subtab-payments'),
      tools: document.getElementById('ai-subtab-tools'),
    };
    const aiPanes = {
      agents: document.getElementById('ai-pane-agents'),
      conversations: document.getElementById('ai-pane-conversations'),
      'outbound-conversations': document.getElementById('ai-pane-outbound-conversations'),
      emails: document.getElementById('ai-pane-emails'),
      sms: document.getElementById('ai-pane-sms'),
      meetings: document.getElementById('ai-pane-meetings'),
      mail: document.getElementById('ai-pane-mail'),
      payments: document.getElementById('ai-pane-payments'),
      tools: document.getElementById('ai-pane-tools'),
    };

    function activateAiSubtab(name){
      const n = String(name || '').toLowerCase();
      const active = (n === 'tools' || n === 'conversations' || n === 'outbound-conversations' || n === 'emails' || n === 'sms' || n === 'meetings' || n === 'mail' || n === 'payments') ? n : 'agents';
      Object.keys(aiSubtabs).forEach(k => {
        const el = aiSubtabs[k];
        if (!el) return;
        el.classList.toggle('active', k === active);
      });
      Object.keys(aiPanes).forEach(k => {
        const el = aiPanes[k];
        if (!el) return;
        el.style.display = (k === active) ? 'block' : 'none';
      });
    }

    if (aiSubtabs.agents) {
      aiSubtabs.agents.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('agents');
        loadAiAgents();
        loadAiNumbers();
      });
    }
    if (aiSubtabs.tools) {
      aiSubtabs.tools.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('tools');
        refreshToolCardStatuses();
      });
    }
    if (aiSubtabs.conversations) {
      aiSubtabs.conversations.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('conversations');
        openAiConversationsTab();
      });
    }
    if (aiSubtabs['outbound-conversations']) {
      aiSubtabs['outbound-conversations'].addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('outbound-conversations');
        openAiOutboundConversationsTab();
      });
    }
    if (aiSubtabs.emails) {
      aiSubtabs.emails.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('emails');
        openAiEmailsTab();
      });
    }
    if (aiSubtabs.sms) {
      aiSubtabs.sms.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('sms');
        openAiSmsTab();
      });
    }
    if (aiSubtabs.meetings) {
      aiSubtabs.meetings.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('meetings');
        openAiMeetingsTab();
      });
    }
    if (aiSubtabs.mail) {
      aiSubtabs.mail.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('mail');
        openAiMailTab();
      });
    }
    if (aiSubtabs.payments) {
      aiSubtabs.payments.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('payments');
        openAiPaymentsTab();
      });
    }
    tabs.overview.addEventListener('click',e=>{e.preventDefault();activate('overview');loadStats();});
    tabs.profile.addEventListener('click',e=>{e.preventDefault();activate('profile');loadProfile();});
    tabs.dialer.addEventListener('click',e=>{e.preventDefault();activate('dialer');openDialerTab();});
    tabs.billing.addEventListener('click',e=>{e.preventDefault();activate('billing');billingPage=0;loadBillingHistory();});
    tabs.ai.addEventListener('click',e=>{e.preventDefault();activate('ai');activateAiSubtab('agents');loadAiAgents();loadAiNumbers();});
    tabs.cdr.addEventListener('click',e=>{e.preventDefault();activate('cdr');cdrPage=0;loadCdr();});

    // ========== Outbound Dialer ==========
    let dialerUiInit = false;
    let dialerCampaigns = [];
    let dialerPage = 0;
    const dialerPageSize = 25;
    let dialerTotal = 0;
    let dialerUploadCampaignId = null;

    function setDialerStatus(msg, isError){
      const el = $('#dialerStatus');
      if (!el) return;
      el.textContent = msg || '';
      el.style.color = isError ? '#dc2626' : '#64748b';
    }

    function dialerStatusBadge(status){
      const s = String(status || 'draft').toLowerCase();
      const cls = {
        running: 'dialer-status-running',
        paused: 'dialer-status-paused',
        completed: 'dialer-status-completed',
        draft: 'dialer-status-draft'
      }[s] || 'dialer-status-draft';
      return `<span class="dialer-status-badge ${cls}">${escapeHtml(s)}</span>`;
    }

    function dialerNumber(val){
      const num = Number(val || 0);
      if (!Number.isFinite(num)) return '0';
      return num.toLocaleString();
    }

    function dialerStatsChips(stats, campaignId){
      const s = stats || {};
      const cid = campaignId ? escapeHtml(String(campaignId)) : '';
      return [
        { label: 'Pending', value: s.pending, status: 'pending', clickable: true },
        { label: 'Live', value: s.inProgress, status: 'inprogress', clickable: true },
        { label: 'Done', value: s.completed, status: 'done', clickable: true },
        { label: 'Failed', value: s.failed, status: 'failed', clickable: true },
        { label: 'Voicemail', value: s.voicemail, status: 'voicemail', clickable: true },
        { label: 'Transferred', value: s.transferred, status: 'transferred', clickable: true }
      ].map(item => {
        const dataAttrs = item.clickable && cid ? `data-leads-status="${item.status}" data-leads-campaign="${cid}"` : '';
        const cursorStyle = item.clickable && cid ? 'cursor:pointer;' : '';
        return `<span class="dialer-chip" ${dataAttrs} style="${cursorStyle}"><strong>${dialerNumber(item.value)}</strong> ${escapeHtml(item.label)}</span>`;
      }).join('');
    }

    function findDialerCampaign(id){
      const target = String(id || '');
      return dialerCampaigns.find(c => String(c.id) === target) || null;
    }

    function renderDialerCampaigns(){
      const table = $('#dialer-campaigns-table');
      const empty = $('#dialer-empty');
      const pager = $('#dialer-pager');
      const pageInfo = $('#dialerPageInfo');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!dialerCampaigns.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        empty.textContent = 'No campaigns yet. Click ‚ÄúCreate Campaign‚Äù.';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        return;
      }

      table.style.display = 'table';
      empty.style.display = 'none';

      const renderedTotal = typeof dialerTotal === 'number' ? dialerTotal : dialerCampaigns.length;
      const totalPages = Math.max(1, Math.ceil(renderedTotal / dialerPageSize));
      if (pager) pager.style.display = totalPages > 1 ? 'flex' : 'none';
      if (pageInfo) pageInfo.textContent = totalPages > 1 ? `Page ${dialerPage + 1} of ${totalPages}` : '';

      for (const c of dialerCampaigns){
        const stats = c.stats || {};
        const updatedAt = c.updated_at ? new Date(c.updated_at).toLocaleString() : '‚Äî';
        const hasAudio = c.has_campaign_audio || false;
        const aiName = c.ai_agent_name ? escapeHtml(c.ai_agent_name) : (c.ai_agent_id ? `Agent ${c.ai_agent_id}` : (hasAudio ? 'üîä Audio Only' : '‚Äî'));
        const leadsSummary = `${dialerNumber(stats.completed)} / ${dialerNumber(stats.totalLeads)} completed`;
        const actions = [];
        actions.push(`<button class="btn--muted" data-dialer-action="upload" data-id="${escapeHtml(String(c.id))}">Upload CSV</button>`);
        if (String(c.status) === 'running'){
          actions.push(`<button class="btn--warning" data-dialer-action="pause" data-id="${escapeHtml(String(c.id))}">Pause</button>`);
        } else if (String(c.status) === 'completed'){
          // no start button
        } else {
          actions.push(`<button class="btn--success" data-dialer-action="start" data-id="${escapeHtml(String(c.id))}">Start</button>`);
        }
        if (String(c.status) !== 'completed'){
          actions.push(`<button data-dialer-action="complete" data-id="${escapeHtml(String(c.id))}">Mark Complete</button>`);
        }
        actions.push(`<button class="btn--danger" data-dialer-action="delete" data-id="${escapeHtml(String(c.id))}">Delete</button>`);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div style="font-weight:700">${escapeHtml(c.name || '')}</div>
            <div class="muted" style="font-size:11px">Updated ${escapeHtml(updatedAt)}</div>
            <div class="dialer-chip-grid">${dialerStatsChips(stats, c.id)}</div>
            <div class="dialer-chip-hint">Click on counts to view lead details</div>
          </td>
          <td>${escapeHtml(aiName)}</td>
          <td>${escapeHtml(leadsSummary)}</td>
          <td>${dialerNumber(c.concurrency_limit || c.concurrency || 1)}</td>
          <td>${dialerStatusBadge(c.status)}</td>
          <td><div class="dialer-actions">${actions.join(' ')}</div></td>`;
        tbody.appendChild(tr);
      }
    }

    async function loadDialerCampaigns(){
      const empty = $('#dialer-empty');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      setDialerStatus('Loading campaigns‚Ä¶');
      try {
        const r = await fetch(`/api/me/dialer/campaigns?page=${dialerPage}&pageSize=${dialerPageSize}`);
        const j = await r.json();
        if (!r.ok || !j || j.success === false){
          throw new Error(j?.message || 'Failed to load campaigns');
        }
        dialerCampaigns = Array.isArray(j.data) ? j.data : grabRows(j);
        dialerTotal = typeof j.total === 'number' ? j.total : dialerCampaigns.length;
        renderDialerCampaigns();
        if (dialerCampaigns.length){
          setDialerStatus(`Showing ${dialerCampaigns.length} campaign${dialerCampaigns.length === 1 ? '' : 's'}.`);
        } else {
          setDialerStatus('Create your first campaign to begin.');
        }
      } catch (err) {
        console.error('[dialer.load]', err);
        dialerCampaigns = [];
        renderDialerCampaigns();
        setDialerStatus(err?.message || 'Failed to load campaigns', true);
        if (empty) empty.textContent = 'Failed to load campaigns.';
      }
    }

    async function ensureDialerAgentOptions(){
      if (!Array.isArray(aiAgentsData) || !aiAgentsData.length){
        try { await loadAiAgents(); } catch (e) { console.warn('[dialer] loadAiAgents failed', e); }
      }
    }


    function populateDialerAgentSelect(){
      const sel = $('#dialerAgentSelect');
      if (!sel) return;
      const prev = sel.value;
      sel.innerHTML = '';
      
      if (!Array.isArray(aiAgentsData) || !aiAgentsData.length){
        const opt = new Option('Create an AI agent first', '');
        opt.disabled = true;
        sel.appendChild(opt);
        sel.disabled = true;
        return;
      }
      
      sel.disabled = false;
      sel.appendChild(new Option('Select AI agent‚Ä¶', ''));
      
      for (const a of aiAgentsData){
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        sel.appendChild(new Option(a.display_name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => o.value === prev);
      sel.value = still ? prev : '';
    }


    async function openDialerCreateModal(){
      const modal = $('#dialerCreateModal');
      if (!modal) return;
      $('#dialerCampaignNameInput').value = '';
      $('#dialerCampaignAudioInput').value = '';
      $('#dialerConcurrencyInput').value = '1';
      $('#dialerConcurrencyValue').textContent = '1';
      const errorEl = $('#dialerCreateError');
      if (errorEl) { errorEl.style.display = 'none'; errorEl.textContent = ''; }
      try {
        await ensureDialerAgentOptions();
        populateDialerAgentSelect();
      } catch (e) {
        setDialerStatus(e?.message || 'Load AI agents first', true);
      }
      modal.style.display = 'flex';
      setTimeout(() => { try { $('#dialerCampaignNameInput').focus(); } catch {} }, 0);
    }

    function closeDialerCreateModal(){
      const modal = $('#dialerCreateModal');
      if (modal) modal.style.display = 'none';
    }

    async function submitDialerCreateForm(){
      const name = ($('#dialerCampaignNameInput').value || '').trim();
      const agentId = ($('#dialerAgentSelect').value || '').trim();
      const concurrency = parseInt($('#dialerConcurrencyInput').value || '1', 10) || 1;
      const audioFile = $('#dialerCampaignAudioInput').files ? $('#dialerCampaignAudioInput').files[0] : null;
      const errorEl = $('#dialerCreateError');
      
      if (!name){
        if (errorEl){
          errorEl.textContent = 'Campaign name is required.';
          errorEl.style.display = 'block';
        }
        return;
      }
      
      if (!agentId){
        if (errorEl){
          errorEl.textContent = 'AI agent is required (even for audio-only campaigns).';
          errorEl.style.display = 'block';
        }
        return;
      }

      const btn = $('#dialerSaveCampaignBtn');
      if (btn){
        btn.disabled = true;
        btn.textContent = 'Saving...';
      }
      setDialerStatus('Creating campaign‚Ä¶');

      try {
        const payload = {
          name,
          ai_agent_id: agentId,
          concurrency_limit: concurrency
        };
        
        const r = await fetch('/api/me/dialer/campaigns', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!r.ok || !j || j.success === false){
          throw new Error(j?.message || 'Failed to create campaign');
        }
        
        const newId = j && j.data && j.data.id != null ? String(j.data.id) : '';
        
        // Upload audio if provided
        if (audioFile && newId) {
          if (btn) btn.textContent = 'Uploading audio...';
          try {
            const fd = new FormData();
            fd.append('audio', audioFile);
            const audioR = await fetch(`/api/me/dialer/campaigns/${encodeURIComponent(newId)}/audio`, {
              method: 'POST',
              body: fd
            });
            const audioJ = await audioR.json();
            if (!audioR.ok || !audioJ || audioJ.success === false){
              throw new Error(audioJ?.message || 'Failed to upload audio');
            }
            showToast('Campaign created with audio.');
          } catch (audioErr) {
            console.error('[dialer.audio]', audioErr);
            showToast(`Campaign created but audio upload failed: ${audioErr?.message || 'Unknown error'}`, 'error');
          }
        } else {
          showToast('Campaign created.');
        }
        
        closeDialerCreateModal();
        await loadDialerCampaigns();
        if (newId){
          openDialerUploadModal(newId);
        }
      } catch (err) {
        if (errorEl){
          errorEl.textContent = err?.message || 'Failed to create campaign.';
          errorEl.style.display = 'block';
        }
        setDialerStatus(err?.message || 'Failed to create campaign', true);
      } finally {
        if (btn){
          btn.disabled = false;
          btn.textContent = 'Save Campaign';
        }
      }
    }

    function openDialerUploadModal(campaignId){
      const modal = $('#dialerUploadModal');
      if (!modal) return;
      dialerUploadCampaignId = campaignId ? String(campaignId) : '';
      const row = findDialerCampaign(dialerUploadCampaignId);
      const nameEl = $('#dialerUploadCampaignName');
      if (nameEl) nameEl.textContent = row ? (row.name || `Campaign ${row.id}`) : `Campaign ${dialerUploadCampaignId || ''}`;
      const statusEl = $('#dialerUploadStatus');
      if (statusEl) { statusEl.textContent = ''; statusEl.style.color = '#475569'; }
      const fileInput = $('#dialerUploadFile');
      if (fileInput) fileInput.value = '';
      modal.style.display = 'flex';
    }

    function closeDialerUploadModal(){
      const modal = $('#dialerUploadModal');
      if (modal) modal.style.display = 'none';
      dialerUploadCampaignId = null;
    }

    async function submitDialerUploadForm(){
      const statusEl = $('#dialerUploadStatus');
      const btn = $('#dialerUploadSubmitBtn');
      if (!dialerUploadCampaignId){
        if (statusEl){ statusEl.textContent = 'Select a campaign first.'; statusEl.style.color = '#b91c1c'; }
        return;
      }
      const fileInput = $('#dialerUploadFile');
      const file = fileInput && fileInput.files ? fileInput.files[0] : null;
      if (!file){
        if (statusEl){ statusEl.textContent = 'Choose a CSV file to upload.'; statusEl.style.color = '#b91c1c'; }
        return;
      }
      if (statusEl){ statusEl.textContent = 'Uploading‚Ä¶'; statusEl.style.color = '#475569'; }
      if (btn){ btn.disabled = true; btn.textContent = 'Uploading...'; }
      try {
        const fd = new FormData();
        fd.append('file', file);
        const r = await fetch(`/api/me/dialer/campaigns/${encodeURIComponent(dialerUploadCampaignId)}/leads-upload`, {
          method: 'POST',
          body: fd
        });
        const j = await r.json();
        if (!r.ok || !j || j.success === false){
          throw new Error(j?.message || 'Failed to upload leads');
        }
        const inserted = j && j.data ? Number(j.data.inserted || 0) : 0;
        const duplicates = j && j.data ? Number(j.data.duplicates || 0) : 0;
        const invalid = j && j.data ? Number(j.data.invalid || 0) : 0;
        if (statusEl){
          statusEl.textContent = `Inserted ${inserted}, duplicates ${duplicates}, invalid ${invalid}.`;
          statusEl.style.color = '#10b981';
        }
        showToast(`Uploaded ${inserted} lead${inserted === 1 ? '' : 's'}.`);
        await loadDialerCampaigns();
      } catch (err) {
        if (statusEl){
          statusEl.textContent = err?.message || 'Upload failed.';
          statusEl.style.color = '#b91c1c';
        }
      } finally {
        if (btn){ btn.disabled = false; btn.textContent = 'Upload Leads'; }
      }
    }

    async function updateDialerCampaignStatus(id, action){
      setDialerStatus('Updating campaign‚Ä¶');
      try {
        const r = await fetch(`/api/me/dialer/campaigns/${encodeURIComponent(id)}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        });
        const j = await r.json();
        if (!r.ok || !j || j.success === false){
          throw new Error(j?.message || 'Failed to update status');
        }
        showToast(`Campaign ${action}ed.`);
        await loadDialerCampaigns();
      } catch (err) {
        setDialerStatus(err?.message || 'Failed to update status', true);
        showToast(err?.message || 'Failed to update status', 'error');
      }
    }

    async function deleteDialerCampaign(id){
      if (!confirm('Delete this campaign? This action cannot be undone.')) return;
      setDialerStatus('Deleting campaign‚Ä¶');
      try {
        const r = await fetch(`/api/me/dialer/campaigns/${encodeURIComponent(id)}`, { method: 'DELETE' });
        const j = await r.json();
        if (!r.ok || !j || j.success === false){
          throw new Error(j?.message || 'Failed to delete campaign');
        }
        showToast('Campaign deleted.');
        await loadDialerCampaigns();
      } catch (err) {
        setDialerStatus(err?.message || 'Failed to delete campaign', true);
        showToast(err?.message || 'Failed to delete campaign', 'error');
      }
    }

    // ========== Dialer Leads by Status ==========
    let dialerLeadsCampaignId = null;
    let dialerLeadsStatus = null;
    let dialerLeadsPage = 0;
    const dialerLeadsPageSize = 50;
    let dialerLeadsTotal = 0;
    let dialerLeadsData = [];

    function openDialerLeadsModal(campaignId, status){
      dialerLeadsCampaignId = campaignId;
      dialerLeadsStatus = status;
      dialerLeadsPage = 0;
      dialerLeadsData = [];
      dialerLeadsTotal = 0;
      const modal = $('#dialerLeadsModal');
      if (!modal) return;
      const campaign = findDialerCampaign(campaignId);
      const campaignName = campaign ? (campaign.name || `Campaign ${campaignId}`) : `Campaign ${campaignId}`;
      const statusLabel = { pending: 'Pending', inprogress: 'Live', done: 'Done', failed: 'Failed', voicemail: 'Voicemail', transferred: 'Transferred' }[status] || status;
      $('#dialerLeadsModalTitle').textContent = `üìû ${statusLabel} Leads`;
      $('#dialerLeadsModalSubtitle').textContent = campaignName;
      $('#dialerLeadsStatus').textContent = 'Loading‚Ä¶';
      $('#dialerLeadsTable').querySelector('tbody').innerHTML = '';
      $('#dialerLeadsEmpty').style.display = 'none';
      $('#dialerLeadsPager').style.display = 'none';
      modal.style.display = 'flex';
      loadDialerLeadsByStatus();
    }

    function closeDialerLeadsModal(){
      const modal = $('#dialerLeadsModal');
      if (modal) modal.style.display = 'none';
      dialerLeadsCampaignId = null;
      dialerLeadsStatus = null;
    }

    async function loadDialerLeadsByStatus(){
      const statusEl = $('#dialerLeadsStatus');
      if (statusEl) statusEl.textContent = 'Loading‚Ä¶';
      try {
        const url = `/api/me/dialer/campaigns/${encodeURIComponent(dialerLeadsCampaignId)}/leads-by-status?status=${encodeURIComponent(dialerLeadsStatus)}&page=${dialerLeadsPage}&pageSize=${dialerLeadsPageSize}`;
        const r = await fetch(url);
        const j = await r.json();
        if (!r.ok || !j || j.success === false){
          throw new Error(j?.message || 'Failed to load leads');
        }
        dialerLeadsData = Array.isArray(j.data) ? j.data : [];
        dialerLeadsTotal = typeof j.total === 'number' ? j.total : dialerLeadsData.length;
        renderDialerLeadsTable();
        if (statusEl) statusEl.textContent = dialerLeadsTotal ? `${dialerLeadsTotal} lead${dialerLeadsTotal === 1 ? '' : 's'} found.` : '';
      } catch (err) {
        console.error('[dialer.leads]', err);
        dialerLeadsData = [];
        renderDialerLeadsTable();
        if (statusEl) { statusEl.textContent = err?.message || 'Failed to load leads'; statusEl.style.color = '#f87171'; }
      }
    }

    function renderDialerLeadsTable(){
      const table = $('#dialerLeadsTable');
      const empty = $('#dialerLeadsEmpty');
      const pager = $('#dialerLeadsPager');
      const pageInfo = $('#dialerLeadsPageInfo');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!dialerLeadsData.length){
        table.style.display = 'none';
        if (empty) empty.style.display = 'block';
        if (pager) pager.style.display = 'none';
        return;
      }

      table.style.display = 'table';
      if (empty) empty.style.display = 'none';

      const totalPages = Math.max(1, Math.ceil(dialerLeadsTotal / dialerLeadsPageSize));
      if (pager) pager.style.display = totalPages > 1 ? 'flex' : 'none';
      if (pageInfo) pageInfo.textContent = totalPages > 1 ? `Page ${dialerLeadsPage + 1} of ${totalPages}` : '';

      for (const lead of dialerLeadsData){
        const phone = lead.phone_number || '‚Äî';
        const name = lead.lead_name || '‚Äî';
        const result = lead.call_result || lead.status || '‚Äî';
        const duration = lead.duration_sec != null ? `${lead.duration_sec}s` : '‚Äî';
        const attempts = lead.attempt_count != null ? lead.attempt_count : '‚Äî';
        const lastCall = lead.last_call_at ? new Date(lead.last_call_at).toLocaleString() : '‚Äî';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-family:monospace">${escapeHtml(phone)}</td>
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(result)}</td>
          <td>${escapeHtml(duration)}</td>
          <td>${escapeHtml(String(attempts))}</td>
          <td>${escapeHtml(lastCall)}</td>`;
        tbody.appendChild(tr);
      }
    }

    function initDialerLeadsUi(){
      const closeBtn = $('#dialerLeadsCloseBtn');
      if (closeBtn) closeBtn.addEventListener('click', (e) => { e.preventDefault(); closeDialerLeadsModal(); });

      const modal = $('#dialerLeadsModal');
      if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeDialerLeadsModal(); });

      const prevBtn = $('#dialerLeadsPrev');
      if (prevBtn) prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (dialerLeadsPage > 0){
          dialerLeadsPage -= 1;
          loadDialerLeadsByStatus();
        }
      });

      const nextBtn = $('#dialerLeadsNext');
      if (nextBtn) nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if ((dialerLeadsPage + 1) * dialerLeadsPageSize < dialerLeadsTotal){
          dialerLeadsPage += 1;
          loadDialerLeadsByStatus();
        }
      });
    }

    function initDialerUi(){
      if (dialerUiInit) return;
      dialerUiInit = true;

      const createBtn = $('#dialerCreateBtn');
      if (createBtn) createBtn.addEventListener('click', (e) => { e.preventDefault(); openDialerCreateModal(); });

      const refreshBtn = $('#dialerRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadDialerCampaigns(); });

      const cancelCreateBtn = $('#dialerCancelCreateBtn');
      if (cancelCreateBtn) cancelCreateBtn.addEventListener('click', (e) => { e.preventDefault(); closeDialerCreateModal(); });

      const saveCampaignBtn = $('#dialerSaveCampaignBtn');
      if (saveCampaignBtn) saveCampaignBtn.addEventListener('click', (e) => { e.preventDefault(); submitDialerCreateForm(); });

      const createModal = $('#dialerCreateModal');
      if (createModal) createModal.addEventListener('click', (e) => { if (e.target === createModal) closeDialerCreateModal(); });

      const uploadCloseBtn = $('#dialerUploadCloseBtn');
      if (uploadCloseBtn) uploadCloseBtn.addEventListener('click', (e) => { e.preventDefault(); closeDialerUploadModal(); });

      const uploadSubmitBtn = $('#dialerUploadSubmitBtn');
      if (uploadSubmitBtn) uploadSubmitBtn.addEventListener('click', (e) => { e.preventDefault(); submitDialerUploadForm(); });

      const uploadModal = $('#dialerUploadModal');
      if (uploadModal) uploadModal.addEventListener('click', (e) => { if (e.target === uploadModal) closeDialerUploadModal(); });

      const concurrencyInput = $('#dialerConcurrencyInput');
      if (concurrencyInput){
        concurrencyInput.addEventListener('input', () => {
          const out = $('#dialerConcurrencyValue');
          if (out) out.textContent = concurrencyInput.value;
        });
      }

      const table = $('#dialer-campaigns-table');
      if (table){
        table.addEventListener('click', (e) => {
          // Handle status chip clicks for viewing leads
          const chip = e.target.closest?.('[data-leads-status]');
          if (chip){
            const campaignId = chip.getAttribute('data-leads-campaign');
            const status = chip.getAttribute('data-leads-status');
            if (campaignId && status){
              openDialerLeadsModal(campaignId, status);
              return;
            }
          }
          // Handle action button clicks
          const btn = e.target.closest?.('[data-dialer-action]');
          if (!btn) return;
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-dialer-action');
          if (!id || !action) return;
          if (action === 'upload'){
            openDialerUploadModal(id);
          } else if (action === 'start' || action === 'pause' || action === 'complete'){
            updateDialerCampaignStatus(id, action);
          } else if (action === 'delete'){
            deleteDialerCampaign(id);
          }
        });
      }

      initDialerLeadsUi();

      const prevBtn = $('#dialerPrev');
      if (prevBtn) prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (dialerPage > 0){
          dialerPage -= 1;
          loadDialerCampaigns();
        }
      });

      const nextBtn = $('#dialerNext');
      if (nextBtn) nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const renderedTotal = typeof dialerTotal === 'number' ? dialerTotal : dialerCampaigns.length;
        if ((dialerPage + 1) * dialerPageSize < renderedTotal){
          dialerPage += 1;
          loadDialerCampaigns();
        }
      });
    }

    function openDialerTab(){
      initDialerUi();
      loadDialerCampaigns();
      ensureDialerAgentOptions().then(populateDialerAgentSelect).catch(() => {});
    }
    function grabRows(payload){
      const d = (payload && typeof payload === 'object') ? (payload.data ?? payload) : payload;
      if (Array.isArray(d)) return d;
      if (d && Array.isArray(d.items)) return d.items;
      if (d && Array.isArray(d.rows)) return d.rows;
      if (payload && Array.isArray(payload.rows)) return payload.rows;
      if (Array.isArray(payload)) return payload;
      return [];
    }

    // ========== Phone.System ==========
    let phonesystemUiInit = false;
    let phonesystemCustomers = [];
    let phonesystemDidOptions = [];
    let phonesystemSipOptions = [];

    function setPhoneSystemStatus(msg, isError){
      const el = $('#phonesystem-status');
      if (!el) return;
      el.textContent = msg || '';
      el.style.color = isError ? '#dc2626' : '#64748b';
    }

    async function psFetchJson(url, opts){
      const r = await fetch(url, opts);
      const j = await r.json().catch(() => null);
      if (!r.ok || !j || j.success === false) {
        const msg = j?.message || `Request failed (${r.status})`;
        const e = new Error(msg);
        e.status = r.status;
        e.body = j;
        throw e;
      }
      return j;
    }

    function getSelectValues(sel){
      if (!sel) return [];
      return Array.from(sel.selectedOptions || []).map(o => String(o.value || '').trim()).filter(Boolean);
    }

    function buildDidOptionsInto(selectEl){
      if (!selectEl) return;
      selectEl.innerHTML = '';
      const rows = Array.isArray(phonesystemDidOptions) ? phonesystemDidOptions : [];
      if (!rows.length) {
        const opt = new Option('No numbers found in My Numbers', '');
        opt.disabled = true;
        selectEl.appendChild(opt);
        selectEl.disabled = true;
        return;
      }
      selectEl.disabled = false;
      for (const r of rows) {
        const id = String(r.didww_did_id || '').trim();
        const num = String(r.did_number || '').trim();
        if (!id) continue;
        selectEl.appendChild(new Option(num || id, id));
      }
    }

    function buildSipOptionsInto(selectEl){
      if (!selectEl) return;
      const prev = String(selectEl.value || '').trim();
      selectEl.innerHTML = '';
      selectEl.appendChild(new Option('Select SIP account‚Ä¶', ''));
      const rows = Array.isArray(phonesystemSipOptions) ? phonesystemSipOptions : [];
      for (const r of rows) {
        const id = String(r.id || '').trim();
        const username = String(r.username || '').trim();
        if (!id) continue;
        selectEl.appendChild(new Option(username || `SIP ${id}`, id));
      }
      const still = Array.from(selectEl.options || []).some(o => String(o.value) === prev);
      selectEl.value = still ? prev : '';
    }

    function renderPhoneSystemCustomers(){
      const table = $('#phonesystem-customers-table');
      const empty = $('#phonesystem-customers-empty');
      const count = $('#phonesystemCustomersCount');
      if (!table || !empty) return;

      const rows = Array.isArray(phonesystemCustomers) ? phonesystemCustomers : [];
      if (count) count.textContent = rows.length ? `(${rows.length})` : '';

      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!rows.length) {
        table.style.display = 'none';
        empty.style.display = 'block';
        empty.textContent = 'No Phone.System customers yet.';
        return;
      }

      for (const c of rows) {
        const name = String(c.name || '').trim() || '‚Äî';
        const cid = String(c.tc_customer_id || '').trim();
        const domain = String(c.domain || '').trim();
        const didCount = (c.did_count != null && Number.isFinite(Number(c.did_count))) ? Number(c.did_count) : 0;

        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = name;
        tr.appendChild(tdName);

        const tdId = document.createElement('td');
        tdId.textContent = cid || '‚Äî';
        tr.appendChild(tdId);

        const tdDomain = document.createElement('td');
        tdDomain.textContent = domain || '‚Äî';
        tr.appendChild(tdDomain);

        const tdDids = document.createElement('td');
        tdDids.textContent = String(didCount);
        tr.appendChild(tdDids);

        const tdAssign = document.createElement('td');
        const ddAssign = document.createElement('details');
        ddAssign.className = 'ps-dd';
        const sumAssign = document.createElement('summary');
        sumAssign.textContent = 'Assign DIDs';
        ddAssign.appendChild(sumAssign);
        const panelAssign = document.createElement('div');
        panelAssign.className = 'ps-dd-panel';
        const didSelect = document.createElement('select');
        didSelect.multiple = true;
        didSelect.size = 6;
        didSelect.className = 'ps-row-did-select';
        didSelect.setAttribute('data-id', cid);
        buildDidOptionsInto(didSelect);
        panelAssign.appendChild(didSelect);
        const assignBtn = document.createElement('button');
        assignBtn.className = 'btn--primary ps-assign-dids';
        assignBtn.textContent = 'Assign';
        assignBtn.setAttribute('data-id', cid);
        assignBtn.disabled = !domain;
        panelAssign.appendChild(assignBtn);
        const assignHint = document.createElement('div');
        assignHint.className = 'muted';
        assignHint.textContent = domain ? 'Hold Ctrl (Windows) to multi-select.' : 'Trunk domain not ready yet. Try Refresh.';
        panelAssign.appendChild(assignHint);
        ddAssign.appendChild(panelAssign);
        tdAssign.appendChild(ddAssign);
        tr.appendChild(tdAssign);

        const tdOutbound = document.createElement('td');
        const ddOut = document.createElement('details');
        ddOut.className = 'ps-dd';
        const sumOut = document.createElement('summary');
        sumOut.textContent = 'Outbound';
        ddOut.appendChild(sumOut);
        const panelOut = document.createElement('div');
        panelOut.className = 'ps-dd-panel';
        const sipSelect = document.createElement('select');
        sipSelect.className = 'ps-row-sip-select';
        sipSelect.setAttribute('data-id', cid);
        buildSipOptionsInto(sipSelect);
        panelOut.appendChild(sipSelect);
        const outBtn = document.createElement('button');
        outBtn.className = 'btn--primary ps-config-outbound';
        outBtn.textContent = 'Configure';
        outBtn.setAttribute('data-id', cid);
        panelOut.appendChild(outBtn);
        const outHint = document.createElement('div');
        outHint.className = 'muted';
        outHint.textContent = 'Caller ID selection is managed inside phone.systems UI.';
        panelOut.appendChild(outHint);
        ddOut.appendChild(panelOut);
        tdOutbound.appendChild(ddOut);
        tr.appendChild(tdOutbound);

        const tdActions = document.createElement('td');
        const actions = document.createElement('div');
        actions.className = 'ps-actions';

        const openBtn = document.createElement('button');
        openBtn.className = 'btn--success ps-open-ui';
        openBtn.textContent = 'Open';
        openBtn.setAttribute('data-id', cid);
        actions.appendChild(openBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn--danger ps-delete';
        delBtn.textContent = 'Delete';
        delBtn.setAttribute('data-id', cid);
        actions.appendChild(delBtn);

        tdActions.appendChild(actions);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';
    }

    async function loadPhoneSystemCustomers(){
      const table = $('#phonesystem-customers-table');
      const empty = $('#phonesystem-customers-empty');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';

      try {
        const j = await psFetchJson('/api/me/phonesystem/customers');
        phonesystemCustomers = Array.isArray(j.data) ? j.data : [];
        renderPhoneSystemCustomers();
      } catch (e) {
        phonesystemCustomers = [];
        renderPhoneSystemCustomers();
        if (empty) {
          empty.style.display = 'block';
          empty.textContent = e?.message || 'Failed to load customers';
        }
      }
    }

    async function loadPhoneSystemDidOptions(){
      try {
        const j = await psFetchJson('/api/me/phonesystem/did-options');
        phonesystemDidOptions = Array.isArray(j.data) ? j.data : [];
      } catch {
        phonesystemDidOptions = [];
      }
    }

    async function loadPhoneSystemSipOptions(){
      try {
        const j = await psFetchJson('/api/me/phonesystem/sip-options');
        phonesystemSipOptions = Array.isArray(j.data) ? j.data : [];
      } catch {
        phonesystemSipOptions = [];
      }
    }

    async function createPhoneSystemCustomer(){
      const btn = $('#phonesystemCreateCustomerBtn');
      const input = $('#phonesystemNewCustomerName');
      const name = input ? String(input.value || '').trim() : '';

      if (!name) {
        setPhoneSystemStatus('Customer name is required.', true);
        showToast('Customer name is required.', 'error');
        if (input && input.focus) input.focus();
        return;
      }

      if (btn) btn.disabled = true;
      setPhoneSystemStatus('Creating customer‚Ä¶', false);

      try {
        await psFetchJson('/api/me/phonesystem/customers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });

        if (input) input.value = '';
        setPhoneSystemStatus('Customer created.', false);
        showToast('Phone.System customer created.');
        await openPhoneSystemTab();
      } catch (e) {
        setPhoneSystemStatus(e?.message || 'Failed to create customer', true);
        showToast(e?.message || 'Failed to create customer', 'error');
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function assignPhoneSystemDids(customerId, didIds){
      const id = String(customerId || '').trim();
      if (!id) return;
      const list = Array.isArray(didIds) ? didIds : [];
      if (!list.length) {
        setPhoneSystemStatus('Select at least one DID to assign.', true);
        return;
      }

      setPhoneSystemStatus('Assigning DIDs‚Ä¶', false);

      try {
        const j = await psFetchJson(`/api/me/phonesystem/customers/${encodeURIComponent(id)}/dids`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ did_ids: list })
        });

        const created = Array.isArray(j?.data?.created) ? j.data.created : [];
        const errors = Array.isArray(j?.data?.errors) ? j.data.errors : [];

        if (errors.length) {
          showToast(`Assigned ${created.length}. Errors: ${errors.length}.`, 'error');
        } else {
          showToast(`Assigned ${created.length} DID(s) and updated forwarding.`);
        }

        setPhoneSystemStatus('DID assignment complete.', errors.length > 0);
        await openPhoneSystemTab();
      } catch (e) {
        setPhoneSystemStatus(e?.message || 'Failed to assign DIDs', true);
        showToast(e?.message || 'Failed to assign DIDs', 'error');
      }
    }

    async function configurePhoneSystemOutbound(customerId, sipId){
      const id = String(customerId || '').trim();
      const sip = String(sipId || '').trim();
      if (!id) return;
      if (!sip) {
        setPhoneSystemStatus('Select a SIP account first.', true);
        return;
      }

      setPhoneSystemStatus('Configuring outbound‚Ä¶', false);

      try {
        await psFetchJson(`/api/me/phonesystem/customers/${encodeURIComponent(id)}/outbound`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sip_id: sip })
        });

        setPhoneSystemStatus('Outbound configured.', false);
        showToast('Outbound termination configured.');
      } catch (e) {
        setPhoneSystemStatus(e?.message || 'Failed to configure outbound', true);
        showToast(e?.message || 'Failed to configure outbound', 'error');
      }
    }

    async function openPhoneSystemUi(customerId){
      const id = String(customerId || '').trim();
      if (!id) return;

      setPhoneSystemStatus('Creating session‚Ä¶', false);

      try {
        const j = await psFetchJson(`/api/me/phonesystem/customers/${encodeURIComponent(id)}/session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const uri = String(j?.data?.uri || '').trim();
        if (!uri) throw new Error('No session URL returned');

        showLinkToast('phone.systems session is ready.', 'Open phone.systems', uri, 'success');
        try { window.open(uri, '_blank', 'noopener'); } catch {}
        setPhoneSystemStatus('Session ready.', false);
      } catch (e) {
        setPhoneSystemStatus(e?.message || 'Failed to create session', true);
        showToast(e?.message || 'Failed to create session', 'error');
      }
    }

    async function deletePhoneSystemCustomer(customerId){
      const id = String(customerId || '').trim();
      if (!id) return;

      const ok = confirm(
        'Delete this Phone.System customer?\n\n' +
        'This will delete the customer in telecom.center AND remove all local Phone.System settings.\n' +
        'Inbound forwarding for numbers that are currently routed to this customer will be unassigned.'
      );
      if (!ok) return;

      setPhoneSystemStatus('Deleting customer‚Ä¶', false);

      try {
        const j = await psFetchJson(`/api/me/phonesystem/customers/${encodeURIComponent(id)}`, { method: 'DELETE' });
        const unassigned = (j && j.data && Number.isFinite(Number(j.data.didww_unassigned))) ? Number(j.data.didww_unassigned) : 0;
        const failed = (j && j.data && Number.isFinite(Number(j.data.didww_unassign_failed))) ? Number(j.data.didww_unassign_failed) : 0;

        const msg = failed
          ? `Customer deleted. DIDWW unassigned: ${unassigned}. Failed: ${failed}.`
          : `Customer deleted. DIDWW unassigned: ${unassigned}.`;

        setPhoneSystemStatus(msg, failed > 0);
        showToast(failed ? 'Customer deleted (with some unassign warnings).' : 'Customer deleted.');
        await openPhoneSystemTab();
      } catch (e) {
        setPhoneSystemStatus(e?.message || 'Failed to delete customer', true);
        showToast(e?.message || 'Failed to delete customer', 'error');
      }
    }

    function initPhoneSystemUI(){
      if (phonesystemUiInit) return;
      phonesystemUiInit = true;

      const refreshBtn = $('#phonesystemRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => {
        e.preventDefault();
        openPhoneSystemTab();
      });

      const createBtn = $('#phonesystemCreateCustomerBtn');
      if (createBtn) createBtn.addEventListener('click', (e) => {
        e.preventDefault();
        createPhoneSystemCustomer();
      });

      const nameInput = $('#phonesystemNewCustomerName');
      if (nameInput) nameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          createPhoneSystemCustomer();
        }
      });

      document.addEventListener('click', async (ev) => {
        const t = ev.target;
        if (!t || !t.classList) return;

        if (t.classList.contains('ps-assign-dids')) {
          ev.preventDefault();
          const id = String(t.getAttribute('data-id') || '').trim();
          const wrap = t.closest('.ps-dd') || t.parentElement;
          const sel = wrap ? wrap.querySelector('select.ps-row-did-select') : null;
          const didIds = getSelectValues(sel);
          t.disabled = true;
          try { await assignPhoneSystemDids(id, didIds); } finally { t.disabled = false; }
          return;
        }

        if (t.classList.contains('ps-config-outbound')) {
          ev.preventDefault();
          const id = String(t.getAttribute('data-id') || '').trim();
          const wrap = t.closest('.ps-dd') || t.parentElement;
          const sel = wrap ? wrap.querySelector('select.ps-row-sip-select') : null;
          const sipId = sel ? String(sel.value || '').trim() : '';
          t.disabled = true;
          try { await configurePhoneSystemOutbound(id, sipId); } finally { t.disabled = false; }
          return;
        }

        if (t.classList.contains('ps-open-ui')) {
          ev.preventDefault();
          const id = String(t.getAttribute('data-id') || '').trim();
          t.disabled = true;
          try { await openPhoneSystemUi(id); } finally { t.disabled = false; }
          return;
        }

        if (t.classList.contains('ps-delete')) {
          ev.preventDefault();
          const id = String(t.getAttribute('data-id') || '').trim();
          t.disabled = true;
          try { await deletePhoneSystemCustomer(id); } finally { t.disabled = false; }
          return;
        }
      });
    }

    async function openPhoneSystemTab(){
      initPhoneSystemUI();
      setPhoneSystemStatus('Loading‚Ä¶', false);

      try {
        await Promise.all([
          loadPhoneSystemDidOptions(),
          loadPhoneSystemSipOptions(),
          loadPhoneSystemCustomers()
        ]);

        // Customers depend on did/sip options for per-row selects.
        renderPhoneSystemCustomers();
        setPhoneSystemStatus('', false);
      } catch (e) {
        setPhoneSystemStatus(e?.message || 'Failed to load Phone.System data', true);
      }
    }

    // ========== AI Agents ==========
    let aiAgentsData = [];
    let aiNumbersData = [];
    let cartesiaVoicesLoaded = false;

    // AI email + doc templates
    let smtpHasPassword = false;
    let docTemplatesData = [];

    // AI Conversations
    let aiConvUiInit = false;
    let aiConvPage = 0;
    const aiConvPageSize = 25;
    let aiConvTotal = 0;
    let aiConvSessionsData = [];
    let aiConvSelected = null; // { call_id, call_domain }

    // AI Outbound Conversations
    let aiOutboundConvUiInit = false;
    let aiOutboundConvPage = 0;
    const aiOutboundConvPageSize = 25;
    let aiOutboundConvTotal = 0;
    let aiOutboundConvSessionsData = [];
    let aiOutboundConvSelected = null; // { call_id, call_domain }

    // AI Meetings
    let aiMeetingsUiInit = false;
    let aiMeetingsPage = 0;
    const aiMeetingsPageSize = 25;
    let aiMeetingsTotal = 0;
    let aiMeetingsData = [];

    // AI Emails
    let aiEmailsUiInit = false;
    let aiEmailsPage = 0;
    const aiEmailsPageSize = 25;
    let aiEmailsTotal = 0;
    let aiEmailsData = [];

    // AI SMS
    let aiSmsUiInit = false;
    let aiSmsPage = 0;
    const aiSmsPageSize = 25;
    let aiSmsTotal = 0;
    let aiSmsData = [];

    // AI Tools: SMS settings
    let aiSmsDidOptions = [];
    let aiSmsSettings = { allowedDidIds: [], defaultDidId: '' };

    // AI Mail
    let aiMailUiInit = false;
    let aiMailPage = 0;
    const aiMailPageSize = 25;
    let aiMailTotal = 0;
    let aiMailData = [];

    function fmtDateTime(val){
      if (!val) return '';
      try {
        const d = new Date(val);
        if (!Number.isNaN(d.getTime())) return d.toLocaleString();
      } catch {}
      return String(val);
    }

    function clearAiConvMessages(msg){
      const box = $('#aiConvMessages');
      const empty = $('#aiConvMessagesEmpty');
      const meta = $('#aiConvSessionMeta');
      if (box) box.innerHTML = '';
      if (meta) meta.textContent = '';
      if (empty) {
        empty.style.display = 'block';
        empty.textContent = msg || 'Select a session to view the transcript.';
      }
    }

    function renderAiConvAgentFilter(){
      const sel = $('#aiConvAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function initAiConversationsUI(){
      if (aiConvUiInit) return;
      aiConvUiInit = true;

      const refreshBtn = $('#aiConvRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiConversationSessions(); });

      const agentSel = $('#aiConvAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiConvPage = 0;
        aiConvSelected = null;
        clearAiConvMessages();
        loadAiConversationSessions();
      });

      const prev = $('#aiConvPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiConvPage > 0) {
          aiConvPage -= 1;
          loadAiConversationSessions();
        }
      });

      const next = $('#aiConvNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiConvPage + 1) * aiConvPageSize < aiConvTotal) {
          aiConvPage += 1;
          loadAiConversationSessions();
        }
      });

      document.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!t || !t.classList || !t.classList.contains('ai-conv-open')) return;
        ev.preventDefault();
        const callId = String(t.getAttribute('data-call-id') || '');
        const callDomain = String(t.getAttribute('data-call-domain') || '');
        const found = (aiConvSessionsData || []).find(s => String(s.call_id || '') === callId && String(s.call_domain || '') === callDomain);
        if (found) {
          selectAiConversationSession(found);
        } else if (callId && callDomain) {
          selectAiConversationSession({ call_id: callId, call_domain: callDomain });
        }
      });
    }

    async function openAiConversationsTab(){
      initAiConversationsUI();

      // Populate agent filter
      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiConvAgentFilter();

      // Load sessions
      loadAiConversationSessions();
    }

    // ========== AI Outbound Conversations ==========
    function clearAiOutboundConvMessages(msg){
      const box = $('#aiOutboundConvMessages');
      const empty = $('#aiOutboundConvMessagesEmpty');
      const meta = $('#aiOutboundConvSessionMeta');
      if (box) box.innerHTML = '';
      if (meta) meta.textContent = '';
      if (empty) {
        empty.style.display = 'block';
        empty.textContent = msg || 'Select a session to view the transcript.';
      }
    }

    function renderAiOutboundConvAgentFilter(){
      const sel = $('#aiOutboundConvAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function initAiOutboundConversationsUI(){
      if (aiOutboundConvUiInit) return;
      aiOutboundConvUiInit = true;

      const refreshBtn = $('#aiOutboundConvRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiOutboundConversationSessions(); });

      const agentSel = $('#aiOutboundConvAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiOutboundConvPage = 0;
        aiOutboundConvSelected = null;
        clearAiOutboundConvMessages();
        loadAiOutboundConversationSessions();
      });

      const prev = $('#aiOutboundConvPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiOutboundConvPage > 0) {
          aiOutboundConvPage -= 1;
          loadAiOutboundConversationSessions();
        }
      });

      const next = $('#aiOutboundConvNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiOutboundConvPage + 1) * aiOutboundConvPageSize < aiOutboundConvTotal) {
          aiOutboundConvPage += 1;
          loadAiOutboundConversationSessions();
        }
      });

      document.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!t || !t.classList || !t.classList.contains('ai-outbound-conv-open')) return;
        ev.preventDefault();
        const callId = String(t.getAttribute('data-call-id') || '');
        const callDomain = String(t.getAttribute('data-call-domain') || '');
        const found = (aiOutboundConvSessionsData || []).find(s => String(s.call_id || '') === callId && String(s.call_domain || '') === callDomain);
        if (found) {
          selectAiOutboundConversationSession(found);
        } else if (callId && callDomain) {
          selectAiOutboundConversationSession({ call_id: callId, call_domain: callDomain });
        }
      });
    }

    async function openAiOutboundConversationsTab(){
      initAiOutboundConversationsUI();

      // Populate agent filter
      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiOutboundConvAgentFilter();

      // Load sessions
      loadAiOutboundConversationSessions();
    }

    // ========== AI Meetings ==========
    function renderAiMeetingsAgentFilter(){
      const sel = $('#aiMeetingsAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function renderAiMeetingsSendAgentSelect(){
      const sel = $('#aiMeetingsSendAgentId');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('Select agent‚Ä¶', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';

      // Default the send-agent to the current filter selection (if any)
      // only when a send-agent isn't already selected.
      if (!sel.value) {
        const filterSel = $('#aiMeetingsAgentFilter');
        const filterVal = filterSel ? String(filterSel.value || '').trim() : '';
        if (filterVal && Array.from(sel.options || []).some(o => String(o.value) === filterVal)) {
          sel.value = filterVal;
        }
      }
    }

    function setAiMeetingsSendStatus(msg, isError){
      const el = $('#aiMeetingsSendStatus');
      if (!el) return;
      el.textContent = msg || '';
      el.style.color = isError ? '#b91c1c' : '#6b7280';
    }

    async function sendAiMeetingLink(){
      const btn = $('#aiMeetingsSendBtn');
      const agentSel = $('#aiMeetingsSendAgentId');
      const emailEl = $('#aiMeetingsSendEmail');
      const subjectEl = $('#aiMeetingsSendSubject');

      const agentId = agentSel ? String(agentSel.value || '').trim() : '';
      const toEmail = emailEl ? String(emailEl.value || '').trim() : '';
      const subject = subjectEl ? String(subjectEl.value || '').trim() : '';

      if (!agentId) {
        setAiMeetingsSendStatus('Select an agent.', true);
        return;
      }
      if (!toEmail) {
        setAiMeetingsSendStatus('Enter a caller email.', true);
        return;
      }

      if (btn) btn.disabled = true;
      setAiMeetingsSendStatus('Sending‚Ä¶', false);

      let clientRequestId = '';
      try {
        clientRequestId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : '';
      } catch {}
      if (!clientRequestId) {
        clientRequestId = `req_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      }

      try {
        const payload = {
          agent_id: agentId,
          to_email: toEmail,
          subject: subject || undefined,
          client_request_id: clientRequestId
        };

        const r = await fetch('/api/me/ai/meetings/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const j = await r.json().catch(() => null);
        if (!r.ok || !j || j.success === false) {
          setAiMeetingsSendStatus(j?.message || 'Failed to send meeting link', true);
          return;
        }

        setAiMeetingsSendStatus(j.already_sent ? 'Already sent.' : 'Sent.', false);
        if (j.join_url || j.room_url) {
          const url = String(j.join_url || j.room_url);
          showLinkToast('Meeting link ready.', 'Open meeting', url, 'success');
        }
        aiMeetingsPage = 0;
        loadAiMeetings();
      } catch (e) {
        setAiMeetingsSendStatus('Failed to send meeting link', true);
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function initAiMeetingsUI(){
      if (aiMeetingsUiInit) return;
      aiMeetingsUiInit = true;

      const refreshBtn = $('#aiMeetingsRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiMeetings(); });

      const agentSel = $('#aiMeetingsAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiMeetingsPage = 0;
        renderAiMeetingsSendAgentSelect();
        loadAiMeetings();
      });

      const sendBtn = $('#aiMeetingsSendBtn');
      if (sendBtn) sendBtn.addEventListener('click', (e) => { e.preventDefault(); sendAiMeetingLink(); });

      const sendEmail = $('#aiMeetingsSendEmail');
      if (sendEmail) sendEmail.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendAiMeetingLink();
        }
      });

      const prev = $('#aiMeetingsPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiMeetingsPage > 0) {
          aiMeetingsPage -= 1;
          loadAiMeetings();
        }
      });

      const next = $('#aiMeetingsNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiMeetingsPage + 1) * aiMeetingsPageSize < aiMeetingsTotal) {
          aiMeetingsPage += 1;
          loadAiMeetings();
        }
      });
    }

    async function openAiMeetingsTab(){
      initAiMeetingsUI();

      // Populate agent filter
      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiMeetingsAgentFilter();
      renderAiMeetingsSendAgentSelect();

      loadAiMeetings();
    }

    function renderAiMeetings(){
      const table = $('#ai-meetings-table');
      const empty = $('#ai-meetings-empty');
      const pager = $('#ai-meetings-pager');
      const pageInfo = $('#aiMeetingsPageInfo');
      const prev = $('#aiMeetingsPrev');
      const next = $('#aiMeetingsNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiMeetingsData || !aiMeetingsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No meetings yet.';
        return;
      }

      for (const m of aiMeetingsData) {
        const sent = m.created_at ? fmtDateTime(m.created_at) : '';
        const to = String(m.to_email || '-');
        const agentName = String(m.agent_name || '-');
        const url = String(m.meeting_join_url || m.meeting_room_url || '');
        const statusRaw = String(m.meeting_status || '').toLowerCase();
        const label = statusRaw === 'live' ? 'Live' : statusRaw === 'ended' ? 'Ended' : 'Unknown';

        const tr = document.createElement('tr');

        const tdSent = document.createElement('td');
        tdSent.textContent = sent;
        tr.appendChild(tdSent);

        const tdTo = document.createElement('td');
        tdTo.textContent = to;
        tr.appendChild(tdTo);

        const tdAgent = document.createElement('td');
        tdAgent.textContent = agentName;
        tr.appendChild(tdAgent);

        const tdLink = document.createElement('td');
        if (url) {
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = 'Open';
          tdLink.appendChild(a);
        } else {
          tdLink.textContent = '-';
        }
        tr.appendChild(tdLink);

        const tdStatus = document.createElement('td');
        tdStatus.textContent = label;
        tdStatus.style.fontWeight = '600';
        tdStatus.style.color = (statusRaw === 'live') ? '#16a34a' : '#6b7280';
        tr.appendChild(tdStatus);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiMeetingsTotal > 0 ? Math.max(1, Math.ceil(aiMeetingsTotal / aiMeetingsPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiMeetingsPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiMeetingsTotal > aiMeetingsPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiMeetingsPage <= 0);
      if (next) next.disabled = ((aiMeetingsPage + 1) * aiMeetingsPageSize >= aiMeetingsTotal);
    }

    async function loadAiMeetings(){
      const table = $('#ai-meetings-table');
      const empty = $('#ai-meetings-empty');
      const pager = $('#ai-meetings-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiMeetingsAgentFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const url = `/api/me/ai/meetings?page=${aiMeetingsPage}&pageSize=${aiMeetingsPageSize}` + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '');
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiMeetingsData = [];
          aiMeetingsTotal = 0;
          renderAiMeetings();
          if (empty) empty.textContent = j?.message || 'Failed to load meetings';
          return;
        }
        aiMeetingsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiMeetingsTotal = Number.isFinite(total) ? total : aiMeetingsData.length;

        // If current page is out of bounds (e.g. filter changed), jump back and refetch.
        if (aiMeetingsTotal > 0 && aiMeetingsPage > 0 && aiMeetingsPage * aiMeetingsPageSize >= aiMeetingsTotal) {
          aiMeetingsPage = 0;
          return loadAiMeetings();
        }

        renderAiMeetings();
      } catch (e) {
        aiMeetingsData = [];
        aiMeetingsTotal = 0;
        renderAiMeetings();
        if (empty) empty.textContent = 'Failed to load meetings';
      }
    }

    // ========== AI Emails ==========
    function renderAiEmailsAgentFilter(){
      const sel = $('#aiEmailsAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function aiEmailKindLabel(e){
      const hasMeeting = !!(e && (e.meeting_provider || e.meeting_room_url || e.meeting_join_url));
      if (hasMeeting) return 'Meeting';
      if (e && e.template_id != null) return 'Document';
      return 'Email';
    }

    function closeAiEmailPreview(){
      const modal = $('#aiEmailPreviewModal');
      if (modal) modal.style.display = 'none';

      const iframe = $('#aiEmailPreviewIframe');
      if (iframe) iframe.srcdoc = '';

      const meta = $('#aiEmailPreviewMeta');
      if (meta) meta.textContent = '';

      const attWrap = $('#aiEmailPreviewAttachments');
      if (attWrap) attWrap.style.display = 'none';
      const attList = $('#aiEmailPreviewAttachmentsList');
      if (attList) attList.innerHTML = '';

      const rend = $('#aiEmailPreviewRenderedWrap');
      if (rend) rend.style.display = 'none';
      const txtWrap = $('#aiEmailPreviewTextWrap');
      if (txtWrap) txtWrap.style.display = 'none';
      const txt = $('#aiEmailPreviewText');
      if (txt) txt.textContent = '';

      const empty = $('#aiEmailPreviewEmpty');
      if (empty) empty.style.display = 'none';
    }

    function openAiEmailPreviewModal(){
      const modal = $('#aiEmailPreviewModal');
      if (modal) modal.style.display = 'flex';
    }

    async function openAiEmailPreview(id){
      const modal = $('#aiEmailPreviewModal');
      const meta = $('#aiEmailPreviewMeta');
      const attWrap = $('#aiEmailPreviewAttachments');
      const attList = $('#aiEmailPreviewAttachmentsList');
      const rend = $('#aiEmailPreviewRenderedWrap');
      const iframe = $('#aiEmailPreviewIframe');
      const txtWrap = $('#aiEmailPreviewTextWrap');
      const txt = $('#aiEmailPreviewText');
      const empty = $('#aiEmailPreviewEmpty');

      openAiEmailPreviewModal();

      if (meta) meta.textContent = 'Loading‚Ä¶';
      if (attWrap) attWrap.style.display = 'none';
      if (attList) attList.innerHTML = '';
      if (rend) rend.style.display = 'none';
      if (iframe) iframe.srcdoc = '';
      if (txtWrap) txtWrap.style.display = 'none';
      if (txt) txt.textContent = '';
      if (empty) empty.style.display = 'none';

      try {
        const r = await fetch(`/api/me/ai/emails/${encodeURIComponent(String(id))}`);
        const j = await r.json().catch(() => null);
        if (!r.ok || !j || j.success === false) {
          if (meta) meta.textContent = j?.message || 'Failed to load email';
          if (empty) empty.style.display = 'block';
          return;
        }

        const e = j.data || {};

        const to = String(e.to_email || '-');
        const subj = String(e.subject || '-');
        const agentName = String(e.agent_name || '-');
        const sent = e.created_at ? fmtDateTime(e.created_at) : '';
        const statusRaw = String(e.status || '').toLowerCase() || 'unknown';
        const kind = aiEmailKindLabel(e);

        if (meta) {
          const parts = [];
          if (sent) parts.push(`Sent: ${sent}`);
          parts.push(`To: ${to}`);
          parts.push(`Agent: ${agentName}`);
          parts.push(`Subject: ${subj}`);
          parts.push(`Type: ${kind}`);
          parts.push(`Status: ${statusRaw}`);
          if (e.meeting_join_url || e.meeting_room_url) {
            parts.push(`Meeting: ${String(e.meeting_join_url || e.meeting_room_url)}`);
          }
          meta.textContent = parts.join(' ‚Ä¢ ');
        }

        // Attachments
        let attachments = [];
        const rawAtt = e.attachments_json;
        if (rawAtt) {
          try {
            attachments = Array.isArray(rawAtt) ? rawAtt : JSON.parse(String(rawAtt));
          } catch {
            attachments = [];
          }
        }
        if (Array.isArray(attachments) && attachments.length && attWrap && attList) {
          attList.innerHTML = '';
          for (const a of attachments) {
            const li = document.createElement('li');
            const fn = String(a?.filename || a?.name || 'attachment');
            const ct = String(a?.content_type || a?.contentType || '').trim();
            const sz = (a?.size_bytes != null && Number.isFinite(Number(a.size_bytes))) ? Number(a.size_bytes) : null;
            li.textContent = fn + (ct ? ` (${ct})` : '') + (sz != null ? ` ‚Ä¢ ${sz} bytes` : '');
            attList.appendChild(li);
          }
          attWrap.style.display = 'block';
        }

        // Email content (fallback for older rows)
        let emailText = (e.email_text != null) ? String(e.email_text) : '';
        let emailHtml = (e.email_html != null) ? String(e.email_html) : '';

        if (!emailText.trim() && !emailHtml.trim()) {
          const joinUrl = String(e.meeting_join_url || e.meeting_room_url || '').trim();
          if (joinUrl) {
            emailText = `Here is your video meeting link:\n\n${joinUrl}\n\nOpen it in your browser to join.`;
            emailHtml = `<div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;">`+
              `<p>Here is your video meeting link:</p>`+
              `<p><a href="${joinUrl}">${joinUrl}</a></p>`+
              `<p>Open it in your browser to join.</p>`+
              `</div>`;
          } else if (e.template_id != null) {
            emailText = 'Please find your document attached.';
          }
        }

        const hasHtml = !!emailHtml.trim();
        const hasText = !!emailText.trim();

        if (hasHtml && rend && iframe) {
          const doc = `<!doctype html><html><head><meta charset="utf-8">`+
            `<base target="_blank">`+
            `<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:12px;margin:0}</style>`+
            `</head><body>${emailHtml}</body></html>`;
          iframe.srcdoc = doc;
          rend.style.display = 'block';
        }

        if (hasText && txtWrap && txt) {
          txt.textContent = emailText;
          txtWrap.style.display = 'block';
        }

        if (!hasHtml && !hasText && empty) {
          empty.style.display = 'block';
        }
      } catch (e) {
        if (meta) meta.textContent = 'Failed to load email';
        if (empty) empty.style.display = 'block';
      }
    }

    function initAiEmailsUI(){
      if (aiEmailsUiInit) return;
      aiEmailsUiInit = true;

      const refreshBtn = $('#aiEmailsRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiEmails(); });

      const agentSel = $('#aiEmailsAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiEmailsPage = 0;
        loadAiEmails();
      });

      const statusSel = $('#aiEmailsStatusFilter');
      if (statusSel) statusSel.addEventListener('change', () => {
        aiEmailsPage = 0;
        loadAiEmails();
      });

      const prev = $('#aiEmailsPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiEmailsPage > 0) {
          aiEmailsPage -= 1;
          loadAiEmails();
        }
      });

      const next = $('#aiEmailsNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiEmailsPage + 1) * aiEmailsPageSize < aiEmailsTotal) {
          aiEmailsPage += 1;
          loadAiEmails();
        }
      });

      const closeBtn = $('#closeAiEmailPreviewBtn');
      if (closeBtn) closeBtn.addEventListener('click', (e) => { e.preventDefault(); closeAiEmailPreview(); });

      const modal = $('#aiEmailPreviewModal');
      if (modal) modal.addEventListener('click', (e) => {
        if (e && e.target === modal) closeAiEmailPreview();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeAiEmailPreview();
        }
      });

      document.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!t || !t.classList || !t.classList.contains('ai-email-preview')) return;
        ev.preventDefault();
        const id = String(t.getAttribute('data-id') || '').trim();
        if (id) openAiEmailPreview(id);
      });
    }

    async function openAiEmailsTab(){
      initAiEmailsUI();

      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiEmailsAgentFilter();

      loadAiEmails();
    }

    function renderAiEmails(){
      const table = $('#ai-emails-table');
      const empty = $('#ai-emails-empty');
      const pager = $('#ai-emails-pager');
      const pageInfo = $('#aiEmailsPageInfo');
      const prev = $('#aiEmailsPrev');
      const next = $('#aiEmailsNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiEmailsData || !aiEmailsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No emails yet.';
        return;
      }

      for (const e of aiEmailsData) {
        const sent = e.created_at ? fmtDateTime(e.created_at) : '';
        const to = String(e.to_email || '-');
        const agentName = String(e.agent_name || '-');
        const subj = String(e.subject || '-');
        const kind = aiEmailKindLabel(e);
        const statusRaw = String(e.status || e.email_status || '').toLowerCase();
        const statusLabel = statusRaw ? (statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1)) : 'Unknown';

        const tr = document.createElement('tr');

        const tdSent = document.createElement('td');
        tdSent.textContent = sent;
        tr.appendChild(tdSent);

        const tdTo = document.createElement('td');
        tdTo.textContent = to;
        tr.appendChild(tdTo);

        const tdAgent = document.createElement('td');
        tdAgent.textContent = agentName;
        tr.appendChild(tdAgent);

        const tdSubj = document.createElement('td');
        tdSubj.textContent = subj;
        tr.appendChild(tdSubj);

        const tdKind = document.createElement('td');
        tdKind.textContent = kind;
        tr.appendChild(tdKind);

        const tdStatus = document.createElement('td');
        tdStatus.textContent = statusLabel;
        tdStatus.style.fontWeight = '600';
        tdStatus.style.color = (statusRaw === 'completed') ? '#16a34a' : (statusRaw === 'failed' ? '#ef4444' : '#6b7280');
        if (e.error) tdStatus.title = String(e.error);
        tr.appendChild(tdStatus);

        const tdActions = document.createElement('td');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ai-email-preview';
        btn.setAttribute('data-id', String(e.id));
        btn.textContent = 'Preview';
        tdActions.appendChild(btn);

        const joinUrl = String(e.meeting_join_url || e.meeting_room_url || '').trim();
        if (joinUrl) {
          const spacer = document.createTextNode(' ');
          tdActions.appendChild(spacer);
          const a = document.createElement('a');
          a.href = joinUrl;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = 'Open link';
          tdActions.appendChild(a);
        }

        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiEmailsTotal > 0 ? Math.max(1, Math.ceil(aiEmailsTotal / aiEmailsPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiEmailsPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiEmailsTotal > aiEmailsPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiEmailsPage <= 0);
      if (next) next.disabled = ((aiEmailsPage + 1) * aiEmailsPageSize >= aiEmailsTotal);
    }

    async function loadAiEmails(){
      const table = $('#ai-emails-table');
      const empty = $('#ai-emails-empty');
      const pager = $('#ai-emails-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiEmailsAgentFilter');
        const statusSel = $('#aiEmailsStatusFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const status = statusSel ? String(statusSel.value || '').trim().toLowerCase() : '';

        const url = `/api/me/ai/emails?page=${aiEmailsPage}&pageSize=${aiEmailsPageSize}`
          + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '')
          + (status ? `&status=${encodeURIComponent(status)}` : '');

        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiEmailsData = [];
          aiEmailsTotal = 0;
          renderAiEmails();
          if (empty) empty.textContent = j?.message || 'Failed to load emails';
          return;
        }

        aiEmailsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiEmailsTotal = Number.isFinite(total) ? total : aiEmailsData.length;

        if (aiEmailsTotal > 0 && aiEmailsPage > 0 && aiEmailsPage * aiEmailsPageSize >= aiEmailsTotal) {
          aiEmailsPage = 0;
          return loadAiEmails();
        }

        renderAiEmails();
      } catch (e) {
        aiEmailsData = [];
        aiEmailsTotal = 0;
        renderAiEmails();
        if (empty) empty.textContent = 'Failed to load emails';
      }
    }

    // ========== AI SMS ==========
    function renderAiSmsAgentFilter(){
      const sel = $('#aiSmsAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function initAiSmsUI(){
      if (aiSmsUiInit) return;
      aiSmsUiInit = true;

      const refreshBtn = $('#aiSmsRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiSms(); });

      const agentSel = $('#aiSmsAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiSmsPage = 0;
        loadAiSms();
      });

      const statusSel = $('#aiSmsStatusFilter');
      if (statusSel) statusSel.addEventListener('change', () => {
        aiSmsPage = 0;
        loadAiSms();
      });

      const prev = $('#aiSmsPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiSmsPage > 0) {
          aiSmsPage -= 1;
          loadAiSms();
        }
      });

      const next = $('#aiSmsNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiSmsPage + 1) * aiSmsPageSize < aiSmsTotal) {
          aiSmsPage += 1;
          loadAiSms();
        }
      });
    }

    async function openAiSmsTab(){
      initAiSmsUI();

      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiSmsAgentFilter();

      loadAiSms();
    }

    function renderAiSms(){
      const table = $('#ai-sms-table');
      const empty = $('#ai-sms-empty');
      const pager = $('#ai-sms-pager');
      const pageInfo = $('#aiSmsPageInfo');
      const prev = $('#aiSmsPrev');
      const next = $('#aiSmsNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiSmsData || !aiSmsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No SMS yet.';
        return;
      }

      for (const s of aiSmsData) {
        const sent = s.created_at ? fmtDateTime(s.created_at) : '';
        const to = String(s.to_number || '-');
        const from = String(s.from_number || '-');
        const agentName = String(s.agent_name || '-');
        const msgRaw = String(s.message_text || s.content || '').trim();
        const msg = msgRaw.length > 120 ? (msgRaw.slice(0, 120) + '‚Ä¶') : msgRaw;
        const statusRaw = String(s.status || '').toLowerCase();
        const statusLabel = statusRaw ? (statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1)) : 'Unknown';

        const tr = document.createElement('tr');

        const tdSent = document.createElement('td');
        tdSent.textContent = sent;
        tr.appendChild(tdSent);

        const tdTo = document.createElement('td');
        tdTo.textContent = to;
        tr.appendChild(tdTo);

        const tdFrom = document.createElement('td');
        tdFrom.textContent = from;
        tr.appendChild(tdFrom);

        const tdAgent = document.createElement('td');
        tdAgent.textContent = agentName;
        tr.appendChild(tdAgent);

        const tdMsg = document.createElement('td');
        tdMsg.textContent = msg || '-';
        if (msgRaw && msgRaw.length > msg.length) tdMsg.title = msgRaw;
        tr.appendChild(tdMsg);

        const tdStatus = document.createElement('td');
        tdStatus.textContent = statusLabel;
        tdStatus.style.fontWeight = '600';
        tdStatus.style.color = (statusRaw === 'completed') ? '#16a34a' : (statusRaw === 'failed' ? '#ef4444' : '#6b7280');
        if (s.error) tdStatus.title = String(s.error);
        tr.appendChild(tdStatus);

        const dlrRaw = String(s.dlr_status || '').trim();
        let dlrLabel = '-';
        let dlrColor = '#6b7280';
        if (dlrRaw) {
          const up = dlrRaw.toUpperCase();
          if (up === 'DELIVERED') { dlrLabel = 'Delivered'; dlrColor = '#16a34a'; }
          else if (up === 'FAILED') { dlrLabel = 'Failed'; dlrColor = '#ef4444'; }
          else if (up === 'EXPIRED') { dlrLabel = 'Expired'; dlrColor = '#f59e0b'; }
          else { dlrLabel = dlrRaw; dlrColor = '#6b7280'; }
        }
        const tdDlr = document.createElement('td');
        tdDlr.textContent = dlrLabel;
        tdDlr.style.fontWeight = '600';
        tdDlr.style.color = dlrColor;
        const providerStatus = String(s.provider_status || '').trim();
        if (!dlrRaw && providerStatus) tdDlr.title = `Provider status: ${providerStatus}`;
        tr.appendChild(tdDlr);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiSmsTotal > 0 ? Math.max(1, Math.ceil(aiSmsTotal / aiSmsPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiSmsPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiSmsTotal > aiSmsPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiSmsPage <= 0);
      if (next) next.disabled = ((aiSmsPage + 1) * aiSmsPageSize >= aiSmsTotal);
    }

    async function loadAiSms(){
      const table = $('#ai-sms-table');
      const empty = $('#ai-sms-empty');
      const pager = $('#ai-sms-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiSmsAgentFilter');
        const statusSel = $('#aiSmsStatusFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const status = statusSel ? String(statusSel.value || '').trim().toLowerCase() : '';

        const url = `/api/me/ai/sms?page=${aiSmsPage}&pageSize=${aiSmsPageSize}`
          + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '')
          + (status ? `&status=${encodeURIComponent(status)}` : '');

        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiSmsData = [];
          aiSmsTotal = 0;
          renderAiSms();
          if (empty) empty.textContent = j?.message || 'Failed to load SMS';
          return;
        }

        aiSmsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiSmsTotal = Number.isFinite(total) ? total : aiSmsData.length;

        if (aiSmsTotal > 0 && aiSmsPage > 0 && aiSmsPage * aiSmsPageSize >= aiSmsTotal) {
          aiSmsPage = 0;
          return loadAiSms();
        }

        renderAiSms();
      } catch (e) {
        aiSmsData = [];
        aiSmsTotal = 0;
        renderAiSms();
        if (empty) empty.textContent = 'Failed to load SMS';
      }
    }

    // ========== AI Mail ==========
    function renderAiMailAgentFilter(){
      const sel = $('#aiMailAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function initAiMailUI(){
      if (aiMailUiInit) return;
      aiMailUiInit = true;

      const refreshBtn = $('#aiMailRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiMail(true); });

      const agentSel = $('#aiMailAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiMailPage = 0;
        loadAiMail(false);
      });

      const prev = $('#aiMailPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiMailPage > 0) {
          aiMailPage -= 1;
          loadAiMail(false);
        }
      });

      const next = $('#aiMailNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiMailPage + 1) * aiMailPageSize < aiMailTotal) {
          aiMailPage += 1;
          loadAiMail(false);
        }
      });
    }

    async function openAiMailTab(){
      initAiMailUI();

      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiMailAgentFilter();

      loadAiMail(false);
    }

    function formatAiMailAddress(m){
      const addr1 = (m.corrected_to_address1 || m.to_address1 || '').trim();
      const addr2 = (m.corrected_to_address2 || m.to_address2 || '').trim();
      const addr3 = (m.corrected_to_address3 || m.to_address3 || '').trim();
      const city = (m.corrected_to_city || m.to_city || '').trim();
      const state = (m.corrected_to_state || m.to_state || '').trim();
      const zip = (m.corrected_to_postal_code || m.to_postal_code || '').trim();
      const parts = [addr1, addr2, addr3].filter(Boolean);
      const last = [city, state, zip].filter(Boolean).join(' ');
      if (last) parts.push(last);
      return parts.join(', ');
    }

    function formatAiMailToLabel(m){
      const name = String(m.corrected_to_name || m.to_name || '').trim();
      const org = String(m.corrected_to_organization || m.to_organization || '').trim();
      if (name && org) return `${name} (${org})`;
      return name || org || '-';
    }

    function renderAiMail(){
      const table = $('#ai-mail-table');
      const empty = $('#ai-mail-empty');
      const pager = $('#ai-mail-pager');
      const pageInfo = $('#aiMailPageInfo');
      const prev = $('#aiMailPrev');
      const next = $('#aiMailNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiMailData || !aiMailData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No mail yet.';
        return;
      }

      for (const m of aiMailData) {
        const sent = m.created_at ? fmtDateTime(m.created_at) : '';
        const toLabel = formatAiMailToLabel(m);
        const addr = formatAiMailAddress(m);
        const agentName = String(m.agent_name || '-');
        const tracking = String(m.tracking_number || '-');
        const statusRaw = String(m.status || '').toLowerCase();

        const refundStatus = String(m.refund_status || '').toLowerCase();
        const refunded = (refundStatus === 'completed') || !!m.refunded_at || (Number(m.refund_billing_history_id) > 0);

        let statusText = statusRaw ? (statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1)) : 'Unknown';
        if (statusRaw === 'failed' && refunded) statusText = 'Failed (Refunded)';
        if (statusRaw === 'failed' && refundStatus === 'failed') statusText = 'Failed (Refund failed)';

        const baseCostNum = (m.cost_estimate != null ? Number(m.cost_estimate) : null);
        const markupNum = (m.markup_amount != null ? Number(m.markup_amount) : null);
        const totalCostNum = (m.total_cost != null ? Number(m.total_cost) : null);
        const displayCostNum = (totalCostNum != null && Number.isFinite(totalCostNum))
          ? totalCostNum
          : ((baseCostNum != null && Number.isFinite(baseCostNum)) ? baseCostNum : null);
        const cost = (displayCostNum != null) ? `$${displayCostNum.toFixed(2)}` : '-';

        const tr = document.createElement('tr');

        const tdSent = document.createElement('td');
        tdSent.textContent = sent;
        tr.appendChild(tdSent);

        const tdTo = document.createElement('td');
        tdTo.textContent = toLabel;
        tr.appendChild(tdTo);

        const tdAddr = document.createElement('td');
        tdAddr.textContent = addr || '-';
        tr.appendChild(tdAddr);

        const tdAgent = document.createElement('td');
        tdAgent.textContent = agentName;
        tr.appendChild(tdAgent);

        const tdTrack = document.createElement('td');
        tdTrack.textContent = tracking;
        tr.appendChild(tdTrack);

        const tdStatus = document.createElement('td');
        tdStatus.textContent = statusText;
        tdStatus.style.fontWeight = '600';
        tdStatus.style.color = (statusRaw === 'completed') ? '#16a34a' : (statusRaw === 'failed' ? '#ef4444' : '#6b7280');

        const statusHints = [];
        if (m.error) statusHints.push(String(m.error));
        if (refunded) {
          const amt = (m.refund_amount != null && Number.isFinite(Number(m.refund_amount))) ? Number(m.refund_amount) : null;
          statusHints.push(`Refunded${amt != null ? `: $${amt.toFixed(2)}` : ''}`);
        } else if (refundStatus === 'failed' && m.refund_error) {
          statusHints.push(`Refund failed: ${String(m.refund_error)}`);
        }
        if (statusHints.length) tdStatus.title = statusHints.join(' | ');

        tr.appendChild(tdStatus);

        const tdCost = document.createElement('td');
        tdCost.textContent = cost;
        const hasBase = (baseCostNum != null && Number.isFinite(baseCostNum));
        const hasMarkup = (markupNum != null && Number.isFinite(markupNum) && markupNum > 0);
        const hasTotal = (totalCostNum != null && Number.isFinite(totalCostNum) && totalCostNum > 0);
        const parts = [];
        if (hasBase) parts.push(`Base: $${baseCostNum.toFixed(2)}`);
        if (hasMarkup) parts.push(`Markup: $${markupNum.toFixed(2)}`);
        if (hasTotal) parts.push(`Total: $${totalCostNum.toFixed(2)}`);
        if (refunded) parts.push('Refunded');
        if (parts.length) tdCost.title = parts.join(' | ');
        tr.appendChild(tdCost);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiMailTotal > 0 ? Math.max(1, Math.ceil(aiMailTotal / aiMailPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiMailPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiMailTotal > aiMailPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiMailPage <= 0);
      if (next) next.disabled = ((aiMailPage + 1) * aiMailPageSize >= aiMailTotal);
    }

    async function loadAiMail(doRefresh=false){
      const table = $('#ai-mail-table');
      const empty = $('#ai-mail-empty');
      const pager = $('#ai-mail-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiMailAgentFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const url = `/api/me/ai/mail?page=${aiMailPage}&pageSize=${aiMailPageSize}`
          + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '')
          + (doRefresh ? `&refresh=1` : '');

        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiMailData = [];
          aiMailTotal = 0;
          renderAiMail();
          if (empty) empty.textContent = j?.message || 'Failed to load mail';
          return;
        }

        aiMailData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiMailTotal = Number.isFinite(total) ? total : aiMailData.length;

        if (aiMailTotal > 0 && aiMailPage > 0 && aiMailPage * aiMailPageSize >= aiMailTotal) {
          aiMailPage = 0;
          return loadAiMail(doRefresh);
        }

        renderAiMail();
      } catch (e) {
        aiMailData = [];
        aiMailTotal = 0;
        renderAiMail();
        if (empty) empty.textContent = 'Failed to load mail';
      }
    }

    // ========== AI Payments Tab ==========
    let aiPaymentsData = [];
    let aiPaymentsTotal = 0;
    let aiPaymentsPage = 0;
    const aiPaymentsPageSize = 25;
    let aiPaymentsUiInit = false;

    function initAiPaymentsUI(){
      if (aiPaymentsUiInit) return;
      aiPaymentsUiInit = true;

      const statusSel = $('#aiPaymentsStatusFilter');
      const providerSel = $('#aiPaymentsProviderFilter');
      const refreshBtn = $('#aiPaymentsRefreshBtn');
      const prevBtn = $('#aiPaymentsPrev');
      const nextBtn = $('#aiPaymentsNext');

      if (statusSel) statusSel.addEventListener('change', () => { aiPaymentsPage = 0; loadAiPayments(); });
      if (providerSel) providerSel.addEventListener('change', () => { aiPaymentsPage = 0; loadAiPayments(); });
      if (refreshBtn) refreshBtn.addEventListener('click', () => loadAiPayments());
      if (prevBtn) prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiPaymentsPage > 0) {
          aiPaymentsPage -= 1;
          loadAiPayments();
        }
      });
      if (nextBtn) nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiPaymentsPage + 1) * aiPaymentsPageSize < aiPaymentsTotal) {
          aiPaymentsPage += 1;
          loadAiPayments();
        }
      });
    }

    async function openAiPaymentsTab(){
      initAiPaymentsUI();
      loadAiPayments();
    }

    function paymentStatusBadge(status){
      const s = String(status || '').toLowerCase();
      const cls = {
        completed: 'bill-status-completed',
        pending: 'bill-status-pending',
        failed: 'bill-status-failed',
        expired: 'bill-status-failed',
        cancelled: 'bill-status-failed'
      }[s] || 'bill-status-pending';
      const label = s.charAt(0).toUpperCase() + s.slice(1);
      return `<span class="bill-status ${cls}">${escapeHtml(label)}</span>`;
    }

    function renderAiPayments(){
      const table = $('#ai-payments-table');
      const empty = $('#ai-payments-empty');
      const pager = $('#ai-payments-pager');
      const pageInfo = $('#aiPaymentsPageInfo');
      const prev = $('#aiPaymentsPrev');
      const next = $('#aiPaymentsNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiPaymentsData || !aiPaymentsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No payment links sent yet.';
        return;
      }

      for (const p of aiPaymentsData) {
        const date = p.created_at ? fmtDateTime(p.created_at) : '';
        const amountNum = (p.amount_cents != null) ? (Number(p.amount_cents) / 100) : 0;
        const amount = `$${amountNum.toFixed(2)}`;
        const desc = String(p.description || '-').slice(0, 50);
        const customer = p.customer_email || p.customer_phone || '-';
        const provider = String(p.provider || '-').charAt(0).toUpperCase() + String(p.provider || '-').slice(1);
        const paidAt = p.paid_at ? fmtDateTime(p.paid_at) : '-';

        const tr = document.createElement('tr');

        const tdDate = document.createElement('td');
        tdDate.textContent = date;
        tr.appendChild(tdDate);

        const tdAmount = document.createElement('td');
        tdAmount.textContent = amount;
        tdAmount.style.fontWeight = '600';
        tr.appendChild(tdAmount);

        const tdDesc = document.createElement('td');
        tdDesc.textContent = desc;
        if (p.description && p.description.length > 50) tdDesc.title = p.description;
        tr.appendChild(tdDesc);

        const tdCustomer = document.createElement('td');
        tdCustomer.textContent = customer;
        tr.appendChild(tdCustomer);

        const tdProvider = document.createElement('td');
        tdProvider.textContent = provider;
        tr.appendChild(tdProvider);

        const tdStatus = document.createElement('td');
        tdStatus.innerHTML = paymentStatusBadge(p.status);
        tr.appendChild(tdStatus);

        const tdPaid = document.createElement('td');
        tdPaid.textContent = paidAt;
        tr.appendChild(tdPaid);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiPaymentsTotal > 0 ? Math.max(1, Math.ceil(aiPaymentsTotal / aiPaymentsPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiPaymentsPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiPaymentsTotal > aiPaymentsPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiPaymentsPage <= 0);
      if (next) next.disabled = ((aiPaymentsPage + 1) * aiPaymentsPageSize >= aiPaymentsTotal);
    }

    async function loadAiPayments(){
      const table = $('#ai-payments-table');
      const empty = $('#ai-payments-empty');
      const pager = $('#ai-payments-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const statusSel = $('#aiPaymentsStatusFilter');
        const providerSel = $('#aiPaymentsProviderFilter');
        const statusFilter = statusSel ? String(statusSel.value || '').trim() : '';
        const providerFilter = providerSel ? String(providerSel.value || '').trim() : '';

        let url = `/api/me/ai/payment-requests?page=${aiPaymentsPage}&limit=${aiPaymentsPageSize}`;
        if (statusFilter) url += `&status=${encodeURIComponent(statusFilter)}`;
        if (providerFilter) url += `&provider=${encodeURIComponent(providerFilter)}`;

        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiPaymentsData = [];
          aiPaymentsTotal = 0;
          renderAiPayments();
          if (empty) empty.textContent = j?.message || 'Failed to load payments';
          return;
        }

        aiPaymentsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiPaymentsTotal = Number.isFinite(total) ? total : aiPaymentsData.length;

        if (aiPaymentsTotal > 0 && aiPaymentsPage > 0 && aiPaymentsPage * aiPaymentsPageSize >= aiPaymentsTotal) {
          aiPaymentsPage = 0;
          return loadAiPayments();
        }

        renderAiPayments();
      } catch (e) {
        aiPaymentsData = [];
        aiPaymentsTotal = 0;
        renderAiPayments();
        if (empty) empty.textContent = 'Failed to load payments';
      }
    }

    function renderAiConversationSessions(){
      const table = $('#ai-conv-sessions-table');
      const empty = $('#ai-conv-sessions-empty');
      const pager = $('#ai-conv-sessions-pager');
      const pageInfo = $('#aiConvPageInfo');
      const prev = $('#aiConvPrev');
      const next = $('#aiConvNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiConvSessionsData || !aiConvSessionsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No sessions yet.';
        return;
      }

      for (const s of aiConvSessionsData) {
        const callId = String(s.call_id || '');
        const callDomain = String(s.call_domain || '');
        const start = s.time_start ? fmtDateTime(s.time_start) : '';
        const from = String(s.from_number || '-');
        const agentName = String(s.agent_name || '-');
        const msgCount = (s.message_count != null ? String(s.message_count) : '0');
        const isSelected = aiConvSelected && String(aiConvSelected.call_id || '') === callId && String(aiConvSelected.call_domain || '') === callDomain;

        const tr = document.createElement('tr');
        if (isSelected) tr.style.background = 'rgba(79,70,229,.18)';
        tr.innerHTML =
          `<td>${escapeHtml(start)}</td>`+
          `<td>${escapeHtml(from)}</td>`+
          `<td>${escapeHtml(agentName)}</td>`+
          `<td>${escapeHtml(msgCount)}</td>`+
          `<td><button type="button" class="ai-conv-open" data-call-id="${escapeHtml(callId)}" data-call-domain="${escapeHtml(callDomain)}">Open</button></td>`;
        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiConvTotal > 0 ? Math.max(1, Math.ceil(aiConvTotal / aiConvPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiConvPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiConvTotal > aiConvPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiConvPage <= 0);
      if (next) next.disabled = ((aiConvPage + 1) * aiConvPageSize >= aiConvTotal);
    }

    async function loadAiConversationSessions(){
      const table = $('#ai-conv-sessions-table');
      const empty = $('#ai-conv-sessions-empty');
      const pager = $('#ai-conv-sessions-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiConvAgentFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const url = `/api/me/ai/conversations/sessions?page=${aiConvPage}&pageSize=${aiConvPageSize}` + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '');
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiConvSessionsData = [];
          aiConvTotal = 0;
          renderAiConversationSessions();
          if (empty) empty.textContent = j?.message || 'Failed to load sessions';
          return;
        }
        aiConvSessionsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiConvTotal = Number.isFinite(total) ? total : aiConvSessionsData.length;

        // If current page is out of bounds (e.g. filter changed), jump back and refetch.
        if (aiConvTotal > 0 && aiConvPage > 0 && aiConvPage * aiConvPageSize >= aiConvTotal) {
          aiConvPage = 0;
          return loadAiConversationSessions();
        }

        renderAiConversationSessions();
      } catch (e) {
        aiConvSessionsData = [];
        aiConvTotal = 0;
        renderAiConversationSessions();
        if (empty) empty.textContent = 'Failed to load sessions';
      }
    }

    function renderAiConversationMessages(msgs){
      const box = $('#aiConvMessages');
      const empty = $('#aiConvMessagesEmpty');
      if (!box || !empty) return;

      box.innerHTML = '';

      const arr = Array.isArray(msgs) ? msgs : [];
      if (!arr.length) {
        empty.style.display = 'block';
        empty.textContent = 'No messages recorded for this session.';
        return;
      }

      empty.style.display = 'none';

      for (const m of arr) {
        const role = String(m.role || '').toLowerCase();
        const isUser = role === 'user';
        const who = isUser ? 'Caller' : 'AI';
        const ts = m.created_at ? fmtDateTime(m.created_at) : '';

        const card = document.createElement('div');
        card.className = `ai-chat-card ${isUser ? 'ai-chat-card--user' : 'ai-chat-card--ai'}`;

        const header = document.createElement('div');
        header.className = 'ai-chat-meta';
        header.textContent = ts ? `${who} ‚Ä¢ ${ts}` : who;

        const body = document.createElement('div');
        body.className = 'ai-chat-body';
        body.textContent = String(m.content || '');

        card.appendChild(header);
        card.appendChild(body);
        box.appendChild(card);
      }

      box.scrollTop = box.scrollHeight;
    }

    async function loadAiConversationMessages(callDomain, callId){
      const empty = $('#aiConvMessagesEmpty');
      if (empty) {
        empty.style.display = 'block';
        empty.textContent = 'Loading‚Ä¶';
      }
      const box = $('#aiConvMessages');
      if (box) box.innerHTML = '';

      try {
        const url = `/api/me/ai/conversations/messages?call_id=${encodeURIComponent(String(callId || ''))}&call_domain=${encodeURIComponent(String(callDomain || ''))}&limit=5000`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          if (empty) empty.textContent = j?.message || 'Failed to load messages';
          return;
        }
        renderAiConversationMessages(j.data);
      } catch (e) {
        if (empty) empty.textContent = 'Failed to load messages';
      }
    }

    function selectAiConversationSession(session){
      const callId = String(session && session.call_id ? session.call_id : '');
      const callDomain = String(session && session.call_domain ? session.call_domain : '');
      if (!callId || !callDomain) return;

      aiConvSelected = { call_id: callId, call_domain: callDomain };
      renderAiConversationSessions();

      const meta = $('#aiConvSessionMeta');
      if (meta) {
        const parts = [];
        if (session.from_number) parts.push(`From ${String(session.from_number)}`);
        if (session.time_start) parts.push(fmtDateTime(session.time_start));
        parts.push(`${callDomain}/${callId}`);
        meta.textContent = parts.join(' ‚Ä¢ ');
      }

      loadAiConversationMessages(callDomain, callId);
    }

    function renderAiOutboundConversationSessions(){
      const table = $('#ai-outbound-conv-sessions-table');
      const empty = $('#ai-outbound-conv-sessions-empty');
      const pager = $('#ai-outbound-conv-sessions-pager');
      const pageInfo = $('#aiOutboundConvPageInfo');
      const prev = $('#aiOutboundConvPrev');
      const next = $('#aiOutboundConvNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiOutboundConvSessionsData || !aiOutboundConvSessionsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No sessions yet.';
        return;
      }

      for (const s of aiOutboundConvSessionsData) {
        const callId = String(s.call_id || '');
        const callDomain = String(s.call_domain || '');
        const start = s.time_start ? fmtDateTime(s.time_start) : '';
        const to = String(s.to_number || '-');
        const agentName = String(s.agent_name || '-');
        const msgCount = (s.message_count != null ? String(s.message_count) : '0');
        const status = String(s.status || '').trim();
        const result = String(s.result || '').trim();
        const statusText = (status && result && result !== status) ? `${status} ‚Ä¢ ${result}` : (status || result || '-');
        const isSelected = aiOutboundConvSelected && String(aiOutboundConvSelected.call_id || '') === callId && String(aiOutboundConvSelected.call_domain || '') === callDomain;

        const tr = document.createElement('tr');
        if (isSelected) tr.style.background = 'rgba(79,70,229,.18)';
        tr.innerHTML =
          `<td>${escapeHtml(start)}</td>`+
          `<td>${escapeHtml(to)}</td>`+
          `<td>${escapeHtml(agentName)}</td>`+
          `<td>${escapeHtml(msgCount)}</td>`+
          `<td>${escapeHtml(statusText)}</td>`+
          `<td><button type="button" class="ai-outbound-conv-open" data-call-id="${escapeHtml(callId)}" data-call-domain="${escapeHtml(callDomain)}">Open</button></td>`;
        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiOutboundConvTotal > 0 ? Math.max(1, Math.ceil(aiOutboundConvTotal / aiOutboundConvPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiOutboundConvPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiOutboundConvTotal > aiOutboundConvPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiOutboundConvPage <= 0);
      if (next) next.disabled = ((aiOutboundConvPage + 1) * aiOutboundConvPageSize >= aiOutboundConvTotal);
    }

    async function loadAiOutboundConversationSessions(){
      const table = $('#ai-outbound-conv-sessions-table');
      const empty = $('#ai-outbound-conv-sessions-empty');
      const pager = $('#ai-outbound-conv-sessions-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiOutboundConvAgentFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const url = `/api/me/ai/outbound-conversations/sessions?page=${aiOutboundConvPage}&pageSize=${aiOutboundConvPageSize}` + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '');
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiOutboundConvSessionsData = [];
          aiOutboundConvTotal = 0;
          renderAiOutboundConversationSessions();
          if (empty) empty.textContent = j?.message || 'Failed to load sessions';
          return;
        }
        aiOutboundConvSessionsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiOutboundConvTotal = Number.isFinite(total) ? total : aiOutboundConvSessionsData.length;

        // If current page is out of bounds (e.g. filter changed), jump back and refetch.
        if (aiOutboundConvTotal > 0 && aiOutboundConvPage > 0 && aiOutboundConvPage * aiOutboundConvPageSize >= aiOutboundConvTotal) {
          aiOutboundConvPage = 0;
          return loadAiOutboundConversationSessions();
        }

        renderAiOutboundConversationSessions();
      } catch (e) {
        aiOutboundConvSessionsData = [];
        aiOutboundConvTotal = 0;
        renderAiOutboundConversationSessions();
        if (empty) empty.textContent = 'Failed to load sessions';
      }
    }

    function renderAiOutboundConversationMessages(msgs){
      const box = $('#aiOutboundConvMessages');
      const empty = $('#aiOutboundConvMessagesEmpty');
      if (!box || !empty) return;

      box.innerHTML = '';

      const arr = Array.isArray(msgs) ? msgs : [];
      if (!arr.length) {
        empty.style.display = 'block';
        empty.textContent = 'No messages recorded for this session.';
        return;
      }

      empty.style.display = 'none';

      for (const m of arr) {
        const role = String(m.role || '').toLowerCase();
        const isUser = role === 'user';
        const who = isUser ? 'Callee' : 'AI';
        const ts = m.created_at ? fmtDateTime(m.created_at) : '';

        const card = document.createElement('div');
        card.className = `ai-chat-card ${isUser ? 'ai-chat-card--user' : 'ai-chat-card--ai'}`;

        const header = document.createElement('div');
        header.className = 'ai-chat-meta';
        header.textContent = ts ? `${who} ‚Ä¢ ${ts}` : who;

        const body = document.createElement('div');
        body.className = 'ai-chat-body';
        body.textContent = String(m.content || '');

        card.appendChild(header);
        card.appendChild(body);
        box.appendChild(card);
      }

      box.scrollTop = box.scrollHeight;
    }

    async function loadAiOutboundConversationMessages(callDomain, callId){
      const empty = $('#aiOutboundConvMessagesEmpty');
      if (empty) {
        empty.style.display = 'block';
        empty.textContent = 'Loading‚Ä¶';
      }
      const box = $('#aiOutboundConvMessages');
      if (box) box.innerHTML = '';

      try {
        const url = `/api/me/ai/conversations/messages?call_id=${encodeURIComponent(String(callId || ''))}&call_domain=${encodeURIComponent(String(callDomain || ''))}&limit=5000`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          if (empty) empty.textContent = j?.message || 'Failed to load messages';
          return;
        }
        renderAiOutboundConversationMessages(j.data);
      } catch (e) {
        if (empty) empty.textContent = 'Failed to load messages';
      }
    }

    function selectAiOutboundConversationSession(session){
      const callId = String(session && session.call_id ? session.call_id : '');
      const callDomain = String(session && session.call_domain ? session.call_domain : '');
      if (!callId || !callDomain) return;

      aiOutboundConvSelected = { call_id: callId, call_domain: callDomain };
      renderAiOutboundConversationSessions();

      const meta = $('#aiOutboundConvSessionMeta');
      if (meta) {
        const parts = [];
        if (session.to_number) parts.push(`To ${String(session.to_number)}`);
        if (session.time_start) parts.push(fmtDateTime(session.time_start));
        if (session.status) parts.push(String(session.status));
        parts.push(`${callDomain}/${callId}`);
        meta.textContent = parts.join(' ‚Ä¢ ');
      }

      loadAiOutboundConversationMessages(callDomain, callId);
    }

    function refreshAgentDefaultTemplateSelectOptions(){
      const sel = $('#aiAgentDefaultTemplateSelect');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('None', ''));
      for (const t of docTemplatesData || []){
        const id = t && t.id != null ? String(t.id) : '';
        const name = t && t.name ? String(t.name) : '';
        if (!id) continue;
        sel.appendChild(new Option(name || id, id));
      }
      // Restore selection if still present
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    // ========== AI Tool Modal Functions ==========
    const toolModalIds = {
      smtp: 'aiToolSmtpModal',
      transfer: 'aiToolTransferModal',
      sms: 'aiToolSmsModal',
      mail: 'aiToolMailModal',
      doctemplates: 'aiToolDocTemplatesModal',
      square: 'aiToolSquareModal',
      stripe: 'aiToolStripeModal'
    };

    function openToolModal(toolName) {
      const modalId = toolModalIds[toolName];
      if (!modalId) return;
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        // Load data for this tool
        if (toolName === 'smtp') loadSmtpSettings();
        if (toolName === 'transfer') loadAiTransferSettings();
        if (toolName === 'sms') { loadAiSmsDidOptions(); loadAiSmsSettings(); }
        if (toolName === 'mail') loadMailSettings();
        if (toolName === 'doctemplates') loadDocTemplates();
        if (toolName === 'square') loadSquareSettings();
        if (toolName === 'stripe') loadStripeSettings();
      }
    }

    function closeToolModal(toolName) {
      const modalId = toolModalIds[toolName];
      if (!modalId) return;
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'none';
      // Refresh tool cards status after closing
      refreshToolCardStatuses();
    }

    function updateToolCardStatus(cardId, isConfigured, label) {
      const statusEl = document.getElementById(cardId);
      if (!statusEl) return;
      const badge = statusEl.querySelector('.ai-tool-status-badge');
      if (!badge) return;
      badge.className = 'ai-tool-status-badge ' + (isConfigured ? 'ai-tool-status-configured' : 'ai-tool-status-unconfigured');
      badge.textContent = label || (isConfigured ? 'Configured' : 'Not configured');
    }

    async function refreshToolCardStatuses() {
      // SMTP status
      try {
        const r = await fetch('/api/me/smtp-settings');
        const j = await r.json();
        const d = j && j.data;
        const configured = !!(d && d.has_password && d.host && d.from_email);
        updateToolCardStatus('smtpCardStatus', configured);
      } catch (e) {}

      // Transfer status
      try {
        const r = await fetch('/api/me/ai/transfer-settings');
        const j = await r.json();
        const d = j && j.data;
        const configured = !!(d && d.transfer_to_number);
        updateToolCardStatus('transferCardStatus', configured);
      } catch (e) {}

      // SMS status
      try {
        const r = await fetch('/api/me/ai/sms-settings');
        const j = await r.json();
        const d = j && j.data;
        const allowed = Array.isArray(d?.allowed_didww_did_ids) ? d.allowed_didww_did_ids : [];
        const configured = allowed.length > 0;
        updateToolCardStatus('smsCardStatus', configured);
      } catch (e) {}

      // Mail status
      try {
        const r = await fetch('/api/me/ai/mail-settings');
        const j = await r.json();
        const d = j && j.data;
        const configured = !!(d && d.address1 && d.city && d.state && d.postal_code);
        updateToolCardStatus('mailCardStatus', configured);
      } catch (e) {}

      // Doc templates status
      try {
        const r = await fetch('/api/me/ai/doc-templates');
        const j = await r.json();
        const templates = Array.isArray(j?.data) ? j.data : [];
        const count = templates.length;
        updateToolCardStatus('docTemplatesCardStatus', count > 0, count > 0 ? `${count} template${count > 1 ? 's' : ''}` : 'Not configured');
      } catch (e) {}

      // Payment settings status (Square/Stripe)
      try {
        const r = await fetch('/api/me/ai/payment-settings');
        const j = await r.json();
        const d = j && j.data;
        const squareConfigured = !!(d && d.has_square);
        const stripeConfigured = !!(d && d.has_stripe);
        updateToolCardStatus('squareCardStatus', squareConfigured);
        updateToolCardStatus('stripeCardStatus', stripeConfigured);
      } catch (e) {}
    }

    // Tool card click handlers
    document.addEventListener('click', function(e) {
      const card = e.target.closest('.ai-tool-card');
      if (card && card.dataset.tool) {
        openToolModal(card.dataset.tool);
      }
    });

    // Close modal when clicking outside
    document.querySelectorAll('.ai-tool-modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          const toolName = Object.keys(toolModalIds).find(k => toolModalIds[k] === modal.id);
          if (toolName) closeToolModal(toolName);
        }
      });
    });

    async function loadSmtpSettings(){
      const status = $('#smtpStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      try {
        const r = await fetch('/api/me/smtp-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data;
        smtpHasPassword = !!(d && d.has_password);
        $('#smtpHost').value = d ? (d.host || '') : '';
        $('#smtpPort').value = d ? (d.port || '') : '';
        $('#smtpSecure').checked = !!(d && (d.secure === 1 || d.secure === true));
        $('#smtpUsername').value = d ? (d.username || '') : '';
        $('#smtpPassword').value = '';
        $('#smtpFromEmail').value = d ? (d.from_email || '') : '';
        $('#smtpFromName').value = d ? (d.from_name || '') : '';
        $('#smtpReplyTo').value = d ? (d.reply_to || '') : '';
        if (status) status.textContent = d ? (smtpHasPassword ? 'Configured' : 'Missing password') : 'Not configured';
      } catch (e) {
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveSmtpSettings(){
      const btn = $('#saveSmtpBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';
      try {
        const payload = {
          host: ($('#smtpHost').value || '').trim(),
          port: parseInt(String($('#smtpPort').value || '0'), 10),
          secure: $('#smtpSecure').checked ? 1 : 0,
          username: ($('#smtpUsername').value || '').trim(),
          password: ($('#smtpPassword').value || ''),
          from_email: ($('#smtpFromEmail').value || '').trim(),
          from_name: ($('#smtpFromName').value || '').trim(),
          reply_to: ($('#smtpReplyTo').value || '').trim()
        };
        const r = await fetch('/api/me/smtp-settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save SMTP settings', 'error');
          return;
        }
        showToast('SMTP settings saved.');
        await loadSmtpSettings();
      } catch (e) {
        showToast('Failed to save SMTP settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    async function testSmtpSettings(){
      const btn = $('#testSmtpBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Sending...';
      try {
        const to_email = ($('#smtpTestToEmail').value || '').trim();
        const r = await fetch('/api/me/smtp-settings/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(to_email ? { to_email } : {})
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'SMTP test failed', 'error');
          return;
        }
        showToast('Test email sent.');
      } catch (e) {
        showToast('SMTP test failed', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    async function loadAiTransferSettings(){
      const status = $('#aiTransferStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      try {
        const r = await fetch('/api/me/ai/transfer-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data || {};
        const v = d && d.transfer_to_number ? String(d.transfer_to_number) : '';
        const input = $('#aiTransferNumber');
        if (input) input.value = v;
        if (status) status.textContent = v ? 'Configured' : 'Not configured';
      } catch (e) {
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveAiTransferSettings(){
      const btn = $('#saveAiTransferBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';
      try {
        const input = $('#aiTransferNumber');
        const transfer_to_number = input ? String(input.value || '').trim() : '';
        const r = await fetch('/api/me/ai/transfer-settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transfer_to_number })
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save transfer settings', 'error');
          return;
        }
        showToast('Transfer settings saved.');
        await loadAiTransferSettings();
      } catch (e) {
        showToast('Failed to save transfer settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // AI SMS settings (outbound sender IDs)
    function getSelectedMultiValues(sel){
      const el = sel || null;
      if (!el) return [];
      return Array.from(el.selectedOptions || []).map(o => String(o.value || '').trim()).filter(Boolean);
    }

    function refreshAiSmsDefaultDidOptions(){
      const allowedSel = $('#aiSmsAllowedDidIds');
      const defaultSel = $('#aiSmsDefaultDidId');
      if (!allowedSel || !defaultSel) return;

      const allowedIds = getSelectedMultiValues(allowedSel);
      const current = String(defaultSel.value || '').trim();

      defaultSel.innerHTML = '';
      defaultSel.appendChild(new Option('Auto (first allowed)', ''));
      for (const id of allowedIds) {
        const opt = aiSmsDidOptions.find(d => String(d.didww_did_id || d.id || '') === id);
        const label = opt ? String(opt.did_number || opt.number || id) : id;
        defaultSel.appendChild(new Option(label, id));
      }

      // Preserve selection if still present
      const still = Array.from(defaultSel.options || []).some(o => String(o.value) === current);
      defaultSel.value = still ? current : '';
    }

    function renderAiSmsSettingsUI(){
      const allowedSel = $('#aiSmsAllowedDidIds');
      const defaultSel = $('#aiSmsDefaultDidId');
      const status = $('#aiSmsSettingsStatus');
      if (!allowedSel || !defaultSel) return;

      const currentAllowed = new Set((aiSmsSettings && aiSmsSettings.allowedDidIds) ? aiSmsSettings.allowedDidIds.map(String) : []);
      const currentDefault = (aiSmsSettings && aiSmsSettings.defaultDidId) ? String(aiSmsSettings.defaultDidId) : '';

      allowedSel.innerHTML = '';

      if (!aiSmsDidOptions || aiSmsDidOptions.length === 0) {
        if (status) status.textContent = 'No DIDWW numbers found.';
        defaultSel.innerHTML = '';
        defaultSel.appendChild(new Option('Auto (first allowed)', ''));
        return;
      }

      for (const d of aiSmsDidOptions) {
        const id = String(d.didww_did_id || d.id || '').trim();
        const num = String(d.did_number || d.number || '').trim();
        if (!id) continue;
        const opt = new Option(num || id, id);
        if (currentAllowed.has(id)) opt.selected = true;
        allowedSel.appendChild(opt);
      }

      refreshAiSmsDefaultDidOptions();

      try { defaultSel.value = currentDefault || ''; } catch {}

      if (status) {
        const allowedCount = getSelectedMultiValues(allowedSel).length;
        status.textContent = allowedCount ? 'Configured' : 'Not configured';
      }
    }

    async function loadAiSmsDidOptions(){
      const status = $('#aiSmsSettingsStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      try {
        const r = await fetch('/api/me/ai/sms/did-options');
        const j = await r.json();
        if (!j || j.success === false) {
          aiSmsDidOptions = [];
          renderAiSmsSettingsUI();
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        aiSmsDidOptions = Array.isArray(j.data) ? j.data : [];
        renderAiSmsSettingsUI();
      } catch (e) {
        aiSmsDidOptions = [];
        renderAiSmsSettingsUI();
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function loadAiSmsSettings(){
      const status = $('#aiSmsSettingsStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      try {
        const r = await fetch('/api/me/ai/sms-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          aiSmsSettings = { allowedDidIds: [], defaultDidId: '' };
          renderAiSmsSettingsUI();
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data || {};
        const allowed = Array.isArray(d.allowed_didww_did_ids) ? d.allowed_didww_did_ids : [];
        const defId = d.default_didww_did_id ? String(d.default_didww_did_id) : '';
        aiSmsSettings = { allowedDidIds: allowed.map(x => String(x)), defaultDidId: defId };
        renderAiSmsSettingsUI();
      } catch (e) {
        aiSmsSettings = { allowedDidIds: [], defaultDidId: '' };
        renderAiSmsSettingsUI();
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveAiSmsSettings(){
      const btn = $('#saveAiSmsSettingsBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';

      try {
        const allowedSel = $('#aiSmsAllowedDidIds');
        const defaultSel = $('#aiSmsDefaultDidId');

        const allowed_didww_did_ids = getSelectedMultiValues(allowedSel);
        const default_didww_did_id = defaultSel ? String(defaultSel.value || '').trim() : '';

        const payload = {
          allowed_didww_did_ids,
          default_didww_did_id: default_didww_did_id || null
        };

        const r = await fetch('/api/me/ai/sms-settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save SMS settings', 'error');
          return;
        }

        showToast('SMS settings saved.');
        await loadAiSmsSettings();
      } catch (e) {
        showToast('Failed to save SMS settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // AI Mail settings (return address)
    async function loadMailSettings(){
      const status = $('#mailSettingsStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      try {
        const r = await fetch('/api/me/ai/mail-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data || null;
        $('#mailFromName').value = d ? (d.name || '') : '';
        $('#mailFromOrg').value = d ? (d.organization || '') : '';
        $('#mailFromAddress1').value = d ? (d.address1 || '') : '';
        $('#mailFromAddress2').value = d ? (d.address2 || '') : '';
        $('#mailFromCity').value = d ? (d.city || '') : '';
        $('#mailFromState').value = d ? (d.state || '') : '';
        $('#mailFromPostal').value = d ? (d.postal_code || '') : '';
        try { $('#mailFromCountry').value = d ? (d.country || 'US') : 'US'; } catch {}
        if (status) status.textContent = d ? 'Configured' : 'Not configured';
      } catch (e) {
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveMailSettings(){
      const btn = $('#saveMailSettingsBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';
      try {
        const payload = {
          name: ($('#mailFromName').value || '').trim(),
          organization: ($('#mailFromOrg').value || '').trim(),
          address1: ($('#mailFromAddress1').value || '').trim(),
          address2: ($('#mailFromAddress2').value || '').trim(),
          city: ($('#mailFromCity').value || '').trim(),
          state: ($('#mailFromState').value || '').trim(),
          postal_code: ($('#mailFromPostal').value || '').trim(),
          country: ($('#mailFromCountry').value || 'US').trim()
        };
        const r = await fetch('/api/me/ai/mail-settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save mail settings', 'error');
          return;
        }
        showToast('Mail settings saved.');
        await loadMailSettings();
      } catch (e) {
        showToast('Failed to save mail settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // AI Payment settings (Square/Stripe)
    const PAYMENT_WEBHOOK_BASE = 'https://www.Phone.System.net';

    function getPaymentWebhookUrl(provider, userId) {
      if (!userId) return 'Loading...';
      return `${PAYMENT_WEBHOOK_BASE}/webhooks/user-${provider}/${userId}`;
    }

    async function loadSquareSettings(){
      const status = $('#squareSettingsStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      const webhookInput = $('#squareWebhookUrl');
      try {
        const r = await fetch('/api/me/ai/payment-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data || {};
        // Populate webhook URL using user_id from API response
        if (webhookInput) webhookInput.value = getPaymentWebhookUrl('square', d.user_id);
        // Don't populate the access token (for security, we only show if configured)
        $('#squareAccessToken').value = '';
        $('#squareLocationId').value = d.square_location_id || '';
        try { $('#squareEnvironment').value = d.square_environment || 'production'; } catch {}
        if (status) status.textContent = d.square_configured ? 'Configured' : 'Not configured';
      } catch (e) {
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveSquareSettings(){
      const btn = $('#saveSquareSettingsBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';
      try {
        const accessToken = ($('#squareAccessToken').value || '').trim();
        if (!accessToken) {
          showToast('Access token is required', 'error');
          return;
        }
        const payload = {
          access_token: accessToken,
          location_id: ($('#squareLocationId').value || '').trim(),
          environment: ($('#squareEnvironment').value || 'production').trim()
        };
        const r = await fetch('/api/me/ai/payment-settings/square', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save Square settings', 'error');
          return;
        }
        showToast('Square settings saved.');
        await loadSquareSettings();
      } catch (e) {
        showToast('Failed to save Square settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    function copySquareWebhookUrl() {
      const input = $('#squareWebhookUrl');
      if (!input || !input.value) return;
      navigator.clipboard.writeText(input.value).then(() => {
        showToast('Webhook URL copied to clipboard');
      }).catch(() => {
        input.select();
        document.execCommand('copy');
        showToast('Webhook URL copied to clipboard');
      });
    }

    async function loadStripeSettings(){
      const status = $('#stripeSettingsStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      const webhookInput = $('#stripeWebhookUrl');
      try {
        const r = await fetch('/api/me/ai/payment-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data || {};
        // Populate webhook URL using user_id from API response
        if (webhookInput) webhookInput.value = getPaymentWebhookUrl('stripe', d.user_id);
        // Don't populate the secret key (for security, we only show if configured)
        $('#stripeSecretKey').value = '';
        if (status) status.textContent = d.stripe_configured ? 'Configured' : 'Not configured';
      } catch (e) {
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveStripeSettings(){
      const btn = $('#saveStripeSettingsBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';
      try {
        const secretKey = ($('#stripeSecretKey').value || '').trim();
        if (!secretKey) {
          showToast('Secret key is required', 'error');
          return;
        }
        const payload = {
          secret_key: secretKey
        };
        const r = await fetch('/api/me/ai/payment-settings/stripe', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save Stripe settings', 'error');
          return;
        }
        showToast('Stripe settings saved.');
        await loadStripeSettings();
      } catch (e) {
        showToast('Failed to save Stripe settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    function copyStripeWebhookUrl() {
      const input = $('#stripeWebhookUrl');
      if (!input || !input.value) return;
      navigator.clipboard.writeText(input.value).then(() => {
        showToast('Webhook URL copied to clipboard');
      }).catch(() => {
        input.select();
        document.execCommand('copy');
        showToast('Webhook URL copied to clipboard');
      });
    }

    function renderDocTemplates(){
      const table = $('#ai-doc-templates-table');
      const empty = $('#ai-doc-templates-empty');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!docTemplatesData || !docTemplatesData.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        empty.textContent = 'No templates yet. Upload a .docx.';
        refreshAgentDefaultTemplateSelectOptions();
        return;
      }

      for (const t of docTemplatesData){
        const tr = document.createElement('tr');
        const name = String(t.name || '');
        const file = String(t.original_filename || '');
        const updated = t.updated_at ? new Date(t.updated_at).toLocaleString() : '';
        tr.innerHTML =
          `<td>${escapeHtml(name)}</td>`+
          `<td>${escapeHtml(file)}</td>`+
          `<td>${escapeHtml(updated)}</td>`+
          `<td><button class="ai-doc-template-delete btn--danger" data-id="${escapeHtml(String(t.id))}">Delete</button></td>`;
        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';
      refreshAgentDefaultTemplateSelectOptions();
    }

    async function loadDocTemplates(){
      const table = $('#ai-doc-templates-table');
      const empty = $('#ai-doc-templates-empty');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      try {
        const r = await fetch('/api/me/ai/doc-templates');
        const j = await r.json();
        if (!j || j.success === false) {
          docTemplatesData = [];
          renderDocTemplates();
          if (empty) empty.textContent = j?.message || 'Failed to load templates';
          return;
        }
        docTemplatesData = Array.isArray(j.data) ? j.data : [];
        renderDocTemplates();
      } catch (e) {
        docTemplatesData = [];
        renderDocTemplates();
        if (empty) empty.textContent = 'Failed to load templates';
      }
    }

    function getSelectedCartesiaVoiceId(){
      const sel = $('#aiAgentCartesiaVoiceSelect');
      const custom = $('#aiAgentCartesiaVoiceCustom');
      if (!sel) return '';
      const v = String(sel.value || '');
      if (v === '__custom__') return String(custom && custom.value ? custom.value : '').trim();
      return v.trim();
    }

    function setCartesiaCustomVisible(on){
      const wrap = $('#aiAgentCartesiaVoiceCustomWrap');
      if (!wrap) return;
      wrap.style.display = on ? 'block' : 'none';
    }

    function applyAiVoiceSelection(voiceId){
      const sel = $('#aiAgentCartesiaVoiceSelect');
      const custom = $('#aiAgentCartesiaVoiceCustom');
      if (!sel) return;
      const id = String(voiceId || '').trim();

      if (!id) {
        sel.value = '';
        if (custom) custom.value = '';
        setCartesiaCustomVisible(false);
        return;
      }

      const found = Array.from(sel.options || []).some(o => String(o.value) === id);
      if (found) {
        sel.value = id;
        if (custom) custom.value = '';
        setCartesiaCustomVisible(false);
      } else {
        sel.value = '__custom__';
        if (custom) custom.value = id;
        setCartesiaCustomVisible(true);
      }
    }

    async function loadCartesiaVoices(force=false){
      if (cartesiaVoicesLoaded && !force) return;
      const sel = $('#aiAgentCartesiaVoiceSelect');
      const btn = $('#aiLoadVoicesBtn');
      if (!sel || !btn) return;

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Loading...';
      try {
        const r = await fetch('/api/me/ai/cartesia/voices?limit=200');
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to load Cartesia voices', 'error');
          return;
        }
        const voices = Array.isArray(j.data) ? j.data : [];

        // Preserve current selection before rebuilding options
        const currentId = getSelectedCartesiaVoiceId();

        sel.innerHTML = '';
        sel.appendChild(new Option('Default voice', ''));
        sel.appendChild(new Option('Custom voice id‚Ä¶', '__custom__'));

        for (const v of voices){
          const id = v && v.id ? String(v.id) : '';
          if (!id) continue;
          const name = String(v.name || '').trim();
          const lang = String(v.language || '').trim();
          const label = (name ? name : id) + (lang ? ` (${lang})` : '');
          sel.appendChild(new Option(label, id));
        }

        cartesiaVoicesLoaded = true;
        applyAiVoiceSelection(currentId);
      } catch (e) {
        showToast('Failed to load Cartesia voices', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    function renderAiAgents(){
      const table = $('#ai-agents-table');
      const empty = $('#ai-agents-empty');
      const count = $('#aiAgentsCount');
      if (count) count.textContent = `(${aiAgentsData.length}/5)`;
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiAgentsData.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        empty.textContent = 'No agents yet. Click ‚ÄúCreate Agent‚Äù.';
        return;
      }

      for (const a of aiAgentsData){
        const greeting = String(a.greeting || '');
        const greetShort = greeting.length > 44 ? (greeting.slice(0,44) + '‚Ä¶') : greeting;
        const voiceId = String(a.cartesia_voice_id || '');
        const voiceShort = voiceId ? (voiceId.length > 18 ? (voiceId.slice(0,18) + '‚Ä¶') : voiceId) : '-';
        const num = a.phone_number || '';
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${escapeHtml(a.display_name || '')}</td>`+
          `<td title="${escapeHtml(voiceId)}">${escapeHtml(voiceShort)}</td>`+
          `<td>${escapeHtml(greetShort)}</td>`+
          `<td>${escapeHtml(num || '-')}</td>`+
          `<td>`+
            `<button class="edit-ai-agent" data-id="${escapeHtml(String(a.id))}">Edit</button> `+
            `<button class="redeploy-ai-agent btn--warning" data-id="${escapeHtml(String(a.id))}">Redeploy</button> `+
            `<button class="del-ai-agent btn--danger" data-id="${escapeHtml(String(a.id))}">Delete</button>`+
          `</td>`;
        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';
    }

    function getCurrentUserBalance(){
      const b = (meProfile && meProfile.balance != null) ? Number(meProfile.balance) : null;
      return Number.isFinite(b) ? b : null;
    }

    function aiNumbersBalanceLocked(){
      const b = getCurrentUserBalance();
      // Require a positive balance (> 0) to buy/assign/unassign AI numbers.
      return (b != null && b <= 0);
    }

    function applyAiNumbersBalanceLock(){
      const locked = aiNumbersBalanceLocked();

      const note = document.getElementById('aiNumbersBalanceLockNote');
      if (note) note.style.display = locked ? 'block' : 'none';

      const buyBtn = document.getElementById('buyAiNumberBtn');
      if (buyBtn) {
        buyBtn.disabled = locked;
        buyBtn.title = locked ? 'Add funds to enable buying/assigning AI numbers.' : '';
      }

      document.querySelectorAll('select.ai-number-agent-select').forEach((el) => {
        try {
          el.disabled = locked;
          el.title = locked ? 'Add funds to enable assigning AI numbers.' : '';
        } catch {}
      });

      document.querySelectorAll('button.ai-number-unassign').forEach((el) => {
        try {
          el.disabled = locked;
          el.title = locked ? 'Add funds to enable unassigning AI numbers.' : '';
        } catch {}
      });
    }

    function renderAiNumbers(){
      const table = $('#ai-numbers-table');
      const empty = $('#ai-numbers-empty');
      const count = $('#aiNumbersCount');
      if (count) count.textContent = `(${aiNumbersData.length}/5)`;
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiNumbersData.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        empty.textContent = 'No phone numbers yet. Click ‚ÄúBuy Number‚Äù.';
        applyAiNumbersBalanceLock();
        return;
      }

      const agentOptions = ['<option value="">-- Unassigned --</option>']
        .concat(aiAgentsData.map(a => `<option value="${escapeHtml(String(a.id))}">${escapeHtml(a.display_name || '')}</option>`))
        .join('');

      for (const n of aiNumbersData){
        const tr = document.createElement('tr');
        const unassignBtn = n.agent_id
          ? `<button class="ai-number-unassign btn--muted" data-number-id="${escapeHtml(String(n.id))}">Unassign</button>`
          : '';
        // Calculate age in days for delete button
        const createdAt = n.created_at ? new Date(n.created_at) : null;
        const ageInDays = createdAt ? Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24)) : 0;
        const canDelete = ageInDays >= 28;
        const daysRemaining = Math.max(0, 28 - ageInDays);
        const deleteTitle = canDelete ? 'Delete this number' : `Can delete in ${daysRemaining} day${daysRemaining === 1 ? '' : 's'}`;
        const deleteBtn = `<button class="ai-number-delete btn--danger" data-number-id="${escapeHtml(String(n.id))}" ${canDelete ? '' : 'disabled'} title="${deleteTitle}">Delete</button>`;
        tr.innerHTML =
          `<td>${escapeHtml(n.phone_number || '')}</td>`+
          `<td><select class="ai-number-agent-select" data-number-id="${escapeHtml(String(n.id))}" style="width:200px">${agentOptions}</select></td>`+
          `<td>${unassignBtn} ${deleteBtn}</td>`;
        tbody.appendChild(tr);
        const sel = tr.querySelector('select');
        if (sel) sel.value = n.agent_id ? String(n.agent_id) : '';
      }

      empty.style.display = 'none';
      table.style.display = 'table';
      applyAiNumbersBalanceLock();
    }

    async function loadAiAgents(){
      const empty = $('#ai-agents-empty');
      const table = $('#ai-agents-table');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      try {
        const r = await fetch('/api/me/ai/agents');
        const j = await r.json();
        if (!j || j.success === false) {
          aiAgentsData = [];
          renderAiAgents();
          if (empty) empty.textContent = j?.message || 'Failed to load agents';
          return;
        }
        aiAgentsData = Array.isArray(j.data) ? j.data : [];
        renderAiAgents();
        // agent list impacts number assignment dropdowns
        renderAiNumbers();
      } catch (e) {
        aiAgentsData = [];
        renderAiAgents();
        if (empty) empty.textContent = 'Failed to load agents';
      }
    }

    async function loadAiNumbers(){
      const empty = $('#ai-numbers-empty');
      const table = $('#ai-numbers-table');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      try {
        const r = await fetch('/api/me/ai/numbers');
        const j = await r.json();
        if (!j || j.success === false) {
          aiNumbersData = [];
          renderAiNumbers();
          if (empty) empty.textContent = j?.message || 'Failed to load numbers';
          return;
        }
        aiNumbersData = Array.isArray(j.data) ? j.data : [];
        renderAiNumbers();
      } catch (e) {
        aiNumbersData = [];
        renderAiNumbers();
        if (empty) empty.textContent = 'Failed to load numbers';
      }
    }

    function openAiAgentModal(agent){
      const modal = $('#aiAgentModal');
      if (!modal) return;
      $('#aiAgentId').value = agent ? String(agent.id) : '';
      $('#aiAgentModalTitle').textContent = agent ? 'ü§ñ Edit AI Agent' : 'ü§ñ Create AI Agent';
      $('#aiAgentName').value = agent ? String(agent.display_name || '') : '';
      $('#aiAgentGreeting').value = agent ? String(agent.greeting || '') : '';
      $('#aiAgentPrompt').value = agent ? String(agent.prompt || '') : '';
      try { $('#aiAgentTransferNumber').value = agent ? String(agent.transfer_to_number || '') : ''; } catch {}

      // Inbound direct transfer settings
      const inboundTransferEnabled = agent ? Boolean(agent.inbound_transfer_enabled) : false;
      const inboundTransferNumber = agent ? String(agent.inbound_transfer_number || '') : '';
      
      try {
        $('#aiAgentInboundTransferEnabled').checked = inboundTransferEnabled;
        $('#aiAgentInboundTransferNumber').value = inboundTransferNumber;
        $('#aiAgentInboundTransferNumber').disabled = !inboundTransferEnabled;
      } catch {}

      // Background ambience
      const bgUrl = agent ? String(agent.background_audio_url || '') : '';
      const bgGain = agent && agent.background_audio_gain != null ? String(agent.background_audio_gain) : '';
      const bgUploaded = agent ? Boolean(Number(agent.background_audio_uploaded || 0)) : false;
      const bgUploadName = agent ? String(agent.background_audio_upload_filename || '') : '';
      const bgUploadSize = agent && agent.background_audio_upload_size_bytes != null ? Number(agent.background_audio_upload_size_bytes) : null;

      try { $('#aiAgentBackgroundAudioUrl').value = bgUrl; } catch {}
      try { $('#aiAgentBackgroundAudioGain').value = bgGain || ((bgUrl || bgUploaded) ? '0.06' : ''); } catch {}
      try { $('#aiAgentBackgroundAudioFile').value = ''; } catch {}

      const bgRemoveBtn = $('#aiRemoveBackgroundAudioBtn');
      if (bgRemoveBtn) {
        bgRemoveBtn.style.display = bgUploaded ? 'inline-block' : 'none';
      }

      // Uploaded file status / selection helper text
      const fileLabel = $('#aiAgentBackgroundAudioFileName');
      if (fileLabel) {
        if (bgUploaded) {
          const pieces = [];
          if (bgUploadName) pieces.push(bgUploadName);
          if (bgUploadSize != null && Number.isFinite(bgUploadSize)) {
            pieces.push(`${Math.max(1, Math.round(bgUploadSize / 1024))} KB`);
          }
          fileLabel.textContent = `Uploaded: ${pieces.join(' ‚Ä¢ ') || 'WAV file'}`;
        } else {
          fileLabel.textContent = bgUrl ? 'No file uploaded (using URL).' : 'No file uploaded.';
        }
        fileLabel.dataset.defaultText = fileLabel.textContent;
      }

      // Allow editing URL even when an upload exists (URL acts as fallback)
      try { $('#aiAgentBackgroundAudioUrl').disabled = false; } catch {}

      // Default template selection
      const desiredTemplateId = agent && agent.default_doc_template_id ? String(agent.default_doc_template_id) : '';
      refreshAgentDefaultTemplateSelectOptions();
      try { $('#aiAgentDefaultTemplateSelect').value = desiredTemplateId; } catch {}
      loadDocTemplates().then(() => {
        try { $('#aiAgentDefaultTemplateSelect').value = desiredTemplateId; } catch {}
      });

      // Voice selection
      const desiredVoiceId = agent ? String(agent.cartesia_voice_id || '') : '';
      applyAiVoiceSelection(desiredVoiceId);
      loadCartesiaVoices(false).then(()=>applyAiVoiceSelection(desiredVoiceId));

      modal.style.display = 'flex';
      try { $('#aiAgentName').focus(); } catch {}
    }

    function closeAiAgentModal(){
      const modal = $('#aiAgentModal');
      if (modal) modal.style.display = 'none';
    }

    // AI Agent quickstart templates
    const AI_TEMPLATES = {
      'blank': {
        greeting: '',
        prompt: ''
      },
      'customer-support': {
        greeting: 'Hello! Thank you for calling. My name is Alex and I\'m here to help you with any questions or issues you may have. How can I assist you today?',
        prompt: `You are a Customer Support Specialist for our company. Your role is to provide exceptional customer service by:

1. Listening carefully to customer concerns and questions
2. Providing accurate information about products and services
3. Troubleshooting technical issues step-by-step
4. Escalating complex issues to human agents when necessary
5. Following up to ensure customer satisfaction

Guidelines:
- Always be patient, empathetic, and professional
- Ask clarifying questions to fully understand the issue
- Offer solutions and alternatives when possible
- If you cannot resolve an issue, offer to transfer to a specialist
- Thank customers for their patience and business`
      },
      'lead-qualification': {
        greeting: 'Hi there! Thanks for your interest in learning more about our solutions. I\'m here to understand your needs and see how we might be able to help. May I ask what prompted your call today?',
        prompt: `You are a Lead Qualification Specialist. Your role is to identify and qualify potential customers by:

1. Understanding their business needs and challenges
2. Determining their timeline and budget considerations
3. Identifying decision-makers and buying process
4. Assessing fit with our products/services
5. Scheduling qualified leads with sales representatives

Qualification Criteria:
- Business size and industry
- Current pain points and goals
- Budget range and timeline
- Decision-making authority
- Level of interest and urgency

Guidelines:
- Be consultative, not pushy
- Ask open-ended questions
- Listen more than you talk
- Provide value in every interaction
- If qualified, offer to schedule a meeting with a sales rep`
      },
      'appointment-scheduler': {
        greeting: 'Hello! Thank you for calling. I can help you schedule, reschedule, or manage your appointments. What would you like to do today?',
        prompt: `You are an Appointment Scheduler. Your role is to efficiently manage appointment bookings by:

1. Helping callers book new appointments
2. Rescheduling or canceling existing appointments
3. Confirming appointment details and requirements
4. Providing information about services and preparation needed
5. Sending confirmation details via email when requested

Information to Collect:
- Full name and contact information
- Preferred date and time
- Type of appointment/service needed
- Any special requirements or notes

Guidelines:
- Confirm all details before finalizing
- Offer alternative times if preferred slot is unavailable
- Explain any preparation required for the appointment
- Provide clear confirmation of what was scheduled`
      },
      'info-collector': {
        greeting: 'Hello! I\'m here to help collect some information from you. This should only take a few minutes. Are you ready to begin?',
        prompt: `You are an Information Collector. Your role is to gather accurate and complete information by:

1. Asking clear, specific questions one at a time
2. Confirming information for accuracy
3. Explaining why information is needed when asked
4. Ensuring data privacy and compliance
5. Providing a summary at the end

Guidelines:
- Be patient and allow time for responses
- Repeat back information to confirm accuracy
- Explain data handling practices if asked
- Thank the caller for their cooperation
- Offer to email a summary of collected information

Remember to:
- Ask one question at a time
- Use simple, clear language
- Be respectful of the caller's time
- Handle sensitive information appropriately`
      },
      'care-coordinator': {
        greeting: 'Hello, thank you for calling. I\'m here to help coordinate your care and answer any health-related questions. How may I assist you today?',
        prompt: `You are a Care Coordinator. Your role is to assist patients with healthcare coordination while maintaining HIPAA compliance:

1. Scheduling medical appointments
2. Answering general health questions
3. Coordinating between healthcare providers
4. Providing pre-appointment instructions
5. Following up on patient care

Important Guidelines:
- Never provide medical diagnoses or specific medical advice
- For emergencies, direct callers to call 911
- Maintain patient confidentiality at all times
- Verify patient identity before discussing personal health information
- Transfer to medical staff for clinical questions

Services You Can Help With:
- Appointment scheduling and rescheduling
- General office information
- Insurance and billing questions (general)
- Prescription refill requests (forwarding to appropriate staff)
- Post-visit follow-up coordination`
      },
      'feedback-gatherer': {
        greeting: 'Hi! Thank you for taking the time to share your feedback with us. Your input helps us improve our products and services. This survey will only take about 5 minutes. Ready to begin?',
        prompt: `You are a Feedback Gatherer. Your role is to collect valuable customer feedback through engaging conversations:

1. Conduct customer satisfaction surveys
2. Gather product/service feedback
3. Collect Net Promoter Score (NPS) responses
4. Document suggestions and complaints
5. Thank customers for their valuable input

Survey Best Practices:
- Keep questions clear and concise
- Use a mix of rating scales and open-ended questions
- Don't lead or bias responses
- Show appreciation for feedback
- Offer to connect them with support if issues arise

Sample Questions:
- On a scale of 1-10, how likely are you to recommend us?
- What did you like most about your experience?
- What could we improve?
- Is there anything else you'd like to share?

Guidelines:
- Be enthusiastic but not pushy
- Respect if they want to end the survey early
- Summarize key feedback at the end
- Offer to email a thank-you note`
      }
    };

    function openAiTemplateModal(){
      const modal = $('#aiTemplateModal');
      if (!modal) return;
      // Reset name input
      const nameInput = $('#aiTemplateAgentName');
      if (nameInput) nameInput.value = '';
      modal.style.display = 'flex';
      if (nameInput) nameInput.focus();
    }

    function closeAiTemplateModal(){
      const modal = $('#aiTemplateModal');
      if (modal) modal.style.display = 'none';
    }

    function selectTemplate(templateId){
      const template = AI_TEMPLATES[templateId] || AI_TEMPLATES['blank'];
      const agentName = ($('#aiTemplateAgentName').value || '').trim() || 'New Assistant';
      closeAiTemplateModal();
      // Open agent modal with template data pre-filled
      openAiAgentModalWithTemplate(agentName, template);
    }

    function openAiAgentModalWithTemplate(name, template){
      const modal = $('#aiAgentModal');
      if (!modal) return;
      $('#aiAgentId').value = '';
      $('#aiAgentModalTitle').textContent = 'ü§ñ Create AI Agent';
      $('#aiAgentName').value = name || '';
      $('#aiAgentGreeting').value = template.greeting || '';
      $('#aiAgentPrompt').value = template.prompt || '';
      try { $('#aiAgentTransferNumber').value = ''; } catch {}

      // Reset inbound transfer fields
      try {
        $('#aiAgentInboundTransferEnabled').checked = false;
        $('#aiAgentInboundTransferNumber').value = '';
        $('#aiAgentInboundTransferNumber').disabled = true;
      } catch {}

      // Reset background audio fields
      try { $('#aiAgentBackgroundAudioUrl').value = ''; } catch {}
      try { $('#aiAgentBackgroundAudioGain').value = ''; } catch {}
      try { $('#aiAgentBackgroundAudioFile').value = ''; } catch {}
      const bgRemoveBtn = $('#aiRemoveBackgroundAudioBtn');
      if (bgRemoveBtn) bgRemoveBtn.style.display = 'none';
      const fileLabel = $('#aiAgentBackgroundAudioFileName');
      if (fileLabel) {
        fileLabel.textContent = 'No file uploaded.';
        fileLabel.dataset.defaultText = fileLabel.textContent;
      }

      // Reset template selection
      refreshAgentDefaultTemplateSelectOptions();
      try { $('#aiAgentDefaultTemplateSelect').value = ''; } catch {}

      // Reset voice selection
      applyAiVoiceSelection('');
      loadCartesiaVoices(false);

      modal.style.display = 'flex';
      try { $('#aiAgentName').focus(); } catch {}
    }

    // Template modal handlers
    $('#cancelAiTemplateBtn').addEventListener('click', () => closeAiTemplateModal());
    $('#aiTemplateModal').addEventListener('click', (e) => { if (e.target === $('#aiTemplateModal')) closeAiTemplateModal(); });

    // Template card click handlers
    document.querySelectorAll('.ai-template-card').forEach(card => {
      card.addEventListener('click', () => {
        const templateId = card.getAttribute('data-template');
        if (templateId) selectTemplate(templateId);
      });
      // Hover effect
      card.addEventListener('mouseenter', () => {
        card.style.borderColor = 'rgba(34,211,238,.45)';
        card.style.background = 'rgba(34,211,238,.08)';
      });
      card.addEventListener('mouseleave', () => {
        card.style.borderColor = 'rgba(0,0,0,.12)';
        card.style.background = 'rgba(0,0,0,.03)';
      });
    });

    // AI modal handlers
    $('#createAiAgentBtn').addEventListener('click', () => openAiTemplateModal());
    $('#cancelAiAgentBtn').addEventListener('click', () => closeAiAgentModal());
    $('#aiAgentModal').addEventListener('click', (e) => { if (e.target === $('#aiAgentModal')) closeAiAgentModal(); });

    // Inbound transfer checkbox toggle
    $('#aiAgentInboundTransferEnabled').addEventListener('change', (e) => {
      const enabled = e.target.checked;
      $('#aiAgentInboundTransferNumber').disabled = !enabled;
      if (enabled) {
        $('#aiAgentInboundTransferNumber').focus();
      }
    });

    // Background audio upload UI
    const bgFileInputEl = $('#aiAgentBackgroundAudioFile');
    if (bgFileInputEl) {
      bgFileInputEl.addEventListener('change', () => {
        const f = bgFileInputEl && bgFileInputEl.files ? bgFileInputEl.files[0] : null;
        const label = $('#aiAgentBackgroundAudioFileName');
        if (!label) return;
        if (f) {
          label.textContent = `Selected: ${String(f.name || 'WAV file')}`;
        } else {
          label.textContent = label.dataset.defaultText || label.textContent;
        }
      });
    }

    // Remove uploaded background audio
    $('#aiRemoveBackgroundAudioBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const id = ($('#aiAgentId').value || '').trim();
      if (!id) return showToast('Save the agent first.', 'error');
      if (!confirm('Remove uploaded background audio for this agent?')) return;

      const btn = $('#aiRemoveBackgroundAudioBtn');
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Removing...';

      try {
        const r = await fetch(`/api/me/ai/agents/${encodeURIComponent(id)}/background-audio`, { method: 'DELETE' });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to remove background audio', 'error');
          return;
        }
        showToast('Background audio removed.');
        closeAiAgentModal();
        await loadAiAgents();
        await loadAiNumbers();
      } catch (err) {
        showToast('Failed to remove background audio', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });

    // Voice picker handlers
    $('#aiLoadVoicesBtn').addEventListener('click', () => loadCartesiaVoices(true));
    $('#aiAgentCartesiaVoiceSelect').addEventListener('change', () => {
      const sel = $('#aiAgentCartesiaVoiceSelect');
      const custom = $('#aiAgentCartesiaVoiceCustom');
      const isCustom = sel && sel.value === '__custom__';
      setCartesiaCustomVisible(Boolean(isCustom));
      if (!isCustom && custom) custom.value = '';
    });

    $('#confirmAiAgentBtn').addEventListener('click', async () => {
      const id = ($('#aiAgentId').value || '').trim();
      const display_name = ($('#aiAgentName').value || '').trim();
      const greeting = ($('#aiAgentGreeting').value || '');
      const prompt = ($('#aiAgentPrompt').value || '');
      const cartesia_voice_id = getSelectedCartesiaVoiceId();
      const defaultTpl = ($('#aiAgentDefaultTemplateSelect').value || '').trim();
      const transfer_to_number = ($('#aiAgentTransferNumber').value || '').trim();
      const inbound_transfer_enabled = $('#aiAgentInboundTransferEnabled').checked;
      const inbound_transfer_number = ($('#aiAgentInboundTransferNumber').value || '').trim();

      const background_audio_url = ($('#aiAgentBackgroundAudioUrl').value || '').trim();
      const bgGainRaw = ($('#aiAgentBackgroundAudioGain').value || '').trim();
      let background_audio_gain = null;
      if (bgGainRaw) {
        const g = parseFloat(bgGainRaw);
        if (!Number.isFinite(g)) return showToast('Background volume must be a number.', 'error');
        if (g < 0 || g > 0.2) return showToast('Background volume must be between 0.0 and 0.2.', 'error');
        background_audio_gain = g;
      }
      if (background_audio_url && !/^https:\/\//i.test(background_audio_url)) {
        return showToast('Background sound URL must start with https://', 'error');
      }

      if (!display_name) return showToast('Agent name is required.', 'error');

      const btn = $('#confirmAiAgentBtn');
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = id ? 'Saving...' : 'Creating...';

      try {
        const url = id ? `/api/me/ai/agents/${encodeURIComponent(id)}` : '/api/me/ai/agents';
        const method = id ? 'PATCH' : 'POST';
        const r = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            display_name,
            greeting,
            prompt,
            cartesia_voice_id: (cartesia_voice_id || null),
            transfer_to_number,
            inbound_transfer_enabled,
            inbound_transfer_number: inbound_transfer_number ? inbound_transfer_number : null,
            default_doc_template_id: defaultTpl ? defaultTpl : null,
            background_audio_url: background_audio_url ? background_audio_url : null,
            background_audio_gain
          })
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save agent', 'error');
          return;
        }

        const savedId = id || (j && j.data && j.data.id != null ? String(j.data.id) : '');
        if (!id && savedId) {
          try { $('#aiAgentId').value = savedId; } catch {}
        }

        // Optional: upload background WAV (replaces any prior upload)
        const bgFileInput = $('#aiAgentBackgroundAudioFile');
        const bgFile = bgFileInput && bgFileInput.files ? bgFileInput.files[0] : null;
        if (bgFile && savedId) {
          if (bgFile.size && bgFile.size > (5 * 1024 * 1024)) {
            showToast('Background WAV must be 5MB or smaller.', 'error');
            return;
          }
          const fd = new FormData();
          fd.append('file', bgFile);
          const ur = await fetch(`/api/me/ai/agents/${encodeURIComponent(savedId)}/background-audio`, { method: 'POST', body: fd });
          const uj = await ur.json();
          if (!uj || uj.success === false) {
            showToast(uj?.message || 'Background audio upload failed', 'error');
            return;
          }
        }

        const msg = (id ? 'Agent updated.' : 'Agent created.') + (bgFile ? ' Background audio uploaded.' : '');
        showToast(msg);
        closeAiAgentModal();
        await loadAiAgents();
        await loadAiNumbers();
      } catch (e) {
        showToast('Failed to save agent', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });

    // SMTP + templates controls
    $('#saveSmtpBtn').addEventListener('click', (e) => { e.preventDefault(); saveSmtpSettings(); });
    $('#testSmtpBtn').addEventListener('click', (e) => { e.preventDefault(); testSmtpSettings(); });
    $('#saveAiTransferBtn').addEventListener('click', (e) => { e.preventDefault(); saveAiTransferSettings(); });
    $('#saveAiSmsSettingsBtn').addEventListener('click', (e) => { e.preventDefault(); saveAiSmsSettings(); });
    $('#aiSmsAllowedDidIds').addEventListener('change', () => { refreshAiSmsDefaultDidOptions(); });
    $('#saveMailSettingsBtn').addEventListener('click', (e) => { e.preventDefault(); saveMailSettings(); });
    $('#saveSquareSettingsBtn').addEventListener('click', (e) => { e.preventDefault(); saveSquareSettings(); });
    $('#saveStripeSettingsBtn').addEventListener('click', (e) => { e.preventDefault(); saveStripeSettings(); });

    $('#uploadDocTemplateBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const btn = $('#uploadDocTemplateBtn');
      if (!btn) return;

      const name = ($('#docTemplateName').value || '').trim();
      const fileInput = $('#docTemplateFile');
      const file = fileInput && fileInput.files ? fileInput.files[0] : null;
      if (!file) return showToast('Please choose a .docx file to upload.', 'error');

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Uploading...';
      try {
        const fd = new FormData();
        if (name) fd.append('name', name);
        fd.append('file', file);
        const r = await fetch('/api/me/ai/doc-templates', { method: 'POST', body: fd });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Upload failed', 'error');
          return;
        }
        showToast('Template uploaded.');
        try { $('#docTemplateName').value = ''; } catch {}
        try { $('#docTemplateFile').value = ''; } catch {}
        await loadDocTemplates();
        await loadAiAgents();
      } catch (e2) {
        showToast('Upload failed', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });

    // ========== Buy AI Numbers (Daily) ==========
    let buyAiNumberSearching = false;

    function setBuyAiNumberFeeNote(){
      const v = document.getElementById('aiBuyFeeValue');
      if (!v) return;
      const fee = Number.isFinite(AI_LOCAL_DID_FEE) ? AI_LOCAL_DID_FEE : 0;
      v.textContent = fee.toFixed(2);
    }

    function resetBuyAiNumberResults(statusText){
      const table = document.getElementById('ai-buy-results-table');
      const empty = document.getElementById('ai-buy-results-empty');
      const status = document.getElementById('aiBuySearchStatus');
      if (table){
        const tbody = table.querySelector('tbody');
        if (tbody) tbody.innerHTML = '';
        table.style.display = 'none';
      }
      if (empty){ empty.style.display = 'none'; empty.textContent = ''; }
      if (status && statusText){ status.textContent = statusText; }
    }

    function openBuyAiNumberModal(){
      const modal = document.getElementById('buyAiNumberModal');
      if (!modal) return;
      modal.style.display = 'flex';
      setBuyAiNumberFeeNote();
      resetBuyAiNumberResults('Select a state and click Search.');
    }

    function closeBuyAiNumberModal(){
      const modal = document.getElementById('buyAiNumberModal');
      if (!modal) return;
      modal.style.display = 'none';
    }

    function renderBuyAiNumberResults(items){
      const table = document.getElementById('ai-buy-results-table');
      const tbody = table ? table.querySelector('tbody') : null;
      const empty = document.getElementById('ai-buy-results-empty');
      if (tbody) tbody.innerHTML = '';
      const arr = Array.isArray(items) ? items : [];
      if (!arr.length){
        if (table) table.style.display = 'none';
        if (empty){ empty.style.display = 'block'; empty.textContent = 'No numbers found for that search.'; }
        return;
      }
      if (empty){ empty.style.display = 'none'; empty.textContent = ''; }
      for (const it of arr){
        const num = String(it && (it.number || it.phone_number || it.phoneNumber) ? (it.number || it.phone_number || it.phoneNumber) : '').trim();
        if (!num) continue;
        const loc = [it.city, it.region].filter(Boolean).join(', ') || '-';
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${escapeHtml(num)}</td>`+
          `<td>${escapeHtml(loc)}</td>`+
          `<td><button type="button" class="ai-buy-number btn--primary" data-number="${escapeHtml(num)}">Buy</button></td>`;
        if (tbody) tbody.appendChild(tr);
      }
      if (table) table.style.display = 'table';
    }

    async function searchAvailableAiNumbers(){
      if (buyAiNumberSearching) return;
      const status = document.getElementById('aiBuySearchStatus');
      const btn = document.getElementById('aiBuySearchBtn');
      const params = new URLSearchParams();
      params.set('limit', '25');

      const region = String(document.getElementById('aiBuyRegion')?.value || '').trim();
      const city = String(document.getElementById('aiBuyCity')?.value || '').trim();
      if (!region && !city){
        showToast('Select a state or enter a city.', 'error');
        if (status) status.textContent = 'Select a state or enter a city.';
        return;
      }
      if (region) params.set('region', region);
      if (city) params.set('city', city);

      buyAiNumberSearching = true;
      if (btn){ btn.disabled = true; btn.textContent = 'Searching...'; }
      if (status) status.textContent = 'Searching...';
      resetBuyAiNumberResults();

      try {
        const r = await fetch(`/api/me/ai/numbers/available?${params.toString()}`);
        const j = await r.json().catch(() => null);
        if (!r.ok || !j || j.success === false){
          showToast(j?.message || 'Search failed', 'error');
          if (status) status.textContent = j?.message || 'Search failed. Please try again.';
          return;
        }
        const arr = Array.isArray(j.data) ? j.data : [];
        renderBuyAiNumberResults(arr);
        if (status) status.textContent = arr.length ? `Found ${arr.length} result${arr.length === 1 ? '' : 's'}.` : 'No results.';
      } catch (e){
        showToast('Search failed', 'error');
        if (status) status.textContent = 'Search failed. Please try again.';
      } finally {
        buyAiNumberSearching = false;
        if (btn){ btn.disabled = false; btn.textContent = 'Search'; }
      }
    }

    // Modal wire-up
    (function initBuyAiNumberModal(){
      const modal = document.getElementById('buyAiNumberModal');
      if (!modal) return;

      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeBuyAiNumberModal();
      });

      const closeBtn = document.getElementById('closeBuyAiNumberModalBtn');
      if (closeBtn) closeBtn.addEventListener('click', () => closeBuyAiNumberModal());

      const searchBtn = document.getElementById('aiBuySearchBtn');
      if (searchBtn) searchBtn.addEventListener('click', () => searchAvailableAiNumbers());

      ['aiBuyRegion', 'aiBuyCity'].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('keypress', (ev) => {
          if (ev.key === 'Enter') { ev.preventDefault(); searchAvailableAiNumbers(); }
        });
      });

      modal.addEventListener('click', async (ev) => {
        const btn = ev.target && ev.target.closest ? ev.target.closest('button.ai-buy-number') : null;
        if (!btn) return;

        if (aiNumbersBalanceLocked()) {
          showToast('Balance must be positive to buy/assign AI numbers. Add funds to continue.', 'error');
          applyAiNumbersBalanceLock();
          return;
        }

        const number = String(btn.getAttribute('data-number') || '').trim();
        if (!number) return;
        if (!confirm(`Purchase ${number}? You will be charged monthly.`)) return;

        btn.disabled = true;
        const old = btn.textContent;
        btn.textContent = 'Buying...';

        try {
          const r = await fetch('/api/me/ai/numbers/buy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ number })
          });
          const j = await r.json().catch(() => null);
          if (!r.ok || !j || j.success === false) {
            showToast(j?.message || 'Failed to buy number', 'error');
            return;
          }
          showToast('Number purchased.');
          closeBuyAiNumberModal();
          await loadAiNumbers();
        } catch (e) {
          showToast('Failed to buy number', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = old;
        }
      });
    })();

    // Buy number (opens modal)
    $('#buyAiNumberBtn').addEventListener('click', () => {
      if (aiNumbersBalanceLocked()) {
        showToast('Balance must be positive to buy/assign AI numbers. Add funds to continue.', 'error');
        applyAiNumbersBalanceLock();
        if (document.getElementById('addFundModal')) {
          document.getElementById('addFundModal').style.display = 'flex';
          try { document.getElementById('fundAmount')?.focus(); } catch {}
        }
        return;
      }
      openBuyAiNumberModal();
    });

    // Delegated handlers for edit/delete + assign/unassign
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('edit-ai-agent')) {
        const id = ev.target.getAttribute('data-id');
        const agent = aiAgentsData.find(a => String(a.id) === String(id));
        openAiAgentModal(agent || null);
      }
      if (ev.target && ev.target.classList.contains('redeploy-ai-agent')) {
        const btn = ev.target;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Redeploy this agent now? This will restart the agent service and may interrupt active calls.')) return;

        btn.disabled = true;
        const old = btn.textContent;
        btn.textContent = 'Redeploying...';

        try {
          const r = await fetch(`/api/me/ai/agents/${encodeURIComponent(id)}/redeploy`, { method: 'POST' });
          const j = await r.json().catch(() => null);
          if (!r.ok || !j || j.success === false) {
            showToast(j?.message || 'Failed to redeploy agent', 'error');
            return;
          }
          showToast('Agent redeployed.');
          await loadAiAgents();
          await loadAiNumbers();
        } catch {
          showToast('Failed to redeploy agent', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = old;
        }
      }
      if (ev.target && ev.target.classList.contains('del-ai-agent')) {
        const id = ev.target.getAttribute('data-id');
        if (!confirm('Delete this agent?')) return;
        try {
          const r = await fetch(`/api/me/ai/agents/${encodeURIComponent(id)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to delete agent', 'error');
            return;
          }
          showToast('Agent deleted.');
          await loadAiAgents();
          await loadAiNumbers();
        } catch {
          showToast('Failed to delete agent', 'error');
        }
      }
      if (ev.target && ev.target.classList.contains('ai-number-unassign')) {
        if (aiNumbersBalanceLocked()) {
          showToast('Balance must be positive to buy/assign AI numbers. Add funds to continue.', 'error');
          applyAiNumbersBalanceLock();
          return;
        }
        const numberId = ev.target.getAttribute('data-number-id');
        try {
          const r = await fetch(`/api/me/ai/numbers/${encodeURIComponent(numberId)}/unassign`, { method: 'POST' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to unassign number', 'error');
            return;
          }
          showToast('Number unassigned.');
          await loadAiAgents();
          await loadAiNumbers();
        } catch {
          showToast('Failed to unassign number', 'error');
        }
      }
      if (ev.target && ev.target.classList.contains('ai-number-delete')) {
        const numberId = ev.target.getAttribute('data-number-id');
        if (!confirm('Delete this AI phone number? This will release the number and cannot be undone.')) return;
        const btn = ev.target;
        btn.disabled = true;
        const old = btn.textContent;
        btn.textContent = 'Deleting...';
        try {
          const r = await fetch(`/api/me/ai/numbers/${encodeURIComponent(numberId)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to delete number', 'error');
            btn.disabled = false;
            btn.textContent = old;
            return;
          }
          showToast('Number deleted.');
          await loadAiAgents();
          await loadAiNumbers();
        } catch {
          showToast('Failed to delete number', 'error');
          btn.disabled = false;
          btn.textContent = old;
        }
      }
      if (ev.target && ev.target.classList.contains('ai-doc-template-delete')) {
        const tplId = ev.target.getAttribute('data-id');
        if (!tplId) return;
        if (!confirm('Delete this document template?')) return;
        try {
          const r = await fetch(`/api/me/ai/doc-templates/${encodeURIComponent(tplId)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Delete failed', 'error');
            return;
          }
          showToast('Template deleted.');
          await loadDocTemplates();
          await loadAiAgents();
        } catch {
          showToast('Delete failed', 'error');
        }
      }
    });

    document.addEventListener('change', async (ev) => {
      if (!ev.target || !ev.target.classList.contains('ai-number-agent-select')) return;
      const select = ev.target;
      const numberId = select.getAttribute('data-number-id');
      const agentId = select.value;

      if (aiNumbersBalanceLocked()) {
        showToast('Balance must be positive to buy/assign AI numbers. Add funds to continue.', 'error');
        applyAiNumbersBalanceLock();
        await loadAiNumbers();
        return;
      }

      select.disabled = true;
      try {
        if (!agentId) {
          const r = await fetch(`/api/me/ai/numbers/${encodeURIComponent(numberId)}/unassign`, { method: 'POST' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to unassign number', 'error');
            await loadAiNumbers();
            return;
          }
          showToast('Number unassigned.');
        } else {
          const r = await fetch(`/api/me/ai/numbers/${encodeURIComponent(numberId)}/assign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agent_id: agentId })
          });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to assign number', 'error');
            await loadAiNumbers();
            return;
          }
          showToast('Number assigned.');
        }
        await loadAiAgents();
        await loadAiNumbers();
      } catch (e) {
        showToast('Failed to update assignment', 'error');
        await loadAiNumbers();
      } finally {
        select.disabled = false;
      }
    });

    let callsChart = null;
    let callDistributionChart = null;
    let emailStatusChart = null;
    let smsStatusChart = null;
    let meetingStatusChart = null;
    let mailStatusChart = null;
    let paymentStatusChart = null;

    const STATUS_COLORS = {
      completed: 'rgba(16,185,129,0.8)',
      pending: 'rgba(245,158,11,0.8)',
      failed: 'rgba(239,68,68,0.8)',
      submitted: 'rgba(59,130,246,0.8)',
      unknown: 'rgba(156,163,175,0.8)',
      delivered: 'rgba(34,211,238,0.8)',
      sent: 'rgba(79,70,229,0.8)',
      queued: 'rgba(167,139,250,0.8)'
    };

    function getStatusColor(status) {
      const s = String(status || '').toLowerCase();
      return STATUS_COLORS[s] || STATUS_COLORS.unknown;
    }

    function formatStatusLabel(status) {
      const s = String(status || 'unknown');
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function renderPieChart(canvasId, emptyId, data, chartRef) {
      const canvas = document.getElementById(canvasId);
      const emptyEl = document.getElementById(emptyId);
      if (!canvas || !window.Chart) return null;

      const total = data.reduce((sum, d) => sum + d.count, 0);
      if (total === 0) {
        canvas.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
        if (chartRef) { chartRef.destroy(); return null; }
        return null;
      }

      canvas.style.display = 'block';
      if (emptyEl) emptyEl.style.display = 'none';

      const labels = data.map(d => formatStatusLabel(d.status));
      const values = data.map(d => d.count);
      const colors = data.map(d => getStatusColor(d.status));

      const ctx = canvas.getContext('2d');
      if (chartRef) {
        chartRef.data.labels = labels;
        chartRef.data.datasets[0].data = values;
        chartRef.data.datasets[0].backgroundColor = colors;
        chartRef.update();
        return chartRef;
      }

      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: 'rgba(0,0,0,.60)', font: { size: 10 }, boxWidth: 12 }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const val = context.raw || 0;
                  const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                  return `${context.label}: ${val} (${pct}%)`;
                }
              }
            }
          }
        }
      });
    }

    async function loadStats(){
      try{
        const fromInput = document.getElementById('from');
        const toInput = document.getElementById('to');
        let from = fromInput && fromInput.value;
        let to = toInput && toInput.value;
        if (!from || !to){
          const rng = defaultRange();
          from = rng.from; to = rng.to;
        }
        const q = new URLSearchParams();
        q.set('from', from);
        q.set('to', to);
        const r = await fetch('/api/me/stats?'+q.toString());
        const j = await r.json();
        if (!j || j.success === false) return;
        const k = j.kpis || {};
        const range = j.range || {};
        const elInbound = document.getElementById('kpiInbound');
        const elOutbound = document.getElementById('kpiOutbound');
        const elInboundToday = document.getElementById('kpiInboundToday');
        const elOutboundToday = document.getElementById('kpiOutboundToday');
        const elAiAgents = document.getElementById('kpiAiAgents');
        const elAiAgentsSub = document.getElementById('kpiAiAgentsSub');
        const elRange = document.getElementById('statsRangeText');
        if (elInbound) elInbound.textContent = (k.inboundCount != null ? String(k.inboundCount) : '‚Äì');
        if (elOutbound) elOutbound.textContent = (k.outboundCount != null ? String(k.outboundCount) : '‚Äì');
        if (elAiAgents) elAiAgents.textContent = (k.aiAgentCount != null ? String(k.aiAgentCount) : '‚Äì');
        if (elAiAgentsSub) elAiAgentsSub.textContent = '';
        if (elInboundToday) {
          if (k.inboundToday != null) elInboundToday.textContent = `Today: ${k.inboundToday}`;
          else elInboundToday.textContent = '';
        }
        if (elOutboundToday) {
          if (k.outboundToday != null) elOutboundToday.textContent = `Today: ${k.outboundToday}`;
          else elOutboundToday.textContent = '';
        }
        if (elRange && range.from && range.to){
          elRange.textContent = `Calls from ${range.from} to ${range.to}`;
        }

        // Daily calls bar chart
        const series = j.series || {};
        const byDay = Array.isArray(series.callsByDay) ? series.callsByDay : [];
        const labels = byDay.map(p=>p.date);
        const inboundData = byDay.map(p=>Number(p.inbound||0));
        const outboundData = byDay.map(p=>Number(p.outbound||0));
        const canvas = document.getElementById('callsChart');
        if (canvas && window.Chart) {
          const ctx = canvas.getContext('2d');
          if (!callsChart){
            callsChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels,
                datasets: [
                  { label: 'Inbound', data: inboundData, backgroundColor: 'rgba(34,197,94,0.7)' },
                  { label: 'Outbound', data: outboundData, backgroundColor: 'rgba(59,130,246,0.7)' }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    stacked: false,
                    ticks: { color: 'rgba(0,0,0,.55)' },
                    grid: { color: 'rgba(0,0,0,.08)' }
                  },
                  y: {
                    beginAtZero: true,
                    ticks: { precision: 0, color: 'rgba(0,0,0,.55)' },
                    grid: { color: 'rgba(0,0,0,.08)' }
                  }
                },
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: { color: 'rgba(0,0,0,.55)' }
                  }
                }
              }
            });
          } else {
            callsChart.data.labels = labels;
            if (callsChart.data.datasets[0]) callsChart.data.datasets[0].data = inboundData;
            if (callsChart.data.datasets[1]) callsChart.data.datasets[1].data = outboundData;
            callsChart.update();
          }
        }

        // Call distribution pie chart (inbound vs outbound)
        const totalInbound = inboundData.reduce((a, b) => a + b, 0);
        const totalOutbound = outboundData.reduce((a, b) => a + b, 0);
        const callDistCanvas = document.getElementById('callDistributionChart');
        if (callDistCanvas && window.Chart && (totalInbound > 0 || totalOutbound > 0)) {
          const cdCtx = callDistCanvas.getContext('2d');
          if (!callDistributionChart) {
            callDistributionChart = new Chart(cdCtx, {
              type: 'doughnut',
              data: {
                labels: ['Inbound', 'Outbound'],
                datasets: [{
                  data: [totalInbound, totalOutbound],
                  backgroundColor: ['rgba(34,197,94,0.8)', 'rgba(59,130,246,0.8)'],
                  borderWidth: 0
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: { color: 'rgba(0,0,0,.60)', font: { size: 10 }, boxWidth: 12 }
                  }
                }
              }
            });
          } else {
            callDistributionChart.data.datasets[0].data = [totalInbound, totalOutbound];
            callDistributionChart.update();
          }
        }

        // Status breakdown pie charts
        const breakdowns = j.statusBreakdowns || {};
        emailStatusChart = renderPieChart('emailStatusChart', 'emailStatusEmpty', breakdowns.email || [], emailStatusChart);
        meetingStatusChart = renderPieChart('meetingStatusChart', 'meetingStatusEmpty', breakdowns.meeting || [], meetingStatusChart);
        mailStatusChart = renderPieChart('mailStatusChart', 'mailStatusEmpty', breakdowns.mail || [], mailStatusChart);

        // SMS: combine status + dlr_status for better breakdown
        const smsData = (breakdowns.sms || []).map(d => {
          let label = d.status || 'unknown';
          if (d.dlr_status && d.dlr_status !== d.status) {
            label = d.dlr_status;
          }
          return { status: label, count: d.count };
        });
        // Aggregate by status
        const smsAggregated = [];
        const smsMap = new Map();
        for (const d of smsData) {
          const existing = smsMap.get(d.status);
          if (existing) existing.count += d.count;
          else smsMap.set(d.status, { status: d.status, count: d.count });
        }
        smsMap.forEach(v => smsAggregated.push(v));
        smsStatusChart = renderPieChart('smsStatusChart', 'smsStatusEmpty', smsAggregated, smsStatusChart);

        // Payment status breakdown chart
        paymentStatusChart = renderPieChart('paymentStatusChart', 'paymentStatusEmpty', breakdowns.payment || [], paymentStatusChart);

      }catch(e){
        console.error('[loadStats]', e);
      }
    }

    async function loadProfile(){
      try{
        const r = await fetch('/api/me/profile');
        const j = await r.json();
        const d = j?.data || {};
        meProfile = d || null;

        const toolbar = document.getElementById('profile-toolbar');
        const saveBtn = document.getElementById('saveProfileAddressBtn');
        if (toolbar) toolbar.style.display = 'none';
        if (saveBtn) saveBtn.disabled = true;

        if (j.success){
          const body = $('#profile-table tbody');
          if (body) body.innerHTML = '';

          const balanceDisplay = d.balance !== null && d.balance !== undefined ? `$${Number(d.balance).toFixed(2)}` : 'Loading...';
          // Update header balance if element exists
          if (d.balance !== null && d.balance !== undefined && $('#currentBalance')) {
$('#currentBalance').innerHTML = `Current Balance: <strong style=\"color:#facc15\">$${Number(d.balance).toFixed(2)}</strong>`;
          }

          // Apply AI-number assignment lock when balance isn't positive.
          try { applyAiNumbersBalanceLock(); } catch {}

          const addRowText = (label, value) => {
            if (!body) return;
            const tr = document.createElement('tr');
            const th = document.createElement('th');
            th.textContent = String(label || '');
            const td = document.createElement('td');
            td.textContent = String(value ?? '');
            tr.appendChild(th);
            tr.appendChild(td);
            body.appendChild(tr);
          };

          const addRowInput = (label, id, value, opts) => {
            if (!body) return;
            const options = opts || {};
            const tr = document.createElement('tr');
            const th = document.createElement('th');
            th.textContent = String(label || '');
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            input.id = String(id || '');
            input.value = String(value ?? '');
            input.placeholder = String(options.placeholder || '');
            if (options.maxLength != null) input.maxLength = Number(options.maxLength);
            input.style.width = '100%';
            input.style.boxSizing = 'border-box';
            if (options.uppercase) {
              input.addEventListener('input', () => {
                input.value = String(input.value || '').toUpperCase();
              });
            }
            td.appendChild(input);
            tr.appendChild(th);
            tr.appendChild(td);
            body.appendChild(tr);
          };

          addRowText('Name', d.name || '');
          addRowText('Email', d.email || '');
          addRowText('Phone', d.phone || '');
          addRowText('Username', d.username || '');

          // Editable address
          addRowInput('Street Address', 'profileAddress1', d.address1 || '', { placeholder: 'Street address' });
          addRowInput('City', 'profileCity', d.city || '', { placeholder: 'City' });
          addRowInput('State / Province', 'profileState', d.state || '', { placeholder: 'State / Province' });
          addRowInput('ZIP / Postal Code', 'profilePostalCode', d.postalCode || '', { placeholder: 'ZIP / Postal Code' });
          addRowInput('Country', 'profileCountry', d.country || '', { placeholder: 'US', maxLength: 2, uppercase: true });

          const initialAddress = {
            address1: String(d.address1 || '').trim(),
            city: String(d.city || '').trim(),
            state: String(d.state || '').trim(),
            postalCode: String(d.postalCode || '').trim(),
            country: String(d.country || '').trim().toUpperCase(),
          };

          const getCurrentAddress = () => ({
            address1: String(document.getElementById('profileAddress1')?.value || '').trim(),
            city: String(document.getElementById('profileCity')?.value || '').trim(),
            state: String(document.getElementById('profileState')?.value || '').trim(),
            postalCode: String(document.getElementById('profilePostalCode')?.value || '').trim(),
            country: String(document.getElementById('profileCountry')?.value || '').trim().toUpperCase(),
          });

          const updateSaveState = () => {
            if (!saveBtn) return;
            const cur = getCurrentAddress();
            const dirty = cur.address1 !== initialAddress.address1
              || cur.city !== initialAddress.city
              || cur.state !== initialAddress.state
              || cur.postalCode !== initialAddress.postalCode
              || cur.country !== initialAddress.country;
            saveBtn.disabled = !dirty;
          };

          for (const inputId of ['profileAddress1','profileCity','profileState','profilePostalCode','profileCountry']) {
            const el = document.getElementById(inputId);
            if (!el) continue;
            el.addEventListener('input', updateSaveState);
            el.addEventListener('change', updateSaveState);
          }
          updateSaveState();

          addRowText('Signup IP', d.signupIp || '');
          addRowText('Balance', balanceDisplay);

          $('#profile-empty').style.display='none';
          $('#profile-table').style.display='table';
          if (toolbar) toolbar.style.display = 'flex';
          try { renderIncBankUi(); } catch {}
        } else {
          $('#profile-empty').textContent='No profile';
          $('#profile-empty').style.display = 'block';
          $('#profile-table').style.display = 'none';
        }
      } catch (e) {
        $('#profile-empty').textContent='Failed to load profile';
        $('#profile-empty').style.display = 'block';
        $('#profile-table').style.display = 'none';
      }
    }

    async function saveProfileAddress(){
      const btn = document.getElementById('saveProfileAddressBtn');
      if (!btn) return;

      const payload = {
        address1: String(document.getElementById('profileAddress1')?.value || '').trim(),
        city: String(document.getElementById('profileCity')?.value || '').trim(),
        state: String(document.getElementById('profileState')?.value || '').trim(),
        postalCode: String(document.getElementById('profilePostalCode')?.value || '').trim(),
        country: String(document.getElementById('profileCountry')?.value || '').trim(),
      };

      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = 'Saving...';
      let reloaded = false;

      try {
        const r = await fetch('/api/me/profile/address', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        let j;
        try { j = await r.json(); } catch { j = null; }

        if (!r.ok || !j || j.success !== true) {
          const msg = (j && j.message) ? String(j.message) : 'Failed to save address';
          showToast(msg, 'error');
          return;
        }

        showToast('Address saved');
        await loadProfile();
        reloaded = true;
      } catch (e) {
        showToast('Failed to save address', 'error');
      } finally {
        if (!reloaded) btn.disabled = false;
        btn.textContent = oldText || 'Save Address';
      }
    }

    (function bindProfileHandlers(){
      const btn = document.getElementById('saveProfileAddressBtn');
      if (btn && !btn._bound) {
        btn._bound = true;
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          saveProfileAddress();
        });
      }
    })();
    function defaultRange(){
      const now = new Date();
      const to = now.toISOString().slice(0,10);
      const d7 = new Date(now.getTime()-6*86400000);
      const from = d7.toISOString().slice(0,10);
      return {from,to};
    }
    let cdrPage = 0; const cdrPageSize = 50;
    
    async function loadCdr(){
      const from = $('#from').value;
      const to = $('#to').value;
      const filter = $('#cdrFilter').value;

      const q = new URLSearchParams();
      q.set('page', String(cdrPage));
      q.set('pageSize', String(cdrPageSize));
      if (from) q.set('from', from);
      if (to) q.set('to', to);

      try{
        let j;

        // Primary: /api/me/cdrs (does its own Magnus‚Üílocal outbound fallback)
        try {
          const r = await fetch('/api/me/cdrs?'+q.toString());
          j = await r.json();
          if (!j || j.success === false) {
            throw new Error('primary CDR fetch failed');
          }
        } catch (primaryErr) {
          // Last-resort: local-only endpoint if primary handler itself errors
          try {
            const r2 = await fetch('/api/me/cdrs/local?'+q.toString());
            const j2 = await r2.json();
            if (!j2 || j2.success === false) {
              throw j2 || primaryErr;
            }
            j = j2;
            console.warn('[loadCdr] Using /api/me/cdrs/local fallback because /api/me/cdrs failed.');
          } catch (fallbackErr) {
            const msg = (j && j.message) || (fallbackErr && fallbackErr.message) || 'Failed to load CDRs';
            $('#cdr-empty').textContent = msg;
            $('#cdr-empty').style.display = 'block';
            $('#cdr-table').style.display = 'none';
            $('#cdr-pager').style.display = 'none';
            return;
          }
        }

        let rows = Array.isArray(j.data) ? j.data : grabRows(j);
        const tbody = $('#cdr-table tbody');
        tbody.innerHTML='';

        // Apply inbound/outbound filter using direction from backend
        if (filter !== 'all') {
          const want = filter === 'inbound' ? 'inbound' : 'outbound';
          rows = rows.filter(c => String(c.direction || '').toLowerCase() === want);
        }

        if (!rows.length) {
          $('#cdr-empty').textContent = filter === 'all'
            ? 'No calls in this range yet.'
            : `No ${filter} calls in this range.`;
          $('#cdr-empty').style.display = 'block';
          $('#cdr-table').style.display = 'none';
          $('#cdr-pager').style.display = 'none';
          return;
        }

        rows.forEach(c => {
          const dir = String(c.direction || 'inbound').toLowerCase();
          const dirIcon = dir === 'outbound'
            ? '<span style="color:#3b82f6" title="Outbound">‚Üë</span>'
            : '<span style="color:#22c55e" title="Inbound">‚Üì</span>';

          const whenIso = c.timeStart || c.createdAt || null;
          const whenStr = whenIso ? new Date(whenIso).toLocaleString() : '';
          const src = c.srcNumber || '';
          const dst = c.dstNumber || c.didNumber || '';
          const durSec = c.billsec != null ? Number(c.billsec) : (c.duration != null ? Number(c.duration) : 0);
          const priceNum = c.price != null ? Number(c.price) : null;
          const priceStr = priceNum != null ? `$${priceNum.toFixed(4)}` : '';
          const statusRaw = (c.status != null ? String(c.status) : '').trim();
          let statusLabel = statusRaw
            ? statusRaw.replace(/_/g, ' ').replace(/(^|\s)\S/g, m => m.toUpperCase())
            : 'Completed';

          // Branding: don't expose internal vendor name ("Pipecat") in customer UI.
          statusLabel = statusLabel.replace(/^Pipecat\b/i, 'AI Agent');

          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td>${dirIcon}</td>`+
            `<td>${escapeHtml(whenStr)}</td>`+
            `<td>${escapeHtml(String(src))}</td>`+
            `<td>${escapeHtml(String(dst))}</td>`+
            `<td>${escapeHtml(String(durSec))}s</td>`+
            `<td>${escapeHtml(priceStr)}</td>`+
            `<td>${escapeHtml(statusLabel)}</td>`;
          tbody.appendChild(tr);
        });

        $('#cdr-empty').style.display='none';
        $('#cdr-table').style.display='table';
        $('#cdr-pager').style.display='flex';

        const total = typeof j.total === 'number' ? j.total : rows.length;
        const totalPages = Math.max(1, Math.ceil(total / cdrPageSize));
        $('#cdrPageInfo').textContent = `Page ${cdrPage+1} of ${totalPages}`;
      }catch(e){
        console.error('[loadCdr]', e);
        $('#cdr-empty').textContent='Failed to load CDRs';
        $('#cdr-empty').style.display='block';
        $('#cdr-table').style.display='none';
        $('#cdr-pager').style.display='none';
      }
    }
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function copyBtn(val){ const v = String(val||''); if (!v) return ''; return `<button class=\"copy\" data-val=\"${escapeHtml(v)}\">Copy</button>`; }
    function showToast(msg, type='success'){
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      if (type === 'error') {
        toast.style.background = 'rgba(239,68,68,.92)';
        toast.style.borderColor = 'rgba(239,68,68,.35)';
        toast.style.color = '#fff';
      }
      document.body.appendChild(toast);
      setTimeout(()=>{ toast.remove(); }, 3000);
    }
    function showLinkToast(message, linkLabel, linkUrl, type='success'){
      const toast = document.createElement('div');
      toast.className = 'toast';
      if (type === 'error') {
        toast.style.background = 'rgba(239,68,68,.92)';
        toast.style.borderColor = 'rgba(239,68,68,.35)';
        toast.style.color = '#fff';
      }
      const safeMsg = escapeHtml(message || '');
      const safeLabel = escapeHtml(linkLabel || 'Open');
      const href = linkUrl || '#';
      const linkColor = (type === 'error') ? '#fff' : '#bfdbfe';
      toast.innerHTML = `<div>${safeMsg}</div><div style=\"margin-top:4px;font-size:12px;\"><a href=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"color:${linkColor};text-decoration:underline;\">${safeLabel}</a></div>`;
      document.body.appendChild(toast);
      setTimeout(()=>{ toast.remove(); }, 8000);
    }
    function animateButton(btn){
      btn.classList.add('btn-clicked');
      setTimeout(()=>{ btn.classList.remove('btn-clicked'); }, 300);
    }
    // Global button click animation
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.tagName === 'BUTTON') animateButton(e.target);
    });

    // init
    const rng = defaultRange(); $('#from').value = rng.from; $('#to').value = rng.to;
    loadProfile(); loadCdr(); loadStats();

    // If redirected back from NOWPayments with ?payment=success or ?payment=cancel, handle it
    (function handlePaymentReturn() {
      try {
        const params = new URLSearchParams(window.location.search || '');
        const paymentStatus = params.get('payment');
        const method = (params.get('method') || '').toLowerCase();
        if (!paymentStatus) return;

        if (paymentStatus === 'success') {
          // Switch to Billing tab and refresh
          activate('billing');
          billingPage = 0;
          loadBillingHistory();
          loadProfile();
          const label = method === 'crypto' ? 'Crypto payment' : method === 'card' ? 'Card payment' : 'Payment';
          showToast(`${label} received! Your balance has been updated or will be shortly.`);
        } else if (paymentStatus === 'cancel') {
          const cancelLabel = method === 'crypto' ? 'Crypto payment was cancelled. No funds were added.' :
                             method === 'card' ? 'Card payment was cancelled. No funds were added.' :
                             'Payment was cancelled. No funds were added.';
          showToast(cancelLabel, 'error');
        }

        // Clean up URL so the message does not repeat on refresh
        if (window.history && window.history.replaceState) {
          const url = new URL(window.location.href);
          url.searchParams.delete('payment');
          url.searchParams.delete('method');
          window.history.replaceState({}, document.title, url.toString());
        }
      } catch (e) {
        console.error('[paymentReturn]', e);
      }
    })();
    $('#loadCdr').addEventListener('click', e=>{ e.preventDefault(); cdrPage=0; loadCdr(); loadStats(); });
    document.getElementById('cdrPrev').addEventListener('click', ()=>{ if (cdrPage>0) { cdrPage--; loadCdr(); } });
    document.getElementById('cdrNext').addEventListener('click', ()=>{ cdrPage++; loadCdr(); });
    
    document.addEventListener('click', async (ev)=>{
      if (ev.target && ev.target.classList.contains('copy')){
        const v = ev.target.getAttribute('data-val')||''; try { await navigator.clipboard.writeText(v); } catch {}
      }
    });

    // Trunk Management
    let trunksData = [];
    let trunkPage = 0; const trunkPageSize = 10;
    let trunkSearchQuery = '';


    async function loadTrunks() {
      try {
        const r = await fetch('/api/me/didww/trunks?kind=pstn');
        const j = await r.json();
        
        if (!j.success) {
          $('#trunk-empty').textContent = j.message || 'Failed to load trunks';
          return;
        }
        trunksData = j.data || [];
        renderTrunksTable();
      } catch (e) {
        console.error('[loadTrunks] error:', e);
        $('#trunk-empty').textContent = 'Failed to load trunks';
        $('#trunk-empty').style.display = 'block';
        $('#trunk-table').style.display = 'none';
        $('#trunk-pager').style.display = 'none';
      }
    }
    
    function renderTrunksTable() {
      // Apply search filter
      let filteredData = trunksData;
      if (trunkSearchQuery) {
        const q = trunkSearchQuery.toLowerCase();
        filteredData = trunksData.filter(trunk => {
          const attrs = trunk.attributes || {};
          const conf = attrs.configuration?.attributes || attrs.configuration || {};
          const name = (attrs.name || '').toLowerCase();
          const dst = (conf.dst || '').toLowerCase();
          const desc = (attrs.description || '').toLowerCase();
          return name.includes(q) || dst.includes(q) || desc.includes(q);
        });
      }
      
      const tbody = $('#trunk-table tbody');
      tbody.innerHTML = '';
      
      // Paginate
      const start = trunkPage * trunkPageSize;
      const paginated = filteredData.slice(start, start + trunkPageSize);
      const totalPages = Math.ceil(filteredData.length / trunkPageSize) || 1;
      
      if (filteredData.length === 0) {
        $('#trunk-empty').textContent = trunkSearchQuery ? 'No trunks match your search' : 'No trunks created yet - click the button above to create one';
        $('#trunk-empty').style.display = 'block';
        $('#trunk-table').style.display = 'none';
        $('#trunk-pager').style.display = 'none';
      } else {
        $('#trunk-empty').style.display = 'none';
        $('#trunk-table').style.display = 'table';
        $('#trunk-pager').style.display = 'flex';
        $('#trunkPageInfo').textContent = trunkSearchQuery ? `${filteredData.length} result(s)` : `Page ${trunkPage + 1} of ${totalPages}`;
        paginated.forEach(trunk => {
          const attrs = trunk.attributes || {};
          const conf = attrs.configuration?.attributes || attrs.configuration || {};
          const dst = conf.dst || '';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(attrs.name || '')}</td>`+
                        `<td>${escapeHtml(dst)}</td>`+
                        `<td>${escapeHtml(attrs.description || '')}</td>`+
                        `<td>${escapeHtml(attrs.capacity_limit || 'Unlimited')}</td>`+
                        `<td><button class="edit-trunk" data-id="${escapeHtml(trunk.id)}" data-name="${escapeHtml(attrs.name || '')}" data-dst="${escapeHtml(dst)}" data-desc="${escapeHtml(attrs.description || '')}" data-cap="${escapeHtml(attrs.capacity_limit || '')}">Edit</button> <button class="del-trunk" data-id="${escapeHtml(trunk.id)}">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      }
    }
    
    // Trunk search handlers
    $('#trunkSearchBtn').addEventListener('click', () => {
      trunkSearchQuery = $('#trunkSearch').value.trim();
      trunkPage = 0;
      renderTrunksTable();
    });

    $('#trunkClearBtn').addEventListener('click', () => {
      trunkSearchQuery = '';
      $('#trunkSearch').value = '';
      trunkPage = 0;
      renderTrunksTable();
    });
    
    $('#trunkSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        trunkSearchQuery = $('#trunkSearch').value.trim();
        trunkPage = 0;
        renderTrunksTable();
      }
    });
    
    // Trunk pagination
    document.getElementById('trunkPrev').addEventListener('click', () => { if (trunkPage > 0) { trunkPage--; renderTrunksTable(); } });
    document.getElementById('trunkNext').addEventListener('click', () => { 
      const filteredLen = trunkSearchQuery ? trunksData.filter(t => {
        const attrs = t.attributes || {};
        const conf = attrs.configuration?.attributes || attrs.configuration || {};
        const q = trunkSearchQuery.toLowerCase();
        return (attrs.name || '').toLowerCase().includes(q) || (conf.dst || '').toLowerCase().includes(q);
      }).length : trunksData.length;
      if ((trunkPage + 1) * trunkPageSize < filteredLen) { trunkPage++; renderTrunksTable(); }
    });

    // Trunk Modal handlers
    let trunkEditMode = false;
    
    $('#createTrunkBtn').addEventListener('click', () => {
      trunkEditMode = false;
      $('#trunkModalTitle').textContent = '‚Ü™Ô∏è Create Call Forwarding Trunk';
      $('#confirmTrunkBtn').textContent = 'Create Trunk';
      $('#editTrunkId').value = '';
      $('#newTrunkName').value = '';
      $('#newTrunkDst').value = '';
      $('#newTrunkDesc').value = '';
      $('#newTrunkCapacity').value = '';
      $('#trunkModal').style.display = 'flex';
      $('#newTrunkName').focus();
    });
    
    $('#cancelTrunkBtn').addEventListener('click', () => {
      $('#trunkModal').style.display = 'none';
    });
    
    $('#trunkModal').addEventListener('click', (e) => {
      if (e.target === $('#trunkModal')) {
        $('#trunkModal').style.display = 'none';
      }
    });
    
    // Edit trunk - open modal with data
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('edit-trunk')) {
        trunkEditMode = true;
        const btn = ev.target;
        $('#trunkModalTitle').textContent = '‚Ü™Ô∏è Edit Call Forwarding Trunk';
        $('#confirmTrunkBtn').textContent = 'Save Changes';
        $('#editTrunkId').value = btn.getAttribute('data-id');
        $('#newTrunkName').value = btn.getAttribute('data-name') || '';
        $('#newTrunkDst').value = btn.getAttribute('data-dst') || '';
        $('#newTrunkDesc').value = btn.getAttribute('data-desc') || '';
        $('#newTrunkCapacity').value = btn.getAttribute('data-cap') || '';
        $('#trunkModal').style.display = 'flex';
        $('#newTrunkName').focus();
      }
    });
    
    // Create or update trunk
    $('#confirmTrunkBtn').addEventListener('click', async () => {
      const name = $('#newTrunkName').value.trim();
      const dst = $('#newTrunkDst').value.trim();
      const description = $('#newTrunkDesc').value.trim();
      const capacity_limit = $('#newTrunkCapacity').value.trim();
      const editId = $('#editTrunkId').value;
      
      if (!name) return alert('Trunk name is required');
      if (!dst) return alert('PSTN destination number is required');
      if (!/^\d{11}$/.test(dst)) return alert('PSTN number must be 11 digits only');
      
      $('#confirmTrunkBtn').disabled = true;
      $('#confirmTrunkBtn').textContent = trunkEditMode ? 'Saving...' : 'Creating...';

      try {
        const payload = { name, dst, description };
        if (capacity_limit) payload.capacity_limit = parseInt(capacity_limit, 10);
        else if (trunkEditMode) payload.capacity_limit = null;
        
        let r;
        if (trunkEditMode && editId) {
          r = await fetch(`/api/me/didww/trunks/${encodeURIComponent(editId)}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else {
          r = await fetch('/api/me/didww/trunks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }
        const j = await r.json();
        if (!j.success) { alert(j.message || (trunkEditMode ? 'Update failed' : 'Create trunk failed')); return; }
        showToast(trunkEditMode ? 'Trunk updated successfully!' : `Trunk "${name}" created successfully!`);
        $('#trunkModal').style.display = 'none';
        loadTrunks();
      } catch (e) {
        console.error('[trunk] error:', e);
        alert(trunkEditMode ? 'Failed to update trunk' : 'Failed to create trunk');
      } finally {
        $('#confirmTrunkBtn').disabled = false;
        $('#confirmTrunkBtn').textContent = trunkEditMode ? 'Save Changes' : 'Create Trunk';
      }
    });

    // Delete trunk
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('del-trunk')) {
        const id = ev.target.getAttribute('data-id');
        if (!confirm('Delete this trunk?')) return;
        try {
          const r = await fetch(`/api/me/didww/trunks/${encodeURIComponent(id)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j.success) return alert(j.message || 'Delete failed');
          showToast('Trunk deleted successfully!');
          loadTrunks();
        } catch (e) {
          console.error('[deleteTrunk] error:', e);
          alert('Failed to delete trunk');
        }
      }
    });


    // ========== Billing History ==========
    
    let billingTotalPages = 1;
    
    async function loadBillingHistory() {
      const emptyEl = $('#billing-empty');
      const tableEl = $('#billing-table');
      const pagerEl = $('#billing-pager');
      try {
        const r = await fetch(`/api/me/billing-history?page=${billingPage}&pageSize=${billingPageSize}`);
        if (!r.ok) {
          if (r.status === 401) { window.location.href = '/login'; return; }
          throw new Error('HTTP ' + r.status);
        }
        const j = await r.json();
        if (!j || j.success === false) throw new Error(j?.message || 'Server error');
        billingData = j.data || [];
        const balance = j.balance;
        
        // Update balance display in header if element exists
        const balEl = $('#currentBalance');
        if (balance !== undefined && balance !== null && balEl) {
          balEl.innerHTML = `Current Balance: <strong style="color:#facc15">$${Number(balance).toFixed(2)}</strong>`;
        }

        // Keep in-memory profile balance in sync so AI-number assignment locking stays accurate.
        if (balance !== undefined && balance !== null) {
          try {
            if (!meProfile) meProfile = {};
            meProfile.balance = balance;
          } catch {}
          try { applyAiNumbersBalanceLock(); } catch {}
        }
        
        const tbody = tableEl ? tableEl.querySelector('tbody') : null;
        if (tbody) tbody.innerHTML = '';
        
        if (billingData.length === 0) {
          if (emptyEl) { emptyEl.textContent = 'No billing history yet.'; emptyEl.style.display = 'block'; }
          if (tableEl) tableEl.style.display = 'none';
          if (pagerEl) pagerEl.style.display = 'none';
          return;
        }
        
        billingData.forEach(row => {
          const tr = document.createElement('tr');
          const date = new Date(row.created_at).toLocaleString();
          const amountNum = Number(row.amount || 0);
          const isNegative = amountNum < 0;
          const amountColor = isNegative ? '#ef4444' : '#059669';
          const amountPrefix = isNegative ? '-$' : '+$';
          let decimals = 2;
          const absAmt = Math.abs(amountNum);
          if (absAmt > 0 && absAmt < 0.01) decimals = 4;
          const amountDisplay = absAmt.toFixed(decimals);
          const rawStatus = (row.status || 'completed').toLowerCase();
          let statusLabel;
          let statusClass;
          if (rawStatus === 'completed') { statusLabel = 'Completed'; statusClass = 'bill-status-completed'; }
          else if (rawStatus === 'pending') { statusLabel = 'Pending confirmation'; statusClass = 'bill-status-pending'; }
          else if (rawStatus === 'failed') { statusLabel = 'Failed'; statusClass = 'bill-status-failed'; }
          else { statusLabel = rawStatus.charAt(0).toUpperCase() + rawStatus.slice(1); statusClass = 'bill-status-pending'; }
          const statusBadge = `<span class="bill-status ${statusClass}">${escapeHtml(statusLabel)}</span>`;
          let desc = row.description || 'Account refill';
          let methodBadge = '';
          const lowerDesc = desc.toLowerCase();
          if (lowerDesc.includes('card refill')) {
            methodBadge = '<span class="bill-tag bill-tag-card">Card</span>';
          } else if (lowerDesc.includes('crypto refill')) {
            methodBadge = '<span class="bill-tag bill-tag-crypto">Crypto</span>';
          } else if (lowerDesc.includes('ach refill') || lowerDesc.includes('bill.com refill') || lowerDesc.includes('billcom refill')) {
            methodBadge = '<span class="bill-tag bill-tag-billcom">ACH</span>';
          }
          tr.innerHTML = `<td>${escapeHtml(date)}</td>`+
                        `<td style="color:${amountColor};font-weight:600">${amountPrefix}${escapeHtml(amountDisplay)}</td>`+
                        `<td>${methodBadge}${escapeHtml(desc)}</td>`+
                        `<td>${statusBadge}</td>`;
          if (tbody) tbody.appendChild(tr);
        });
        
        if (emptyEl) emptyEl.style.display = 'none';
        if (tableEl) tableEl.style.display = 'table';
        if (pagerEl) pagerEl.style.display = 'flex';
        billingTotalPages = Math.ceil((j.total || billingData.length) / billingPageSize) || 1;
        const pageInfoEl = $('#billingPageInfo');
        if (pageInfoEl) pageInfoEl.textContent = `Page ${billingPage + 1} of ${billingTotalPages}`;
      } catch (e) {
        console.error('[loadBillingHistory]', e);
        if (emptyEl) emptyEl.textContent = 'Failed to load billing history: ' + (e?.message || 'Unknown error');
      }
    }
    
    // Billing pagination
    $('#billingPrev').addEventListener('click', () => { if (billingPage > 0) { billingPage--; loadBillingHistory(); } });
    $('#billingNext').addEventListener('click', () => { if (billingPage < billingTotalPages - 1) { billingPage++; loadBillingHistory(); } });
    
    // Add Fund Modal
    function getSelectedFundMethod(){
      const methodInput = document.querySelector('input[name="fundMethod"]:checked');
      if (methodInput && methodInput.value) return String(methodInput.value || '');
      if (DEFAULT_FUND_METHOD) return String(DEFAULT_FUND_METHOD || '');
      if (Array.isArray(ADD_FUNDS_METHODS) && ADD_FUNDS_METHODS.length && ADD_FUNDS_METHODS[0] && ADD_FUNDS_METHODS[0].value) {
        return String(ADD_FUNDS_METHODS[0].value || '');
      }
      return 'card';
    }

    function getFundMethodLabel(method){
      const key = String(method || '').trim();
      return ADD_FUNDS_METHOD_LABELS[key] || key || 'Payment';
    }

    $('#addFundBtn').addEventListener('click', () => {
      $('#addFundModal').style.display = 'flex';
      $('#fundAmount').value = '';
      const fs = document.getElementById('fundStatus');
      if (fs) { fs.style.display = 'none'; fs.textContent = ''; }
      $('#fundAmount').focus();
    });
    
    $('#cancelFundBtn').addEventListener('click', () => {
      $('#addFundModal').style.display = 'none';
    });
    
    // Close modal on backdrop click
    $('#addFundModal').addEventListener('click', (e) => {
      if (e.target === $('#addFundModal')) {
        $('#addFundModal').style.display = 'none';
      }
    });
    
    $('#confirmFundBtn').addEventListener('click', async () => {
      const fundStatusEl = document.getElementById('fundStatus');
      if (fundStatusEl) { fundStatusEl.style.display = 'none'; fundStatusEl.textContent = ''; }
      const amount = parseFloat($('#fundAmount').value);

      if (!amount || !Number.isFinite(amount)) {
        return alert('Please enter a valid amount.');
      }
      if (amount < CHECKOUT_MIN_AMOUNT || amount > CHECKOUT_MAX_AMOUNT) {
        return alert(`Amount must be between $${CHECKOUT_MIN_AMOUNT.toFixed(2)} and $${CHECKOUT_MAX_AMOUNT.toFixed(2)}.`);
      }

      const method = getSelectedFundMethod();
      if (!method) {
        return alert('No payment method is available right now.');
      }
      const methodLabel = getFundMethodLabel(method);

      const endpoint = method === 'crypto'
        ? '/api/me/nowpayments/checkout'
        : method === 'ach'
          ? '/api/me/ach/checkout'
          : method === 'card'
            ? '/api/me/card/checkout'
            : '';
      if (!endpoint) {
        return alert('Selected payment method is not supported.');
      }

      $('#confirmFundBtn').disabled = true;
      $('#confirmFundBtn').textContent = `Redirecting to ${methodLabel}...`;

      try {

        const payload = { amount };

        const r = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();

        if (!j || j.success === false) {
          const errMsg = j?.message || `${methodLabel} payment could not be started. Please try again.`;
          if (fundStatusEl) { fundStatusEl.textContent = errMsg; fundStatusEl.style.display = 'block'; }
          showToast(errMsg, 'error');
          return;
        }

        // Hosted checkout flow (Card / Crypto / ACH)
        if (j.payment_url) {
          $('#addFundModal').style.display = 'none';
          showLinkToast(`${methodLabel} checkout page is ready. If you are not redirected automatically, click the link below.`, 'Open payment page', j.payment_url, 'success');
          window.location.href = j.payment_url;
          return;
        }

        // Non-hosted flow (fallback)
        $('#addFundModal').style.display = 'none';
        showToast(j.message || 'Payment started. Your balance will update after confirmation.');

        activate('billing');
        billingPage = 0;
        loadBillingHistory();
        loadProfile();
      } catch (e) {
        console.error('[addFunds]', e);
        const errMsg = 'Failed to start payment. Please try again.';
        if (fundStatusEl) { fundStatusEl.textContent = errMsg; fundStatusEl.style.display = 'block'; }
        alert(errMsg);
      } finally {
        $('#confirmFundBtn').disabled = false;
        $('#confirmFundBtn').textContent = 'Continue';
      }
    });
    window.__addFundsReady = true;

    // ========== Buy Numbers ==========
    let countriesData = [], regionsData = [], citiesData = [], didGroupsData = [], availableDidsData = [];
    let currentSkuId = null, currentDidGroupId = null;

    // Toggle toll-free mode - disable region/city when checked
    $('#buyTollfree').addEventListener('change', () => {
      const isTollfree = $('#buyTollfree').checked;
      $('#buyRegion').disabled = isTollfree;
      $('#buyCity').disabled = isTollfree;
      if (isTollfree) {
        $('#buyRegion').innerHTML = '<option value="">N/A for Toll-Free</option>';
        $('#buyCity').innerHTML = '<option value="">N/A for Toll-Free</option>';
      } else {
        $('#buyRegion').innerHTML = '<option value="">Select State/Region...</option>';
        $('#buyCity').innerHTML = '<option value="">Select City...</option>';
        // Reload regions if country selected
        if ($('#buyCountry').value) $('#buyCountry').dispatchEvent(new Event('change'));
      }
    });

    async function loadCountries() {
      try {
        const r = await fetch('/api/me/didww/countries');
        const j = await r.json();
        if (!j.success) return;
        countriesData = j.data || [];
        const sel = $('#buyCountry');
        sel.innerHTML = '<option value="">Select Country...</option>';
        countriesData.forEach(c => {
          const attrs = c.attributes || {};
          sel.innerHTML += `<option value="${c.id}">${escapeHtml(attrs.name || 'Unknown')}</option>`;
        });
      } catch (e) { console.error('[loadCountries]', e); }
    }

    $('#buyCountry').addEventListener('change', async () => {
      const countryId = $('#buyCountry').value;
      const isTollfree = $('#buyTollfree').checked;
      if (isTollfree) return; // Skip region loading for toll-free
      $('#buyRegion').innerHTML = '<option value="">Loading...</option>';
      $('#buyRegion').disabled = true;
      $('#buyCity').innerHTML = '<option value="">Select City...</option>';
      $('#buyCity').disabled = true;
      if (!countryId) return;
      try {
        const r = await fetch(`/api/me/didww/regions?country_id=${countryId}`);
        const j = await r.json();
        regionsData = j.data || [];
        const sel = $('#buyRegion');
        sel.innerHTML = '<option value="">Select State/Region...</option>';
        regionsData.forEach(rg => {
          const attrs = rg.attributes || {};
          sel.innerHTML += `<option value="${rg.id}">${escapeHtml(attrs.name || 'Unknown')}</option>`;
        });
        sel.disabled = false;
      } catch (e) { console.error('[loadRegions]', e); }
    });

    $('#buyRegion').addEventListener('change', async () => {
      const regionId = $('#buyRegion').value;
      $('#buyCity').innerHTML = '<option value="">Loading...</option>';
      $('#buyCity').disabled = true;
      if (!regionId) return;
      try {
        const r = await fetch(`/api/me/didww/cities?region_id=${regionId}`);
        const j = await r.json();
        citiesData = j.data || [];
        const sel = $('#buyCity');
        sel.innerHTML = '<option value="">Select City...</option>';
        citiesData.forEach(ct => {
          const attrs = ct.attributes || {};
          sel.innerHTML += `<option value="${ct.id}">${escapeHtml(attrs.name || 'Unknown')}</option>`;
        });
        sel.disabled = false;
      } catch (e) { console.error('[loadCities]', e); }
    });

    $('#searchDids').addEventListener('click', async () => {
      const cityId = $('#buyCity').value;
      const countryId = $('#buyCountry').value;
      const isTollfree = $('#buyTollfree').checked;
      
      if (!countryId) return alert('Please select a country');
      if (!isTollfree && !cityId && !countryId) return alert('Please select at least a country');
      
      $('#did-groups-info').textContent = 'Searching...';
      $('#available-dids-table').style.display = 'none';
      $('#available-dids-empty').textContent = '';
      
      try {
        // Get DID groups - for toll-free, use different endpoint
        let url;
        if (isTollfree) {
          url = `/api/me/didww/did-groups?country_id=${countryId}&tollfree=1`;
        } else {
          url = '/api/me/didww/did-groups?';
          if (cityId) url += `city_id=${cityId}`;
          else url += `country_id=${countryId}`;
        }
        
        const r = await fetch(url);
        const j = await r.json();
        didGroupsData = j.data || [];
        const included = j.included || [];
        
        if (didGroupsData.length === 0) {
          $('#did-groups-info').textContent = isTollfree ? 'No toll-free numbers available for this country.' : 'No numbers available for this location.';
          return;
        }
        
        // Find first DID group with available SKU
        const didGroup = didGroupsData[0];
        const attrs = didGroup.attributes || {};
        const skuRel = didGroup.relationships?.stock_keeping_units?.data || [];
        const sku = skuRel[0] ? included.find(i => i.type === 'stock_keeping_units' && i.id === skuRel[0].id) : null;
        
        if (!sku) {
          $('#did-groups-info').textContent = 'No pricing available for this location.';
          return;
        }
        
        currentSkuId = sku.id;
        currentDidGroupId = didGroup.id;
        const skuAttrs = sku.attributes || {};
        const typeLabel = isTollfree ? 'üÜì Toll-Free' : 'DID';
        const markupMonthly = isTollfree ? TOLLFREE_DID_MARKUP : LOCAL_DID_MARKUP;
        const markupSetup = 0;
        $('#did-groups-info').innerHTML = `<strong>${escapeHtml(attrs.name || typeLabel)}</strong> - Monthly: $${markupMonthly.toFixed(2)} | Setup: $${markupSetup.toFixed(2)}`;
        
        // Search available DIDs
        const didUrl = `/api/me/didww/available-dids?did_group_id=${didGroup.id}`;
        
        const dr = await fetch(didUrl);
        const dj = await dr.json();
        availableDidsData = dj.data || [];
        
        const tbody = $('#available-dids-table tbody');
        tbody.innerHTML = '';
        
        if (availableDidsData.length === 0) {
          $('#available-dids-empty').textContent = 'No specific numbers available. You can buy a random number from this group.';
          // Add option to buy random
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="4">Random ${isTollfree ? 'toll-free ' : ''}number from ${escapeHtml(attrs.name || 'this group')}</td><td><button class="buy-did" data-random="true">Buy Random</button></td>`;
          tbody.appendChild(tr);
          $('#available-dids-table').style.display = 'table';
        } else {
          availableDidsData.forEach(did => {
            const da = did.attributes || {};
            const tr = document.createElement('tr');
            const rawType = da.did_type || da.didType || da.number_type || da.numberType || '';
            const typeLabel = isTollfree ? 'Toll-Free' : (rawType ? String(rawType) : 'Local');
            tr.innerHTML = `<td>${escapeHtml(da.number || '')}</td><td>${escapeHtml(typeLabel)}</td><td>$${markupMonthly.toFixed(2)}</td><td>$${markupSetup.toFixed(2)}</td><td><button class=\"buy-did\" data-id=\"${did.id}\">Buy</button></td>`;
            tbody.appendChild(tr);
          });
          $('#available-dids-table').style.display = 'table';
        }
      } catch (e) {
        console.error('[searchDids]', e);
        $('#did-groups-info').textContent = 'Search failed. Please try again.';
      }
    });

    // Buy DID
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('buy-did')) {
        const btn = ev.target;
        const isRandom = btn.getAttribute('data-random') === 'true';
        const availableDidId = btn.getAttribute('data-id');
        
        if (!currentSkuId) return alert('No SKU selected');
        if (!confirm('Purchase this number? You will be charged.')) return;
        
        btn.disabled = true;
        btn.textContent = 'Buying...';
        
        try {
          const isTollfree = $('#buyTollfree').checked;
          const payload = { sku_id: currentSkuId, is_tollfree: isTollfree };
          if (isRandom) payload.did_group_id = currentDidGroupId;
          else payload.available_did_id = availableDidId;
          
          const r = await fetch('/api/me/didww/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const j = await r.json();
          if (!j.success) {
            btn.disabled = false;
            btn.textContent = 'Buy';
            const msg = j.message || 'Purchase failed';
            if (/insufficient balance/i.test(msg)) {
              // Show a cleaner message and surface the Add Funds modal
              showToast(msg, 'error');
              if (document.getElementById('addFundModal')) {
                document.getElementById('addFundModal').style.display = 'flex';
                if (document.getElementById('fundAmount')) {
                  document.getElementById('fundAmount').focus();
                }
              }
              return;
            }
            return alert(msg);
          }
          showToast('Number purchased successfully!');
          // Refresh search
          $('#searchDids').click();
        } catch (e) {
          console.error('[buyDid]', e);
          btn.disabled = false;
          btn.textContent = 'Buy';
          alert('Purchase failed');
        }
      }
    });

    // ========== My Numbers ==========
    let allTrunks = []; // Cache voice trunks for dropdown
    let allMyDids = []; // Cache all DIDs for pagination
    let myDidsIncluded = []; // Cache included data
    let mydidsPage = 0; const mydidsPageSize = 10;
    let mydidsSearchQuery = '';
    
    // My Numbers search handlers
    $('#mydidsSearchBtn').addEventListener('click', () => {
      mydidsSearchQuery = $('#mydidsSearch').value.trim();
      mydidsPage = 0;
      renderMyDidsPage();
    });
    
    $('#mydidsClearBtn').addEventListener('click', () => {
      mydidsSearchQuery = '';
      $('#mydidsSearch').value = '';
      mydidsPage = 0;
      renderMyDidsPage();
    });
    
    $('#mydidsSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        mydidsSearchQuery = $('#mydidsSearch').value.trim();
        mydidsPage = 0;
        renderMyDidsPage();
      }
    });
    
    async function loadMyDids() {
      try {
        // Fetch DIDs and voice trunks in parallel
        const [didsRes, trunksRes] = await Promise.all([
          fetch('/api/me/didww/dids'),
          fetch('/api/me/didww/trunks?kind=pstn')
        ]);
        const didsJson = await didsRes.json();
        const trunksJson = await trunksRes.json();
        
        if (!didsJson.success) {
          $('#mydids-empty').textContent = didsJson.message || 'Failed to load numbers';
          return;
        }
        
        allMyDids = didsJson.data || [];
        myDidsIncluded = didsJson.included || [];
        const included = myDidsIncluded;
        allTrunks = trunksJson.data || [];
        
        // Build lookups from included data
        const trunksMap = {};
        const citiesMap = {};
        const regionsMap = {};
        const countriesMap = {};
        const didGroupsMap = {};
        const skusMap = {};
        
        included.forEach(item => {
          if (item.type === 'voice_in_trunks') trunksMap[item.id] = item.attributes?.name || item.id;
          if (item.type === 'cities') citiesMap[item.id] = item.attributes?.name || '';
          if (item.type === 'regions') regionsMap[item.id] = item.attributes?.name || '';
          if (item.type === 'countries') countriesMap[item.id] = item.attributes?.name || '';
          if (item.type === 'did_groups') didGroupsMap[item.id] = item;
          if (item.type === 'stock_keeping_units') skusMap[item.id] = item.attributes || {};
        });
        
        // Also add from trunks API response
        allTrunks.forEach(t => {
          trunksMap[t.id] = t.attributes?.name || t.id;
        });
        
        const tbody = $('#mydids-table tbody');
        tbody.innerHTML = '';
        
        // Paginate
        const start = mydidsPage * mydidsPageSize;
        const paginated = allMyDids.slice(start, start + mydidsPageSize);
        const totalPages = Math.ceil(allMyDids.length / mydidsPageSize);
        
        if (allMyDids.length === 0) {
          $('#mydids-empty').textContent = 'No numbers yet. Go to "Buy Numbers" to purchase.';
          $('#mydids-empty').style.display = 'block';
          $('#mydids-table').style.display = 'none';
          $('#mydids-pager').style.display = 'none';
        } else {
          $('#mydids-empty').style.display = 'none';
          $('#mydids-table').style.display = 'table';
          $('#mydids-pager').style.display = 'flex';
          $('#mydidsPageInfo').textContent = `Page ${mydidsPage + 1} of ${totalPages}`;
          paginated.forEach(did => {
            const attrs = did.attributes || {};
            const trunkRel = did.relationships?.voice_in_trunk?.data;
            const currentTrunkId = trunkRel?.id || '';
            
            // Build location from did_group relationships or attributes
            let location = '';
            const didGroupRel = did.relationships?.did_group?.data;
            if (didGroupRel) {
              const dg = didGroupsMap[didGroupRel.id];
              if (dg) {
                const cityRel = dg.relationships?.city?.data;
                const regionRel = dg.relationships?.region?.data;
                const countryRel = dg.relationships?.country?.data;
                const parts = [];
                if (cityRel && citiesMap[cityRel.id]) parts.push(citiesMap[cityRel.id]);
                if (regionRel && regionsMap[regionRel.id]) parts.push(regionsMap[regionRel.id]);
                if (countryRel && countriesMap[countryRel.id]) parts.push(countriesMap[countryRel.id]);
                location = parts.join(', ');
              }
            }
            // Fallback to attributes if available
            if (!location) {
              location = [attrs.city_name, attrs.region_name, attrs.country_name].filter(Boolean).join(', ');
            }
            
            // Determine if this DID is toll-free for pricing
            const didType = String(attrs.did_type || '').toLowerCase();
            let isTollfreeDid = didType.includes('toll');
            if (!isTollfreeDid && didGroupRel) {
              const dg = didGroupsMap[didGroupRel.id];
              if (dg) {
                const name = String(dg.attributes?.name || '').toLowerCase();
                if (name.includes('toll')) isTollfreeDid = true;
              }
            }
            // Fallback: detect US/CA toll-free by prefix (800, 833, 844, 855, 866, 877, 888)
            if (!isTollfreeDid) {
              const rawNum = String(attrs.number || '').replace(/\D/g, '');
              if (rawNum) {
                const digits = rawNum.length > 11 ? rawNum.slice(-11) : rawNum;
                const npa = digits.startsWith('1') ? digits.slice(1,4) : digits.slice(0,3);
                const tollfreeNpas = ['800','833','844','855','866','877','888'];
                if (tollfreeNpas.includes(npa)) isTollfreeDid = true;
              }
            }
            
            // Use fixed markup prices instead of raw DIDWW prices
            const monthlyPrice = (isTollfreeDid ? TOLLFREE_DID_MARKUP : LOCAL_DID_MARKUP).toFixed(2);
            
            // Calculate status/time left
            let statusHtml = '';
            const billedTo = attrs.billing?.billed_to || attrs.expires_at;
            if (billedTo) {
              const expDate = new Date(billedTo);
              const now = new Date();
              const daysLeft = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));
              const statusColor = daysLeft > 7 ? '#22c55e' : (daysLeft > 0 ? '#f59e0b' : '#ef4444');
              statusHtml = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${statusColor};margin-right:6px"></span>${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}`;
            } else {
              statusHtml = '<span class="muted">-</span>';
            }
            
            // Build features icons
            let featuresHtml = '';
            const features = attrs.features || attrs.capabilities || {};
            // Check various feature flags
            if (features.voice || attrs.voice_in_enabled !== false) featuresHtml += '<span title="Voice" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üìû</span>';
            if (features.sms || attrs.sms_in_enabled) featuresHtml += '<span title="SMS" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üí¨</span>';
            if (features.fax || attrs.fax_in_enabled) featuresHtml += '<span title="Fax" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üì†</span>';
            if (!featuresHtml) featuresHtml = '<span title="Voice" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üìû</span>';
            
            // Build trunk dropdown options (PSTN call forwarding trunks only)
            let trunkOptions = '<option value="">-- None --</option>';
            const curMissing = currentTrunkId && !(allTrunks || []).some(t => String(t.id) === String(currentTrunkId));
            if (curMissing) {
              const curName = trunksMap[currentTrunkId] || currentTrunkId;
              trunkOptions += `<option value="${escapeHtml(currentTrunkId)}" selected>${escapeHtml(curName)} (unsupported)</option>`;
            }
            allTrunks.forEach(t => {
              const tName = t.attributes?.name || t.id;
              const selected = t.id === currentTrunkId ? 'selected' : '';
              trunkOptions += `<option value="${escapeHtml(t.id)}" ${selected}>${escapeHtml(tName)}</option>`;
            });
            
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(attrs.number || '')}</td>`+
                          `<td>${escapeHtml(location)}</td>`+
                          `<td>${statusHtml}</td>`+
                          `<td>${featuresHtml}</td>`+
                          `<td>$${monthlyPrice}</td>`+
                          `<td><select class="trunk-select" data-did-id="${escapeHtml(did.id)}" style="width:90px">${trunkOptions}</select></td>`+
                          `<td><button class="del-did btn--danger" data-id="${escapeHtml(did.id)}">Release</button></td>`;
            tbody.appendChild(tr);
          });
        }
      } catch (e) {
        console.error('[loadMyDids]', e);
        $('#mydids-empty').textContent = 'Failed to load numbers';
        $('#mydids-pager').style.display = 'none';
      }
    }
    
    // My Numbers pagination
    document.getElementById('mydidsPrev').addEventListener('click', () => { if (mydidsPage > 0) { mydidsPage--; renderMyDidsPage(); } });
    document.getElementById('mydidsNext').addEventListener('click', () => { 
      const filteredDids = getFilteredMyDids();
      if ((mydidsPage + 1) * mydidsPageSize < filteredDids.length) { mydidsPage++; renderMyDidsPage(); } 
    });
    
    function getFilteredMyDids() {
      if (!mydidsSearchQuery) return allMyDids;
      const q = mydidsSearchQuery.toLowerCase();
      return allMyDids.filter(did => {
        const attrs = did.attributes || {};
        const number = (attrs.number || '').toLowerCase();
        const location = [attrs.city_name, attrs.region_name, attrs.country_name].filter(Boolean).join(', ').toLowerCase();
        return number.includes(q) || location.includes(q);
      });
    }
    
    function renderMyDidsPage() {
      const included = myDidsIncluded;
      const trunksMap = {};
      const citiesMap = {};
      const regionsMap = {};
      const countriesMap = {};
      const didGroupsMap = {};
      const skusMap = {};
      
      included.forEach(item => {
        if (item.type === 'voice_in_trunks') trunksMap[item.id] = item.attributes?.name || item.id;
        if (item.type === 'cities') citiesMap[item.id] = item.attributes?.name || '';
        if (item.type === 'regions') regionsMap[item.id] = item.attributes?.name || '';
        if (item.type === 'countries') countriesMap[item.id] = item.attributes?.name || '';
        if (item.type === 'did_groups') didGroupsMap[item.id] = item;
        if (item.type === 'stock_keeping_units') skusMap[item.id] = item.attributes || {};
      });
      allTrunks.forEach(t => { trunksMap[t.id] = t.attributes?.name || t.id; });
      
      // Apply search filter
      const filteredDids = getFilteredMyDids();
      
      const tbody = $('#mydids-table tbody');
      tbody.innerHTML = '';
      const start = mydidsPage * mydidsPageSize;
      const paginated = filteredDids.slice(start, start + mydidsPageSize);
      const totalPages = Math.ceil(filteredDids.length / mydidsPageSize) || 1;
      
      if (filteredDids.length === 0) {
        $('#mydids-empty').textContent = mydidsSearchQuery ? 'No numbers match your search' : 'No numbers yet. Go to "Buy Numbers" to purchase.';
        $('#mydids-empty').style.display = 'block';
        $('#mydids-table').style.display = 'none';
        $('#mydids-pager').style.display = 'none';
        return;
      }
      
      $('#mydids-empty').style.display = 'none';
      $('#mydids-table').style.display = 'table';
      $('#mydids-pager').style.display = 'flex';
      $('#mydidsPageInfo').textContent = mydidsSearchQuery ? `${filteredDids.length} result(s)` : `Page ${mydidsPage + 1} of ${totalPages}`;
      
      paginated.forEach(did => {
        const attrs = did.attributes || {};
        const trunkRel = did.relationships?.voice_in_trunk?.data;
        const currentTrunkId = trunkRel?.id || '';
        let location = '';
        const didGroupRel = did.relationships?.did_group?.data;
        if (didGroupRel) {
          const dg = didGroupsMap[didGroupRel.id];
          if (dg) {
            const parts = [];
            const cityRel = dg.relationships?.city?.data;
            const regionRel = dg.relationships?.region?.data;
            const countryRel = dg.relationships?.country?.data;
            if (cityRel && citiesMap[cityRel.id]) parts.push(citiesMap[cityRel.id]);
            if (regionRel && regionsMap[regionRel.id]) parts.push(regionsMap[regionRel.id]);
            if (countryRel && countriesMap[countryRel.id]) parts.push(countriesMap[countryRel.id]);
            location = parts.join(', ');
          }
        }
        if (!location) location = [attrs.city_name, attrs.region_name, attrs.country_name].filter(Boolean).join(', ');

        // Determine if this DID is toll-free for pricing
        const didType = String(attrs.did_type || '').toLowerCase();
        let isTollfreeDid = didType.includes('toll');
        if (!isTollfreeDid && didGroupRel) {
          const dg = didGroupsMap[didGroupRel.id];
          if (dg) {
            const name = String(dg.attributes?.name || '').toLowerCase();
            if (name.includes('toll')) isTollfreeDid = true;
          }
        }
        // Fallback: detect US/CA toll-free by prefix (800, 833, 844, 855, 866, 877, 888)
        if (!isTollfreeDid) {
          const rawNum = String(attrs.number || '').replace(/\D/g, '');
          if (rawNum) {
            const digits = rawNum.length > 11 ? rawNum.slice(-11) : rawNum;
            const npa = digits.startsWith('1') ? digits.slice(1,4) : digits.slice(0,3);
            const tollfreeNpas = ['800','833','844','855','866','877','888'];
            if (tollfreeNpas.includes(npa)) isTollfreeDid = true;
          }
        }

        const monthlyPrice = (isTollfreeDid ? TOLLFREE_DID_MARKUP : LOCAL_DID_MARKUP).toFixed(2);
        let statusHtml = '';
        const billedTo = attrs.billing?.billed_to || attrs.expires_at;
        if (billedTo) {
          const daysLeft = Math.ceil((new Date(billedTo) - new Date()) / (1000 * 60 * 60 * 24));
          const statusColor = daysLeft > 7 ? '#22c55e' : (daysLeft > 0 ? '#f59e0b' : '#ef4444');
          statusHtml = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${statusColor};margin-right:6px"></span>${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}`;
        } else { statusHtml = '<span class="muted">-</span>'; }
        let featuresHtml = '<span title="Voice" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üìû</span>';
        if (attrs.sms_in_enabled) featuresHtml += '<span title="SMS" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üí¨</span>';
        if (attrs.fax_in_enabled) featuresHtml += '<span title="Fax" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üì†</span>';
        let trunkOptions = '<option value="">-- None --</option>';
        const curMissing = currentTrunkId && !(allTrunks || []).some(t => String(t.id) === String(currentTrunkId));
        if (curMissing) {
          const curName = trunksMap[currentTrunkId] || currentTrunkId;
          trunkOptions += `<option value="${escapeHtml(currentTrunkId)}" selected>${escapeHtml(curName)} (unsupported)</option>`;
        }
        allTrunks.forEach(t => {
          const selected = t.id === currentTrunkId ? 'selected' : '';
          trunkOptions += `<option value="${escapeHtml(t.id)}" ${selected}>${escapeHtml(t.attributes?.name || t.id)}</option>`;
        });
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(attrs.number || '')}</td><td>${escapeHtml(location)}</td><td>${statusHtml}</td><td>${featuresHtml}</td><td>$${monthlyPrice}</td><td><select class=\"trunk-select\" data-did-id=\"${escapeHtml(did.id)}\" style=\"width:90px\">${trunkOptions}</select></td><td><button class=\"del-did btn--danger\" data-id=\"${escapeHtml(did.id)}\">Release</button></td>`;
        tbody.appendChild(tr);
      });
    }

    // Update voice trunk assignment
    document.addEventListener('change', async (ev) => {
      if (ev.target && ev.target.classList.contains('trunk-select')) {
        const select = ev.target;
        const didId = select.getAttribute('data-did-id');
        const trunkId = select.value;
        
        select.disabled = true;
        try {
          const r = await fetch(`/api/me/didww/dids/${encodeURIComponent(didId)}/trunk`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trunk_id: trunkId || null })
          });
          const j = await r.json();
          if (!j.success) {
            alert(j.message || 'Failed to update trunk');
            loadMyDids();
            return;
          }
          showToast('Call forwarding updated!');
        } catch (e) {
          console.error('[updateTrunk]', e);
          alert('Failed to update trunk');
          loadMyDids();
        } finally {
          select.disabled = false;
        }
      }
    });

    // Delete DID
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('del-did')) {
        const id = ev.target.getAttribute('data-id');
        if (!confirm('Release this number? This action cannot be undone.')) return;
        try {
          const r = await fetch(`/api/me/didww/dids/${encodeURIComponent(id)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j.success) return alert(j.message || 'Release failed');
          showToast('Number released successfully!');
          loadMyDids();
        } catch (e) {
          console.error('[deleteDid]', e);
          alert('Failed to release number');
        }
      }
    });
  </script>
<!-- Start of LiveChat (www.livechat.com) code -->
<script>
    window.__lc = window.__lc || {};
    window.__lc.license = 18919976;
    window.__lc.integration_name = "manual_channels";
    window.__lc.product_name = "livechat";
    ;(function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice))
</script>
<noscript><a href="https://www.livechat.com/chat-with/18919976/" rel="nofollow">Chat with us</a>, powered by <a href="https://www.livechat.com/?welcome" rel="noopener nofollow" target="_blank">LiveChat</a></noscript>
<!-- End of LiveChat code -->

  </div>
</body>
</html>
